<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/general.css">
    <link rel="stylesheet" href="./css/infoPlate.css">
    <link rel="stylesheet" href="./css/comments.css">
    <link rel="stylesheet" href="./css/header.css">
    <link rel="stylesheet" href="./css/glass.css">
    <link rel="stylesheet" href="./css/direction.css">
</head>
<body>

<div class="glassPageWrapper df fdc">
    <div class="header-container">
        <div class="header-row top">
            <div class="search-container">
                <input type="text" placeholder="Search">
                <svg class="search-icon" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="7"/><line x1="16.65" y1="16.65" x2="21" y2="21"/>
                </svg>
            </div>
            <div class="role-container">
                <button class="role-icon" aria-label="User roles">
                    <svg class="icon-group" viewBox="0 0 24 24">
                        <circle cx="9" cy="7" r="4"/>
                        <circle cx="17" cy="7" r="4"/>
                        <path d="M5 21v-2a4 4 0 0 1 4-4h0a4 4 0 0 1 4 4v2"/>
                        <path d="M13 21v-2a4 4 0 0 1 4-4h0a4 4 0 0 1 4 4v2"/>
                    </svg>
                </button>
                <div class="role-toggle">
                    <button class="role-btn">Лікар</button>
                </div>
                <div class="role-toggle">
                    <button class="role-btn">Лаборант</button>
                </div>
            </div>
        </div>
        <div class="header-row bottom">
            <div>
                <div class="tabs">
                    <button class="tab">Направлення</button>
                    <button class="tab">Вирізка</button>
                    <button class="tab active">Скельця</button>
                    <button class="tab">Заключення</button>
                    <button class="tab">Дослідження</button>
                </div>
            </div>
            <div class="meta-info">
                <div>
                    <span id="searchCaseId"></span>
                    <button class="edit-btn" aria-label="Edit case">
                        <svg class="icon-edit" viewBox="0 0 24 24">
                            <path d="M4 20h16"/>
                            <path d="M14.7 5.3l4 4L9 19.3l-4-4L14.7 5.3z"/>
                        </svg>
                    </button>
                </div>
                <div id="userName"></div>
                <div id="userGender"></div>
                <div id="userAge"></div>
            </div>
        </div>
    </div>
    <div class="glassPageContent df jcsb">
        <div class="left">
            <div class="top borderRadiusLeft df aic jcsb">
                Поточні кейси
            </div>
            <div class="bottom">
                <div id="caseItems" class="caseItems">

                </div>
            </div>
        </div>
        <div class="middle df fdc">
            <div class="top df aic jcsb">
                <div>
                    Скельця
                </div>
            </div>
            <div class="bottom df ">
                <div class="directionWrapper">
                    <img class="directionImg" src="./assets/document.png" alt="doc">
                </div>
            </div>
        </div>
        <div class="right">
            <div style="height: 50%" class="df fdc">
                <div class="commentsWrapper df fdc" style="height: 100%">
                    <div class="commentsWrapperTop">
                        Патогістологічний висновок
                    </div>
                    <textarea id="casePathohistologicalConclusion"></textarea>
                    <button class="commentsWrapperButton">Зберегти</button>
                </div>
            </div>
            <div style="height: 50%" class="df fdc">
                <div class="commentsWrapper df fdc" style="height: 100%">
                    <div class="commentsWrapperTop">
                        Мікроопис
                    </div>
                    <textarea id="caseMicroDescription"></textarea>
                    <button class="commentsWrapperButton">Зберегти</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="./js/general.js"></script>
<script>
    let currentCase = null;

    const caseContentNODE = document.querySelector("#caseItems");
    const caseLabelNode = document.querySelector('#searchCaseId');
    const caseMicroDescriptionTextareaNODE = document.querySelector('#caseMicroDescription');
    const casePathohistologicalConclusionTextareaNODE = document.querySelector('#casePathohistologicalConclusion');

    const changeMicroDescription  = () => {
        caseMicroDescriptionTextareaNODE.nextElementSibling.addEventListener('click', () => {
            fetch(`${API_BASE_URL}/api/doctor/microdescription/${currentCase.id}`, {
                method: "PUT",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    microdescription: caseMicroDescriptionTextareaNODE.value.trim(),
                })
            })
                .then(res => res.json())
                .then(() => {
                    alert('Мікро опис успішно оновлений')
                })
        })
    }
    const changePathohistologicalConclusion  = () => {
        casePathohistologicalConclusionTextareaNODE.nextElementSibling.addEventListener('click', () => {
            fetch(`${API_BASE_URL}/api/doctor/pathohistological_conclusion/${currentCase.id}`, {
                method: "PUT",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    pathohistological_conclusion: casePathohistologicalConclusionTextareaNODE.value.trim(),
                })
            })
                .then(res => res.json())
                .then(() => {
                    alert('Патогістологічний висновок успішно оновлений')
                })
        })
    }

    const caseTemplate = (currentCase, isActive) => {
        const caseNewNODE = document.createElement('div');
        caseNewNODE.classList.add('caseItem', 'df', 'aic', 'jcsb', ...(isActive ? ['active'] : []));
        caseNewNODE.innerHTML = `
            <div>
                <div class="caseItemDate">27.03.2025</div>
                <div class="caseItemLabel">S25B01251</div>
            </div>
            <div class="caseItemSample df aic jcc">
                ${currentCase.bank_count}
            </div>
            <div>
                <div class="infoPlate cassette">
                    ${currentCase.cassette_count}
                </div>
            </div>
            <div>
                <div class="infoPlate glass">
                    ${currentCase.glass_count}
                </div>
            </div>
        `;

        caseNewNODE.addEventListener("click", () => {
            fetch(`${API_BASE_URL}/api/doctor/cases/${currentCase.id}/glass-details`, {
                method: "GET",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                },
            })
                .then(res => res.json())
                .then(caseData => {
                    const {single_case_for_glass_page} = caseData;
                    document.querySelector('.caseItem.active').classList.remove('active')
                    caseNewNODE.classList.add('active')

                    currentCase = single_case_for_glass_page

                    caseLabelNode.innerHTML = single_case_for_glass_page.case_code
                    caseMicroDescriptionTextareaNODE.value = single_case_for_glass_page.microdescription || ""
                    casePathohistologicalConclusionTextareaNODE.value = single_case_for_glass_page.pathohistological_conclusion || ""
                })
        });
        return caseNewNODE
    }

    const setAllCases = () => {
        fetch(`${API_BASE_URL}/api/doctor/patients/${PATIENT_COR_ID}/referral_page`, {
            method: "GET",
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
            },
        })
            .then(res => res.json())
            .then(userData => {
                document.querySelector('#userName').innerHTML = `${userData.surname || ""} ${userData.first_name || ""} ${userData.middle_name || ""}`;
                document.querySelector('#userGender').innerHTML = userData.sex === "M" ? "Чол" : "Жін";
                document.querySelector('#userAge').innerHTML = `${userData.age}р`;
                fetch(`${API_BASE_URL}/api/doctor/patients/${PATIENT_COR_ID}/glass-details`, {
                    method: "GET",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    },
                })
                    .then(res => res.json())
                    .then(cases => {

                        const {all_cases, first_case_details_for_glass} = cases;
                        all_cases.forEach((currentCase, index) => {
                            caseContentNODE.append(caseTemplate(currentCase, !index))
                        })

                        currentCase = first_case_details_for_glass;
                        caseLabelNode.innerHTML = first_case_details_for_glass.case_code
                        caseMicroDescriptionTextareaNODE.value = first_case_details_for_glass.microdescription || ""
                        casePathohistologicalConclusionTextareaNODE.value = first_case_details_for_glass.pathohistological_conclusion || ""
                    })
            })
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", (event) => {
        setAllCases()
        changeMicroDescription()
        changePathohistologicalConclusion()
        showTextareaButton('caseMicroDescription')
        showTextareaButton('casePathohistologicalConclusion')
    });
</script>


</body>
</html>
