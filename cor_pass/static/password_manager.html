

    <!DOCTYPE html>
    <html lang="en">
    <head>
        <link rel="icon" type="image/png" href="favicon.png">
        <link rel="stylesheet" type="text/css" href="/static/styles.css">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/static/modal.css">
        <title>User Records</title>
        <style>

             .delete-button {
              background: none;
               border: none;
              color: red;
              font-size: 24px;
               cursor: pointer;
              margin-top: 10px;
            }

            label {
                display: block;
                margin-bottom: 5px;
                color: #333;
            }
          
            .table-container {
                width: 100%;
                max-width: 1000px; /* Увеличиваем максимальную ширину таблицы */
                margin: 0 auto; /* Центрируем таблицу */
                padding: 0; /* Отступ вокруг таблицы */
            }

            table {
                width: 100%;
                border-collapse: collapse; /* Убираем лишние границы */
                font-size: 14px; /* Увеличенный шрифт для улучшения читабельности */
                margin-top: 15px;
            }

            th, td {
                border: 1px solid #ddd; /* Цвет границ */
                padding: 8px; /* Увеличенный отступ для удобства чтения */
                text-align: left;
            }

            th {
                background-color: #f2f2f2;
                font-weight: bold;
                font-size: 16px; /* Немного увеличиваем размер шрифта для заголовков */
            }

            tr:nth-child(even) {
                background-color: #f9f9f9; /* Лёгкий фон для чётных строк */
            }

            tr:hover {
                background-color: #f1f1f1; /* Подсветка строки при наведении */
                cursor: pointer; /* Указатель в виде руки при наведении */
            }

            /* Настраиваем ширину столбцов */
            th:nth-child(1), td:nth-child(1) { width: 8%; }
            th:nth-child(2), td:nth-child(2) { width: 8%; }
            th:nth-child(3), td:nth-child(3) { width: 25%; }
            th:nth-child(4), td:nth-child(4) { width: 25%; }
            th:nth-child(5), td:nth-child(5) { width: 34%; }

            /* Делаем таблицу визуально выше */
            tbody td {
                height: 20px; /* Увеличиваем высоту строк */
                vertical-align: middle; /* Выравниваем содержимое по вертикали */
            }
            /* Стили для прогресс-бара */
            .progress-bar {
              height: 5px;
              width: 0;
              margin-top: 5px;
              border-radius: 2px;
              transition: width 0.3s, background-color 0.3s;
            }

            .progress-bar.weak {
                 background-color: red;
                 width: 20%; /* Длина для слабого пароля */
            }

            .progress-bar.medium {
                 background-color: yellow;
                 width: 60%; /* Длина для среднего пароля */
             }

            .progress-bar.strong {
                 background-color: green;
                 width: 100%; /* Длина для сильного пароля */
             }
             .icon-text-container {
                 display: flex;
                 align-items: center;
             }

             .favicon {
                width: 12px; /* Ширина иконки */
                height: 12px; /* Высота иконки */
                margin-right: 5px; /* Отступ между иконкой и текстом */
             }


             .checkbox-group {
                display: flex;
                align-items: center;
             }

            .checkbox-group input[type="checkbox"] {
               margin-right: 5px;
             }

            .checkbox-group label {
               margin-right: 15px;
             }

             .recovery-display {
                display: flex;
                flex-direction: column;
                align-items: center;  /* Центрирование по горизонтали */
                justify-content: center;  /* Центрирование по вертикали */
                text-align: center; /* Центрирование текста */
                margin-top: 15px;
            }

              #recoveryCode {
               width: 100%;
               padding: 5px;
               margin-top: 5px;
               display: none;
              }

     
              #recoveryQRImage {
                max-width: 200px;
                margin-top: 10px;
                display: block; /* Убедитесь, что изображение ведет себя как блочный элемент */
                margin-left: auto; /* Центрирование изображения */
                margin-right: auto; /* Центрирование изображения */
              }

              #recoveryCodeDisplay {
               display: none;
              }


              .recovery-options {
                display: flex;
                justify-content: space-between; /* Равномерное распределение кнопок */
                 margin-top: 10px;
               }

             .recovery-btn {
                flex: 1;
                background-color: #007BFF;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin: 0 5px; /* Отступ между кнопками */
                text-align: center;
              }

                .recovery-btn:hover {
                    background-color: #0056b3;
                }

                            
                /* Стили для рамки вокруг генератора паролей */
                .password-generator {
                    border: 1px solid #ccc;
                    padding: 10px;
                    margin-top: 20px;
                    margin-bottom: 20px;
                    border-radius: 5px;
                }

                /* Уменьшение шрифта для чекбоксов генератора паролей */
                .password-generator label {
                    font-size: 0.9em;
                }

                /* Изменение стиля для заголовка "Настройки генератора паролей" */
                .password-generator h3 {
                    font-size: 1em;
                    margin-bottom: 10px;
                }

                /* Уменьшение интервала между элементами */
                .checkbox-group input[type="checkbox"],
                .checkbox-group label {
                    margin-right: 10px;
                }  


        </style>
    </head>
    <body>
        <div class="container" Style=" width: 350px;">
            <button class="link-button" onclick="goBack()" data-translate="back-link-text"><<<назад<<<</button>
                <!-- Кнопка настроек -->              
                    <svg class="icon-button"id="openSettings" width="30" height="30" viewBox="0 0 30 30" 
                        fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_3222_19950)">
                        <path d="M15.0012 21.1588C13.7604 21.1605 12.5452 20.8036 11.5091 20.1309C10.4727 
                        19.4581 9.66087 18.4984 9.17995 17.3705C8.69892 16.2424 8.57175 14.9993 8.81563 
                        13.7993C9.05947 12.5995 9.66249 11.5005 10.5446 10.6399C11.4264 9.77953 12.5476 
                        9.19591 13.765 8.95934C14.9823 8.72279 16.2445 8.84314 17.3929 9.30611C18.5414 
                        9.76915 19.5269 10.5552 20.2221 11.5685C20.9172 12.5816 21.2899 13.7754 21.2902 
                        14.9987L15.0012 21.1588ZM15.0012 21.1588C15.8244 21.1586 16.6399 21.0005 17.4016 
                        20.6928C18.1636 20.385 18.8573 19.9332 19.4426 19.3623C20.0279 18.7913 20.4932 
                        18.1121 20.8107 17.3631C21.128 16.6145 21.2912 15.8114 21.2902 15L15 21.1588C15.0004 
                        21.1588 15.0008 21.1588 15.0012 21.1588ZM25.5573 16.3462C25.5149 16.6648 25.6457 
                        16.9819 25.9004 17.178L29.0134 19.5746L26.064 24.5578L22.328 23.0905C22.038 22.9766 
                        21.7098 23.0208 21.4603 23.2072C20.7244 23.757 19.9175 24.2115 19.06 24.5589C18.7637 
                        24.6789 18.5533 24.9471 18.5072 25.2634L17.9488 29.1H12.0211L11.4627 25.2634C11.4168 
                        24.9478 11.2073 24.6801 10.912 24.5597C10.0541 24.2098 9.24625 23.7547 8.50788 
                        23.2059C8.25851 23.0205 7.93117 22.9769 7.64197 23.0905L3.90596 24.5578L0.956733 
                        19.5751L4.0897 17.1798C4.34593 16.9839 4.47775 16.6659 4.43521 16.3462C4.37581 
                        15.8996 4.34332 15.4502 4.33789 15C4.34332 14.5498 4.37581 14.1004 4.43521 
                        13.6538C4.47775 13.3341 4.34593 13.0161 4.0897 12.8202L0.956734 10.4249L3.90604 
                        5.44203L7.65811 6.90994C7.94781 7.02328 8.27551 6.97897 8.52471 6.79278C9.26059 
                        6.24295 10.0674 5.78847 10.925 5.44113C11.2213 5.32112 11.4317 5.05294 11.4777 
                        4.73659L12.0362 0.900036H17.9789L18.5373 4.73659C18.5832 5.05216 18.7927 5.31986 
                        19.088 5.4403C19.9459 5.79022 20.7537 6.24528 21.4921 6.79411C21.7415 6.97947 
                        22.0688 7.02309 22.358 6.9095L26.094 5.44216L29.0432 10.4248L25.9036 12.8196C25.6468 
                        13.0154 25.5147 13.3338 25.5573 13.6538C25.6167 14.1004 25.6492 14.5498 25.6546 
                        15C25.6492 15.4502 25.6167 15.8996 25.5573 16.3462ZM12.0416 29.2405L12.0416 
                        29.2404L12.0416 29.2405ZM17.9584 0.759136L17.9584 0.759546L17.9584 0.759136ZM11.9027 
                        30H18.0672L11.151 29.3701C11.1765 29.5461 11.2668 29.707 11.4051 29.8229C11.5435 
                        29.9388 11.7203 30.0017 11.9027 30Z"
                        stroke="#5F41B2" 
                        stroke-width="1.8" 
                        stroke-linecap="round" 
                        stroke-linejoin="round"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_3222_19950">
                        <rect width="30" height="30" fill="white"/>
                        </clipPath>
                        </defs>
                    </svg>
                    <h1>Учётные записи</h1>
                    <div id="noRecordsMessage" class="empty-state" style="display: flex; align-items: center; justify-content: center; gap: 1px; white-space: normal; color: #7f69bd; font-size: 14px;">
                        <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50.416 52.4998C63.0723 52.4998 73.3327 42.2394 73.3327 29.5832C73.3327 16.9269 
                            63.0723 6.6665 50.416 6.6665C37.7598 6.6665 27.4993 16.9269 27.4993 29.5832C27.4993 
                            32.0181 27.877 34.3748 28.5801 36.5754L7.57747 57.578C6.99154 58.1639 6.66602 58.9582 
                            6.66602 59.7915V70.2082C6.66602 71.9399 8.05924 73.3332 9.79102 73.3332H20.2077C21.9395 
                            73.3332 23.3327 71.9399 23.3327 70.2082V64.9998H28.541C30.2728 64.9998 31.666 63.6066 
                            31.666 61.8748V56.6665H36.8743C37.7077 56.6665 38.502 56.341 39.0879 55.755L43.4238 
                            51.4191C45.6243 52.1222 47.9811 52.4998 50.416 52.4998ZM55.6243 19.1665C57.0057 19.1665 
                            58.3304 19.7152 59.3072 20.692C60.2839 21.6687 60.8327 22.9935 60.8327 24.3748C60.8327 
                            25.7562 60.2839 27.0809 59.3072 28.0577C58.3304 29.0344 57.0057 29.5832 55.6243 
                            29.5832C54.243 29.5832 52.9183 29.0344 51.9415 28.0577C50.9647 27.0809 50.416 25.7562 
                            50.416 24.3748C50.416 22.9935 50.9647 21.6687 51.9415 20.692C52.9183 19.7152 54.243 
                            19.1665 55.6243 19.1665Z" fill="#D2CAE8"/>
                            </svg>
                            
                        <p>Вы еще не добавили вашу первую запись. Нажмите выше кнопку Создать, для добавления записи.</p>
                    </div>  
                <button class="plus-button" id="openModal">+ CОЗДАТЬ </button>
            <div class="table-container">
                <table id="recordsTable">
                    <thead>
                        <tr>
                           <th> № </th>
                           <th> ⭐ </th>
                           <th>Запись</th>
                           <th>Имя пользователя</th>
                           <th>Сайт</th>
                          

                        </tr>
                    </thead>
                    <tbody>
                        <!-- Здесь будут отображаться данные пользователей -->
                    </tbody>
                </table>
            </div>
        </div>
    
        <!-- Модальное окно добавления записи-->
        <div id="myModal" class="modal" style="display: none;">
            <div class="modal-header">
                <h1>Добавление записи</h1>
                <div class="modal-buttons">
            <button class="modal-button" data-action="minimize" id="minimizeEditModal">🗕</button>
            <button class="modal-button"data-action="maximize" id="maximizeEditModal">🗖</button>
            <button class="modal-button close" data-action="close" id="closeEditModal">✖</button>
                </div>
            </div>
            <div class="modal-content">
                <div class="form-container">
                    <form id="createRecordForm">
                        <div class="input-wrapper">
                            <label for="record_name">Record Name</label>
                            <input type="text" name="record_name" placeholder="Record Name" required>
                        </div>
                        <div class="input-wrapper">
                            <label for="website">Website</label>
                            <input type="text" name="website" placeholder="Website" required>
                        </div>
                        <div class="input-wrapper">
                            <label for="username">Username</label>
                            <input type="text" name="username" placeholder="Username" required>
                        </div>
                        <div class="input-wrapper">
                            <label for="password">Password</label>
                            <input type="password" id="generatedPassword" name="password" placeholder="Password" required>
                            <button type="button" id="generatePasswordBtnCreate">Сгенерировать пароль</button>
                            <span id="togglePasswordGen" style="cursor: pointer;">👁️</span>
                            <div id="passwordStrength" class="progress-bar"></div>
                        </div>
                        <div class="input-wrapper">
                            <label for="notes">Notes</label>
                            <input type="text" name="notes" placeholder="Notes">
                        </div>
                        <input type="submit" value="Create New Record" class="registration-button">
                    </form>
                </div>
            </div>
        </div>
 <!-- Модальное окно для редактирования -->
<div id="editModal" class="modal" style="display: none;">
    <div class="modal-header">
        <h1>Редактировать запись</h1>
        <div class="modal-buttons">
            <button class="modal-button" data-action="minimize" id="minimizeEditModal">🗕</button>
            <button class="modal-button"data-action="maximize" id="maximizeEditModal">🗖</button>
            <button class="modal-button close" data-action="close" id="closeEditModal">✖</button>
        </div>
    </div>
    <div class="modal-content">
        <div class="form-container">
            <form id="editRecordForm">
                <div class="input-wrapper">
                    <label for="edit_record_name">Record Name</label>
                    <input type="text" id="edit_record_name" name="record_name" placeholder="Record Name" required>
                </div>
                <div class="input-wrapper">
                    <label for="edit_website">Website</label>
                    <input type="text" id="edit_website" name="website" placeholder="Website" required>
                </div>
                <div class="input-wrapper">
                    <label for="edit_username">Username</label>
                    <input type="text" id="edit_username" name="username" placeholder="Username" required>
                </div>
                <div class="input-wrapper">
                    <label for="edit_password">Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="edit_password" name="password" placeholder="Password" required>
                        <button type="button" id="generatePasswordBtnEdit">Сгенерировать пароль</button>
                        <span id="togglePassword" class="eye-icon">👁️</span><br>
                        <div id="passwordStrength" class="progress-bar"></div>
                    </div>
                </div>
                <div class="input-wrapper">
                    <label for="edit_notes">Notes</label>
                    <input type="text" id="edit_notes" name="notes" placeholder="Notes">
                </div>
                <input type="submit" value="Save Changes" class="registration-button">
            </form>
            <button type="button" id="deleteRecordButton" class="delete-button">&#128465;</button> <!-- Иконка корзины -->
        </div>
    </div>
</div>

<!-- Модальное окно настроек -->
<div id="settingsModal" class="modal" style="display: none;">
    <div class="modal-header">
        <h1>Настройки</h1>
        <div class="modal-buttons">
            <button class="modal-button" data-action="minimize" id="minimizeEditModal">🗕</button>
            <button class="modal-button"data-action="maximize" id="maximizeEditModal">🗖</button>
            <button class="modal-button close" data-action="close" id="closeEditModal">✖</button>
        </div>
    </div>
    <div class="modal-content">
        <!-- Чекбокс для выбора места хранения данных аккаунтов -->
        <div class="input-wrapper">
            <label for="storageLocation">Хранить данные аккаунтов:</label>
            <div class="checkbox-group">
                <input type="checkbox" id="storeOnDevice" name="storageLocation" value="device">
                <label for="storeOnDevice">На устройстве</label>

                <input type="checkbox" id="storeOnServer" name="storageLocation" value="server">
                <label for="storeOnServer">На сервере</label>
            </div>
        </div>

        <!-- Настройки генератора паролей -->
        <div class="input-wrapper password-generator">
            <h3>Настройки генератора паролей</h3>
            <div class="checkbox-group">
                <!-- Выбор длины пароля -->
                <label for="passwordLength">Длина пароля:</label>
                <input type="number" id="passwordLength" name="passwordLength" min="8" max="20" step="1" value="8">

                <input type="checkbox" id="includeLowercase" name="passwordOptions" value="lowercase" checked>
                <label for="includeLowercase">Маленькие буквы (a-z)</label>

                <input type="checkbox" id="includeUppercase" name="passwordOptions" value="uppercase">
                <label for="includeUppercase">Большие буквы (A-Z)</label>

                <input type="checkbox" id="includeNumbers" name="passwordOptions" value="numbers">
                <label for="includeNumbers">Цифры (0-9)</label>

                <input type="checkbox" id="includeSymbols" name="passwordOptions" value="symbols">
                <label for="includeSymbols">Спецсимволы (!@#$%)</label>
            </div>
        </div>

        <!-- Поле для смены логина -->
        <div class="input-wrapper">
            <label for="newLogin">Сменить логин</label>
            <input type="text" id="newLogin" name="newLogin" placeholder="Введите новый логин">
        </div>

        <!-- Поле для смены пароля -->
        <div class="input-wrapper">
            <label for="newPassword">Сменить пароль</label>
            <input type="password" id="newPassword" name="newPassword" placeholder="Введите новый пароль">
        </div>

        <!-- Поле для подтверждения нового пароля -->
        <div class="input-wrapper">
            <label for="confirmPassword">Подтвердите новый пароль</label>
            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Введите новый пароль повторно">
        </div>

        <div class="recovery-options">
            <button id="getRecoveryQR" class="recovery-btn">Получить QR код восстановления</button>
            <button id="getRecoveryFile" class="recovery-btn">Получить файл восстановления</button>
            <button id="getRecoverySuperPassword" class="recovery-btn">Получить супер-пароль восстановления</button>
        </div>

        <!-- Поле для отображения кода восстановления -->
        <div id="recoveryCodeDisplay" class="recovery-display">
            <label for="recoveryCode">Ваш код восстановления:</label>
            <input type="text" id="recoveryCode" readonly>
        </div>

        <!-- Место для отображения QR кода восстановления -->
        <div id="recoveryQRDisplay" class="recovery-display" style="display: none;">
            <label for="recoveryQR">QR код восстановления:</label>
            <img id="recoveryQRImage" alt="QR код восстановления" />
            <button id="downloadQR" class="recovery-btn">Скачать QR код</button>
        </div>

        <input type="submit" id="SaveSettingsButton" value="Сохранить настройки" class="registration-button">
    </div>
</div>




           <script src="translation.js"></script>  
           <script src="general_fun.js"></script> 
           <script> function goBack() { window.history.back();  } </script>

           <script>
            // Открытие и закрытие модального окна настроек
            document.getElementById('openSettings').addEventListener('click', function () {
                document.getElementById('settingsModal').style.display = 'block';
            });
    
    
            window.onclick = function (event) {
                if (event.target === document.getElementById('settingsModal')) {
                    document.getElementById('settingsModal').style.display = 'none';
                }
            };
        </script>





        <script>
            document.getElementById('togglePassword').addEventListener('click', function () {
    const passwordField = document.getElementById('edit_password');
    const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordField.setAttribute('type', type);
    this.textContent = type === 'password' ? '👁️' : '🙈'; // Изменение иконки при переключении
                                                         });


            document.getElementById('togglePasswordGen').addEventListener('click', function() {
    const passwordField = document.getElementById('generatedPassword');
    const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordField.setAttribute('type', type);
    this.textContent = type === 'password' ? '👁️' : '🙈'; // Меняем эмодзи
});
   document.addEventListener("DOMContentLoaded", function() {
    makeModalDraggable('settingsModal');
    makeModalDraggable('editModal');
    makeModalDraggable('myModal');

    });
  
     document.addEventListener('DOMContentLoaded', function () {
       

    const passwordInput = document.getElementById('edit_password');
    const progressBar = document.getElementById('passwordStrength');
    const editModal = document.getElementById('editModal');
    const closeEditModalBtn = document.getElementById('closeEditModal');
    const editForm = document.getElementById('editRecordForm');
    let currentRecordId = null;

   





    function updateProgressBar() {
        const password = passwordInput.value;
        const length = password.length;
        let strengthClass = '';

        if (length >= 16 && /[A-Za-z]/.test(password) && /[0-9]/.test(password)) {
            strengthClass = 'strong';
        } else if (length >= 10 && /[A-Za-z]/.test(password) && /[0-9]/.test(password)) {
            strengthClass = 'medium';
        } else if (length > 0 && length < 10 && (/^[A-Za-z]/.test(password) || /[0-9]/.test(password))) {
            strengthClass = 'weak';
        } else {
            strengthClass = 'weak'; // Optional: for an empty or invalid state
        }

        progressBar.className = `progress-bar ${strengthClass}`;
    }

    // Обновление прогресс-бара при вводе пароля
    passwordInput.addEventListener('input', updateProgressBar);

    // Функция для открытия модального окна
    function openEditModal(record) {
        editForm.elements['record_name'].value = record.record_name;
        editForm.elements['website'].value = record.website;
        editForm.elements['username'].value = record.username;
        editForm.elements['password'].value = record.password;
        editForm.elements['notes'].value = record.notes;
        currentRecordId = record.record_id; // Сохраняем ID записи

        // Обновляем прогресс-бар с текущим значением пароля
        updateProgressBar();

        // Открываем модальное окно
        editModal.style.display = 'block';
    }

    // Закрытие модального окна
    closeEditModalBtn.onclick = () => {
        editModal.style.display = 'none';
    };

    // Закрытие модального окна, если кликнули вне его
    window.onclick = (event) => {
        if (event.target === editModal) {
            editModal.style.display = 'none';
        }
    };

                // Обработчик кликов по строкам таблицы
                document.getElementById('recordsTable').addEventListener('click', async (event) => {
                const target = event.target;
                const row = target.closest('tr');
                if (!row) return;

                // Определяем индекс колонки и ID записи
                const columnIndex = target.closest('td')?.cellIndex;
                const recordId = row.dataset.recordId;

                // Обработка клика по колонке Website
                if (columnIndex === 4 && target.tagName === 'A') {
                    console.log('Клик по ссылке Website:', target.href);
                    return; // Выполняем только переход по ссылке
                }

                // Обработка клика по колонке Notes
                if (columnIndex === 1) {
                    console.log('Клик по колонке Notes');
                    return; // Выполняем только свой функционал для Notes
                }

                // Остальные клики обрабатываются для открытия модального окна
                if (!recordId) return;

                try {
                    console.log('Полученные данные записи:', recordId);
                    const response = await fetch(`/api/records/${recordId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Ошибка сети: ' + response.statusText);
                    }

                    const record = await response.json();
                    console.log('Полученные данные записи:', record);
                    openEditModal(record); // Открываем модальное окно с данными записи
                } catch (error) {
                    console.error('Ошибка при получении записи:', error);
                }
            });


    // Обработчик для кнопки удаления
    document.getElementById('deleteRecordButton').addEventListener('click', async () => {
        if (confirm('Are you sure you want to delete this record?')) {
            try {
                const response = await fetch(`/api/records/${currentRecordId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }

                alert('Record deleted successfully');
                editModal.style.display = 'none'; // Закрываем модальное окно
                loadTableData(); // Обновляем данные в таблице после удаления записи
            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
            }
        }
        checkRecords();
    });

    async function loadTableData() {
        try {
            const response = await fetch('/api/records/all', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            });

            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }

            const records = await response.json();
            // Логика для отображения записей в таблице
            populateTable(records);
        } catch (error) {
            console.error('There was a problem with the fetch operation:', error);
        }
    }

    // Закрытие модального окна
    document.getElementById('closeEditModal').addEventListener('click', function() {
        document.getElementById('editModal').style.display = 'none';
    });

/*------------------------------------------------------------------------------*/










    // Обрабатываем отправку формы для сохранения изменений
    editForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const formData = new FormData(editForm);
        const data = Object.fromEntries(formData.entries());

        console.log('Updating record with ID:', currentRecordId); // Проверка значения recordId перед отправкой
        console.log('Data to be sent:', data);

        try {
            const response = await fetch(`/api/records/${currentRecordId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorMessage = await response.text();
                throw new Error('Network response was not ok: ' + response.statusText + ', ' + errorMessage);
            }

            const updatedRecord = await response.json();
            alert('Изменения сохранены');
            editModal.style.display = 'none'; // Закрываем модальное окно
            fetchRecords(); // Обновляем таблицу после изменения записи
        } catch (error) {
            console.error('Ошибка при сохранении изменений:', error);
            alert('Ошибка при сохранении изменений');
        }
    });

      // Вызов функции для получения настроек при загрузке страницы
   
      fetchSettings();
    // Initial fetch to populate the table
    fetchRecords();
});

          
            // Получаем элементы модального окна
            const modal = document.getElementById('myModal');
            const openModalBtn = document.getElementById('openModal');
            const closeModalBtn = document.getElementById('closeModal');
    
            // Открываем модальное окно
            openModalBtn.addEventListener('click', () => {
                modal.style.display = 'block';
            });
   
            async function fetchRecords(skip = 0, limit = 10) {
    console.log('Starting fetchRecords function');

    // Проверка токена в URL и сохранение в localStorage, если присутствует
    const urlParams = new URLSearchParams(window.location.search);
    const tokenFromUrl = urlParams.get('access_token');
    if (tokenFromUrl) {
        localStorage.setItem('access_token', tokenFromUrl);
    }

    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
        console.error('Access token not found');
        return;
    }

    try {
        console.log(`Making GET request to /api/records/all?skip=${skip}&limit=${limit}`);

        // Формирование URL с параметрами
        const url = `/api/records/all?skip=${skip}&limit=${limit}`;
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`,
            },
        });

        if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
        }

        // Получение данных
        const records = await response.json();
        console.log('Records fetched:', records);

        // Вызов функции заполнения таблицы
        populateTable(records);
    } catch (error) {
        console.error('There was a problem with the fetch operation:', error);
    }
}


function populateTable(records) {
    const tbody = document.querySelector('#recordsTable tbody');
    tbody.innerHTML = ''; // Очистить таблицу перед заполнением

    // Сортировка записей:
    // - Сначала по убыванию `is_favorite` (true = 1, false = 0, поэтому true будет выше)
    // - Затем по возрастанию `record_id`
    const sortedRecords = records.sort((a, b) => {
        if (b.is_favorite !== a.is_favorite) {
            return b.is_favorite - a.is_favorite; // Сортировка по is_favorite
        }
        return a.record_id - b.record_id; // Сортировка по record_id
    });

    // Генерация строк таблицы из отсортированных записей
    sortedRecords.forEach(record => {
        const row = document.createElement('tr');
        row.dataset.recordId = record.record_id; // Добавляем data-record-id

        const websiteUrl = record.website.startsWith('http') ? record.website : `http://${record.website}`;
        const faviconUrl = `${websiteUrl}/favicon.ico`; // URL для фавикона

        row.innerHTML = `
            <td>${record.record_id}</td>
            <td>
                <div class="favorite-column" data-record-id="${record.record_id}">
                    <span class="star ${record.is_favorite ? 'favorite' : ''}">
                        ${record.is_favorite ? '⭐' : '☆'}
                    </span>
                </div>
            </td>
            <td>${record.record_name}</td>
            <td>${record.username}</td>
            <td>
                <div class="icon-text-container">
                    <img src="${faviconUrl}" class="favicon" onerror="this.style.display='none'" />
                    <a href="${websiteUrl}" target="_blank" rel="noopener noreferrer">${record.website}</a>
                </div>
            </td>
        `;

        tbody.appendChild(row);
    });


     
    // Добавляем обработчики кликов после создания строк
    document.querySelectorAll('.favorite-column').forEach(column => {
        column.addEventListener('click', event => {
            const recordId = column.dataset.recordId;
            const starElement = column.querySelector('.star');
            const currentStatus = starElement.classList.contains('favorite');
            toggleFavorite(recordId, currentStatus);
        });
    });
}

 // Функция для получения настроек с бэкенда
    async function fetchSettings() {
    const token = localStorage.getItem('access_token');

      try {
        console.log('Отправка запроса на сервер для получения настроек');
        const response = await fetch('/api/user/get_settings', {
            method: 'GET',
            headers: {
                     'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token') }
        });

        console.log('Ответ от сервера получен, статус ответа:', response.status);
        if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
        }

        const data = await response.json();
        console.log('Настройки, полученные с сервера:', data);
        // Установка чекбоксов в зависимости от полученных настроек
        document.getElementById('storeOnDevice').checked = data.local_password_storage;
        document.getElementById('storeOnServer').checked = data.cloud_password_storage;

    } catch (error) { console.error('Ошибка при получении настроек:', error); }
 }

  



// Обработчик для отображения QR кода при нажатии на кнопку "Получить QR код восстановления"

document.getElementById('getRecoveryQR').addEventListener('click', async function() {
    try {
        const response = await fetch('/api/user/get_recovery_qr_code', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });

        if (response.ok) {
            const blob = await response.blob(); // Получаем бинарные данные
            const qrCodeUrl = URL.createObjectURL(blob); // Создаем временный URL

            // Устанавливаем src для изображения QR-кода
            document.getElementById('recoveryQRImage').src = qrCodeUrl;

            // Отображаем блок с QR-кодом
            document.getElementById('recoveryQRDisplay').style.display = 'block';

            // Сохраняем URL для загрузки
            document.getElementById('downloadQR').setAttribute('data-url', qrCodeUrl);
        } else {
            console.error('Ошибка получения QR-кода');
        }
    } catch (error) {
        console.error('Ошибка:', error);
    }
});

document.getElementById('getRecoveryFile').addEventListener('click', async function() {
    try {
        const response = await fetch('/api/user/get_recovery_file', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');

            /* Скрытие неактуальных элементов */
            document.getElementById('recoveryCode').style.display = 'none';
            document.getElementById('recoveryCodeDisplay').style.display = 'none';
            const qrDisplay = document.getElementById("recoveryQRDisplay");
            qrDisplay.style.display = "none";
            /*-------------------------------------------------------*/

            a.href = url;
            a.download = 'recovery_key.bin';
            a.click();
        } else {
            console.error('Ошибка получения файла восстановления');
        }
    } catch (error) {
        console.error('Ошибка:', error);
    }
});

document.getElementById('getRecoverySuperPassword').addEventListener('click', async function() {
    try {
        const response = await fetch('/api/user/get_recovery_code', {
            method: 'GET',
            headers: {
                     'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token') }
        });
        if (response.ok) {
            const data = await response.json();
            
            const qrDisplay = document.getElementById("recoveryQRDisplay");
            qrDisplay.style.display = "none";

          
            document.getElementById('recoveryCode').value = data['users recovery code'];
            document.getElementById('recoveryCode').style.display = 'block';
            document.getElementById('recoveryCodeDisplay').style.display = 'block';
        } else {
            console.error('Ошибка получения супер пароля');
        }
    } catch (error) {
        console.error('Ошибка:', error);
    }
});





/*       ------------------------------------------------------  */

document.getElementById('SaveSettingsButton').addEventListener('click', async function() {
    console.log('Кнопка "Сохранить настройки" нажата');
    // Получаем значения чекбоксов
    const localPasswordStorage = document.getElementById('storeOnDevice').checked;
    const cloudPasswordStorage = document.getElementById('storeOnServer').checked;

    console.log('Полученные значения настроек:', { localPasswordStorage, cloudPasswordStorage });

    // Формируем данные для отправки на сервер
    const settingsData = {
        local_password_storage: localPasswordStorage,
        cloud_password_storage: cloudPasswordStorage
    };

    try {
        // Отправляем запрос на сервер
        const response = await fetch('/api/user/settings/password_storage', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            body: JSON.stringify(settingsData)
        });

        console.log('Ответ от сервера на запрос изменения настроек:', response.status);

        if (!response.ok) {
            throw new Error('Ошибка сети: ' + response.statusText);
        }

        const result = await response.json();
        console.log('Сервер успешно обновил настройки:', result.message);

        // Можно добавить уведомление для пользователя о том, что настройки успешно сохранены

    } catch (error) {
        console.error('Ошибка при сохранении настроек:', error);
    }
});


/*-------------------------------------------------------------- */
            document.getElementById('createRecordForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                console.log('Form submitted');
    
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData.entries());
                console.log('Form data:', data);
    
                const urlParams = new URLSearchParams(window.location.search);
                let Item = urlParams.get('access_token');
                localStorage.setItem('access_token', Item);
                console.log(localStorage.getItem(Item));
                console.log(Item);
    
                try {
                    console.log('Making POST request to /api/records with data:', data);
                    const response = await fetch('/api/records/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        },
                        body: JSON.stringify(data)
                    });
    
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
    
                    const newRecord = await response.json();
                    console.log('New record created:', newRecord);
                    fetchRecords(); // Обновляем таблицу после добавления записи
                    event.target.reset(); // Сбрасываем форму
                    console.log('Form reset');
                } catch (error) {
                    console.error('There was a problem with the fetch operation:', error);
                }
                
            });
    
            // Initial fetch to populate the table
            fetchRecords();
        </script>


        <script>
                 // Функция для предотвращения отключения всех чекбоксов
             const checkboxes = document.querySelectorAll('input[name="passwordOptions"]');
    
             checkboxes.forEach(checkbox => {
              checkbox.addEventListener('change', function() {
                       // Собираем все включённые чекбоксы
               const checkedCheckboxes = [...checkboxes].filter(checkbox => checkbox.checked);
    
               // Если чекбокс был отключен, и это последний включённый элемент, то блокируем отключение
                    if (checkedCheckboxes.length === 0) {
                        this.checked = true; // Возвращаем состояние обратно
                        alert('Невозможно отключить все параметры. Должен быть выбран хотя бы один.');
                    }
                });
              });
        </script>

            <script>
                // Получаем элемент поля длины пароля
                const passwordLengthInput = document.getElementById('passwordLength');

                // Блокируем ввод с клавиатуры
                passwordLengthInput.addEventListener('keydown', function(event) {
                    // Разрешаем только клавиши управления, такие как стрелки, Tab, Enter
                    if (event.key !== "ArrowUp" && event.key !== "ArrowDown" && event.key !== "Tab" && event.key !== "Enter") {
                        event.preventDefault();
                    }
                });
            </script>


<script>
   // Обработчик генерации пароля
function generatePassword(event) {
    console.log('Кнопка "Сгенерировать пароль" нажата');
    
    // Находим форму и поля ввода пароля в зависимости от того, в каком модальном окне находимся
    let passwordField;
    if (event.target.id === 'generatePasswordBtnCreate') {
        passwordField = document.getElementById('generatedPassword');
    } else if (event.target.id === 'generatePasswordBtnEdit') {
        passwordField = document.getElementById('edit_password');
    }
    
    // Получаем настройки генерации пароля
    const length = parseInt(document.getElementById('passwordLength')?.value) || 12;
    const includeUppercase = document.getElementById('includeUppercase')?.checked || false;
    const includeLowercase = document.getElementById('includeLowercase')?.checked || false;
    const includeDigits = document.getElementById('includeNumbers')?.checked || false;
    const includeSpecial = document.getElementById('includeSymbols')?.checked || false;

    // Собираем объект настроек
    const settings = {
        length: length,
        include_uppercase: includeUppercase,
        include_lowercase: includeLowercase,
        include_digits: includeDigits,
        include_special: includeSpecial
    };

    console.log('Настройки для генерации пароля:', settings);

    // Отправляем POST-запрос для генерации пароля
    fetch('/api/password_generator/generate_password/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (passwordField) {
            passwordField.value = data.password;
            console.log('Сгенерированный пароль установлен в поле ввода');
        }
    })
    .catch(error => {
        console.error('Ошибка сети при попытке генерации пароля:', error);
    });
}


function toggleFavorite(recordId, currentStatus) {
    const accessToken = localStorage.getItem('access_token');

    if (!recordId) {
        console.error('Ошибка: ID записи не передан!');
        return;
    }

    if (!accessToken) {
        console.error('Ошибка: токен доступа отсутствует!');
        return;
    }

    // Устанавливаем новый статус
    const newStatus = !currentStatus;

    // Отправляем PUT-запрос на сервер
    fetch(`/api/records/make_favorite/${recordId}?is_favorite=${newStatus}`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${accessToken}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Ошибка: ${response.statusText}`);
        }
        return response.json();
    })
    .then(updatedRecord => {
        console.log('Запись успешно обновлена:', updatedRecord);

        // Обновляем интерфейс
        const starElement = document.querySelector(`.favorite-column[data-record-id="${recordId}"] .star`);
        if (starElement) {
            starElement.textContent = updatedRecord.is_favorite ? '⭐' : '☆';
            starElement.classList.toggle('favorite', updatedRecord.is_favorite);
        }
    })
    .catch(error => {
        console.error('Ошибка при обновлении записи:', error);
        alert('Не удалось обновить статус избранного.');
    });
}

// Добавляем слушатели для кнопок "Сгенерировать пароль"
document.getElementById('generatePasswordBtnCreate').addEventListener('click', generatePassword);
document.getElementById('generatePasswordBtnEdit').addEventListener('click', generatePassword);

document.addEventListener("DOMContentLoaded", async function () {
    async function fetchRecords(skip = 0, limit = 10) {
        try {
            console.log(`Making GET request to /api/records/all?skip=${skip}&limit=${limit}`);

            const url = `/api/records/all?skip=${skip}&limit=${limit}`;
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                },
            });

            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
            }

            // Получение данных
            const records = await response.json();
            console.log('Records fetched:', records);

            // Вызов функции проверки и заполнения таблицы
            checkRecords(records);
            populateTable(records);
        } catch (error) {
            console.error('There was a problem with the fetch operation:', error);
        }
    }

    function checkRecords(records) {
        let recordsTable = document.getElementById("recordsTable");
        let noRecordsMessage = document.getElementById("noRecordsMessage");

        if (records.length === 0) {
            recordsTable.style.display = "none";
            noRecordsMessage.style.display = "block";
        } else {
            recordsTable.style.display = "block";
            noRecordsMessage.style.display = "none";
        }
    }

    // Вызываем загрузку записей при загрузке страницы
    await fetchRecords();
});


</script>
    </body>
    </html>
    