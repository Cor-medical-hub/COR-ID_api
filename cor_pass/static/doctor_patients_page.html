<!DOCTYPE html>
<html lang="ru" class="layout-page">
<head>
    <link rel="icon" type="image/png" href="./favicon.png">
    <meta charset="UTF-8"/>
    <title>Кор Lab — Пациенты</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="./css/reset.css">
    <link rel="stylesheet" type="text/css" href="./css/general.css">
    <link rel="stylesheet" type="text/css" href="./css/doctor-patient.css">
    <link rel="stylesheet" type="text/css" href="./css/header.css">
    <link rel="stylesheet" type="text/css" href="./COR_ID_css/modal.css">


</head>
<body class="layout-page">

<div class="layout">
    <main class="main">

        <div class="header-container">
            <div class="header-row top">
                <div class="search-container">
                    <input type="text" placeholder="Search" id="searchInput">
                    <svg class="search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                              d="M11.2 5.60001C8.10722 5.60001 5.60001 8.10722 5.60001 11.2C5.60001 14.2928 8.10722 16.8001 11.2 16.8001C12.7087 16.8001 14.0781 16.2035 15.085 15.2333C15.1061 15.2058 15.1292 15.1794 15.1544 15.1543C15.1795 15.1291 15.2059 15.106 15.2334 15.0849C16.2035 14.078 16.8 12.7087 16.8 11.2C16.8 8.10722 14.2928 5.60001 11.2 5.60001ZM16.8256 15.6942C17.8109 14.4624 18.4001 12.9 18.4001 11.2C18.4001 7.22357 15.1765 4 11.2 4C7.22356 4 4 7.22357 4 11.2C4 15.1765 7.22356 18.4001 11.2 18.4001C12.9001 18.4001 14.4625 17.8109 15.6942 16.8255L18.6344 19.7657C18.9468 20.0781 19.4533 20.0781 19.7658 19.7657C20.0782 19.4533 20.0782 18.9467 19.7658 18.6343L16.8256 15.6942Z"
                              fill="#B1A1DA"/>
                    </svg>
                </div>
                <div class="role-container">
                <button class="role-icon active" id="goToCases" aria-label="User roles">
                <svg class="icon-group" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.9128 14.6666L21.1708 4.16074C21.021 3.2917 20.2609 2.66131 19.3639 2.66131H16.7761C16.467 2.43219 16.0868 2.2911 15.6706 2.2911H12.8409L12.6787 1.98153C12.3601 1.37608 11.7315 1 11.0381 1H8.35324C7.38836 1 6.60335 1.73333 6.52327 2.66131H4.58528C3.67938 2.66131 2.91832 3.29903 2.77597 4.17786L1.06222 14.6969L1.06937 14.698C1.02563 14.8021 1 14.9157 1 15.0353V21.0819C1 22.1393 1.87554 23 2.95167 23H21.0483C22.1245 23 23 22.1393 23 21.0819V15.0353C23 14.9028 22.966 14.7796 22.9128 14.6666ZM19.8637 4.37446L21.4841 14.1482H19.5372V11.432C19.5372 10.7442 19.1411 10.1518 18.5656 9.84432V7.79733C18.5656 7.07879 18.1349 6.46222 17.5168 6.16885V4.10499C17.5168 4.05645 17.506 4.01079 17.5022 3.96317H19.3639C19.6123 3.96317 19.8229 4.13776 19.8637 4.37446ZM6.80027 6.50624C6.80027 6.22405 7.03421 5.9942 7.32141 5.9942H9.97192C10.1675 5.9942 10.3442 6.10032 10.4343 6.27149L10.9669 7.28578H16.7199C17.0071 7.28578 17.2405 7.51515 17.2405 7.79733V9.61807H11.3218L11.1596 9.3085C10.841 8.70306 10.2123 8.32698 9.51897 8.32698H6.80027V6.50624ZM5.77142 10.1404C5.77142 9.8582 6.00536 9.62883 6.29256 9.62883H9.51897C9.71459 9.62883 9.89228 9.73496 9.98188 9.90564L10.5145 10.9199H17.6915C17.9787 10.9199 18.2122 11.1498 18.2122 11.432V14.1482H15.0415C14.6508 14.1482 14.2874 14.3555 14.0928 14.6881L13.6065 15.5195C13.5587 15.6006 13.4696 15.6505 13.3745 15.6505H10.6175C10.5204 15.6505 10.4308 15.5987 10.3841 15.5155L9.92713 14.7027C9.7345 14.3614 9.36766 14.1482 8.96995 14.1482H5.77142V10.1404ZM8.35324 2.30186H11.0381C11.2337 2.30186 11.4114 2.40798 11.501 2.57866L12.0336 3.59295H15.6706C15.9579 3.59295 16.1918 3.82281 16.1918 4.10499V5.98393H11.7743L11.612 5.67485C11.2939 5.06891 10.6653 4.69234 9.97192 4.69234H7.8326V2.8134C7.8326 2.53122 8.06604 2.30186 8.35324 2.30186ZM4.08455 4.38326C4.12387 4.13971 4.33442 3.96317 4.58528 3.96317H6.50759V4.88637C5.89866 5.18317 5.47526 5.79442 5.47526 6.50624V8.52272C4.86826 8.82006 4.44641 9.42991 4.44641 10.1404V14.1482H2.49318L4.08455 4.38326ZM21.675 21.0819C21.675 21.4213 21.3938 21.6972 21.0483 21.6972H2.95167C2.60624 21.6972 2.32501 21.4213 2.32501 21.0819V15.451H8.83357L9.2243 16.1454C9.50404 16.6433 10.0381 16.9534 10.6175 16.9534H13.3745C13.9425 16.9534 14.4711 16.6531 14.7548 16.1689L15.1754 15.451H21.675V21.0819Z" fill="#7527B2"/>
                    <path d="M13.6847 18.5743H10.2901C9.91829 18.5743 9.61684 18.8705 9.61684 19.2359C9.61684 19.6012 9.91829 19.8974 10.2901 19.8974H13.6847C14.0566 19.8974 14.358 19.6012 14.358 19.2359C14.358 18.8705 14.0566 18.5743 13.6847 18.5743Z" fill="#7527B2"/>
                </svg>
                </button>
                    <div class="role-toggle">
                        <button class="role-btn active aic jcc df" style="min-width: 270px;" id="addPatientBtn">
                            <svg width="24" height="25" viewBox="0 0 24 25" fill="none"
                                 xmlns="http://www.w3.org/2000/svg">
                                <rect x="0.625" y="1.125" width="22.75" height="22.75" rx="11.375" stroke="white"
                                      stroke-width="1.25"/>
                                <path d="M7.01695 13.5C6.4553 13.5 6 13.0523 6 12.5C6 11.9477 6.4553 11.5 7.01695 11.5L16.9831 11.5C17.5447 11.5 18 11.9477 18 12.5C18 13.0523 17.5447 13.5 16.9831 13.5L7.01695 13.5Z"
                                      fill="white"/>
                                <path d="M13 17.4831C13 18.0447 12.5523 18.5 12 18.5C11.4477 18.5 11 18.0447 11 17.4831L11 7.51695C11 6.9553 11.4477 6.5 12 6.5C12.5523 6.5 13 6.9553 13 7.51695V17.4831Z"
                                      fill="white"/>
                            </svg>
                            Добавить пациента
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!--      <div class="search">-->
        <!--        <input type="text" placeholder="Search" id="searchInput"/>-->
        <!--        <svg viewBox="0 0 24 24">-->
        <!--          <circle cx="11" cy="11" r="8"/>-->
        <!--          <path d="M21 21l-4.35-4.35"/>-->
        <!--        </svg>-->
        <!--      </div>-->
        <!--      <button class="btn-square" id="peopleBtn" title="Пациенты">-->
        <!--          <img src="assets/people.png" alt="Люди" />-->
        <!--      </button>-->
        <!--      <button class="add-button" >-->
        <!--        <span class="icon-circle"><span>+</span></span>-->
        <!--        <span class="button-text">Добавить пациента</span>-->
        <!--      </button>-->

        <div class="filters-bar">

            <div id="filterBtn">
            </div>

            <div style="position:relative">
                <div class="sort" id="sortBtn">
                    <img src="./assets/sort.svg" alt="Сортировка" class="icon">
                    <span>Сортировка:</span>&nbsp;
                    <span id="sortLabel">
            <span>Дата зміни: від нових до старих</span>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12.7241 16.0865L12.7269 16.0834L18.7453 9.65889L18.7499 9.65396L18.7511 9.65252C19.1032 9.25733 19.0719 8.66929 18.7194 8.30513L18.7167 8.30066L18.7158 8.29968L18.7122 8.29599L18.7114 8.29678C18.3519 7.90305 17.7346 7.90088 17.3434 8.29665L17.3412 8.29895L17.3399 8.30027L17.3377 8.30263L12.0041 13.964L6.66231 8.29402L6.66086 8.2954C6.49594 8.09985 6.23847 8 5.97981 8C5.45224 8 5 8.43581 5 8.99434C5 9.25792 5.09722 9.48996 5.26063 9.65679L5.26438 9.66067L11.3137 16.0847L11.3169 16.0882L11.342 16.1139L11.3527 16.1241L11.3555 16.1268C11.7488 16.488 12.3668 16.4838 12.7241 16.0865Z"
                    fill="#5B4296"/>
            </svg>
          </span>

                </div>
                <div class="dropdown" id="sortDropdown">
                    <button data-field="date" data-dir="desc">Дата зміни: від нових до старих</button>
                    <button data-field="date" data-dir="asc">Дата зміни: від старих до нових</button>
                    <button data-field="name" data-dir="asc">Призвищє: від А до Я</button>
                    <button data-field="name" data-dir="desc">Призвищє: від Я до А</button>
                    <button data-field="id" data-dir="asc">COR ID: ↑</button>
                    <button data-field="id" data-dir="desc">COR ID: ↓</button>
                    <button data-field="age" data-dir="asc">Вік: ↑</button>
                    <button data-field="age" data-dir="desc">Вік: ↓</button>
                    <button data-field="gender" data-dir="asc">Стать: від А до Я</button>
                    <button data-field="gender" data-dir="desc">Стать: від Я до А</button>
                    <button data-field="status" data-dir="asc">Статус: від А до Я</button>
                    <button data-field="status" data-dir="desc">Статус: від Я до А</button>
                </div>
            </div>
        </div>


        <section class="patients_card">
            <div class="table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th data-field="name">Фамилия, имя, отчество</th>
                        <th data-field="id">COR ID</th>
                        <th data-field="age">Возраст</th>
                        <th data-field="gender">Пол</th>
                        <th data-field="date">Дослідження</th>
                        <th data-field="date">Дата изменения</th>
                        <th data-field="status">Статус</th>
                        <th style="width:32px"></th>
                    </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div class="footer" id="footerInfo"></div>
        </section>
    </main>
    <!-- КОНЕЦ основного контента -->
</div>

<!-- Модальное окно добавления пациента -->
<div id="addPatientModal" class="modal" style="display: none;">
    <div class="modal-header">
        <div class="modal-buttons">
            <button class="modal-button close" data-action="close" id="cancelPatientBtn">✖</button>
        </div>
        <h1>Новый пациент</h1>
    </div>

    <div class="tab-buttons">
        <button class="tab-button active" data-tab="byCorIdTab">Добавить по COR-ID</button>
        <button class="tab-button" data-tab="registerPatientTab">Регистрация пациента</button>
    </div>

    <div class="tab-content active" id="byCorIdTab">
        <div class="form-group-width">
            <label for="corIdInput">Введите COR-ID:</label>
            <input type="text" id="corIdInput" name="corIdInput" required maxlength="15">
        </div>
    </div>

    <div class="tab-content" id="registerPatientTab">
        <div class="form-group-width">
            <label for="surname">Фамилия</label>
            <input type="text" id="surname" name="surname" required>
        </div>

        <div class="form-group-width">
            <label for="firstName">Имя</label>
            <input type="text" id="firstName" name="firstName" required>
        </div>

        <div class="form-group-width">
            <label for="middleName">Отчество</label>
            <input type="text" id="middleName" name="middleName" required>
        </div>

        <div class="form-group-width">
            <label for="birthDate">Дата рождения</label>
            <input type="date" id="birthDate" name="birthDate" required>
        </div>

        <div class="form-group-width">
            <label>Пол:</label>
        </div>
        <div class="additional-fields">
            <label class="storage-option">
                <input type="radio" name="gender" value="M">
                <span class="custom-radio"></span>
                <span>Мужской</span>
            </label>

            <label class="storage-option">
                <input type="radio" name="gender" value="F">
                <span class="custom-radio"></span>
                <span>Женский</span>
            </label>
        </div>


        <div class="additional-fields">
            <div class="input-wrapper">
                <label for="patientEmail">Імейл</label>
                <input type="text" id="patientEmail" name="patientEmail">
            </div>
            <div class="input-wrapper">
                <label for="patientPhone">Телефон</label>
                <input type="text" id="patientPhone" name="patientPhone" required>
            </div>
        </div>

        <div class="form-group-width">
            <label for="address">Адрес</label>
            <input type="text" id="address" name="address" required>
        </div>
    </div>

    <button class="button" id="Add_Patient" data-translate="Add_Patient">Добавить пациента</button>
</div>


<!-- Модалка: Добавить устройство -->
<div id="addDeviceModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-buttons">
                <button class="modal-button close" data-action="close" id="closeAddDeviceModal">✖</button>
            </div>
            <h3 style="margin-top:30; color:#291161;font-size: 17px;">Новое устройство</h3>

        </div>

        <label>Тип устройства:</label>
        <select id="deviceType" class="select">
            <option value="Принтер">Принтер кассет</option>
            <option value="Сканер">Принтер стёкол</option>
            <option value="Камера">Сканер</option>
            <option value="Другое">Другое</option>
        </select>

        <label>ID устройства (0–65535):</label>
        <input type="text" class="select" id="deviceId" min="0" max="65535"/>

        <label>IP-адрес:</label>
        <input type="text" id="deviceIp" placeholder="000.000.000.000"/>

        <!--    <label>Маска подсети:</label>
            <input type="text" id="deviceMask" placeholder="000.000.000.000" />

            <label>Шлюз:</label>
            <input type="text" id="deviceGateway" placeholder="000.000.000.000" /> -->

        <label>Статус / Локация:</label>
        <input type="text" id="deviceLocation" maxlength="20" placeholder="Серверная, этаж 2"/>

        <button onclick="testDevice()" class="button" id="testDevice">Тест</button>
        <button onclick="addDevice()" class="button" id="addDevice">Сохранить</button>

    </div>
</div>

<!-- ─── ЛОГИКА (сортировка, поиск, обработчики) ─── -->
<script src="./COR_ID_Js/translation.js"></script>
<script src="./COR_ID_Js/general_fun.js"></script>
<script src="./js/general.js"></script>
<script src="./printers.js"></script>
<script>
    let searchParams = new URLSearchParams(document.location.search);
    const accessToken = searchParams.get("access_token")

    if (accessToken) {
        localStorage.setItem('access_token', accessToken)
    }


</script>
<script>

</script>
<script>
    /* Массив‑заглушка с трёмя пациентами */
    let patientList = [];
    let filtredPatientList = [];
    let currentSort = {
        field: "date",
        dir: "desc"
    };

    /* DOM‑ссылки */
    const tbody = document.getElementById("tableBody");
    const footerInfo = document.getElementById("footerInfo");

    const renderTableData = ( patientsData ) => {
        const roles = decodeToken(getToken())?.roles
        tbody.innerHTML = "";
        patientsData.forEach(r => {
            console.log(r, "r")
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td style="display:flex;align-items:center;background:var(--clr-surface-alt);">
              ${r.avatar ? `<img class="avatar" src="${r.avatar}" alt="">` : ""}${r.name}
            </td>
            <td>${r.patient_cor_id}</td>
            <td>${r.age ? `${r.age} лет` : ""}</td>
            <td>${r.sex === "M" ? "Мужской" : "Женский"}</td>
            <td>${r.cases.length > 1 ? `${r.cases[0]} ...` : r.cases.length === 1 ? `${r.cases[0]}` : ""}</td>
            <td>${new Date(r.change_date).toLocaleDateString()}</td>
            <td><span class="status">${r.status ? `<span class="status-dot"></span>${r.status}</span>` : ""}</td>
            <td class="ellipsis"><img src="./assets/actions.png" alt="Actions"></td>`;
            tr.onclick = () => {
                const page = roles.includes('doctor') ? "direction" : "lab";
                window.location.href = `/static/${page}.html?userCorId=${r.patient_cor_id}`
            }
            tbody.appendChild(tr);
        });
        footerInfo.textContent = `Всего: ${patientsData.length} пациентов`;
    }

    const sortTableRows = (field, dir) =>{
        filtredPatientList.sort((a, b) => dir === "asc" ? compare(a, b, field) : -compare(a, b, field));

        renderTableData(filtredPatientList);
    }
    const getPatients = () => {
        if(checkToken()){
            fetch(`${API_BASE_URL}/api/doctor/patients`, {
                method: "GET",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
            })
                .then(res => res.json())
                .then(userList => {
                    const {patients} = userList;
                    const formattedUserList = patients.map(patient => {
                        return {
                            ...patient,
                            change_date: "2025-05-09T07:19:51.498743",
                            name: getFulName(patient.surname, patient.first_name, patient.middle_name),
                            age: patient.birth_date ? getAge(patient.birth_date) : null, // добавить
                            status: patient?.status,
                        }
                    })

                    patientList = formattedUserList;
                    filtredPatientList = [...patientList];

                    /* Стартовый рендер */
                    sortTableRows(currentSort.field, currentSort.dir);
                })
        }
    }


    const goToCasesHanlder = () => {
        const roles = decodeToken(getToken())?.roles

        document.querySelector('#goToCases').addEventListener('click', () => {
            const page = roles.includes('doctor') ? "direction" : "lab";
            window.location.href = `/static/${page}.html`
        })
    }

    document.addEventListener('DOMContentLoaded', function () {
        goToCasesHanlder()
        getPatients()
    })


    /* Утилита: превращаем "дд.мм.гггг" в Date */
    function parseDate(str) {
        const [d, m, y] = str.split(".").map(Number);
        return new Date(y, m - 1, d);
    }

    /* Компаратор для сортировки по полю */
    function compare(a, b, field) {
        if (field === "date") return parseDate(a.change_date) - parseDate(b.change_date);
        if (field === "age") return a.age - b.age;
        return a[field].toString().localeCompare(b[field].toString(), "ru", {sensitivity: "base"});
    }


    const getFulName = (lastName, firstName, middleName) => {
        let result = []

        if (lastName) {
            result.push(lastName)
        }
        if (firstName) {
            result.push(firstName)
        }
        if (middleName) {
            result.push(middleName)
        }

        return result.join(' ');
    }

    /* === Поиск по таблице === */
    document.getElementById("searchInput").addEventListener("input", e => {
        const q = e.target.value.toLowerCase();
        filtredPatientList = patientList.filter(r =>
            Object.values(r).some(val => val.toString().toLowerCase().includes(q))
        );
        sortTableRows(currentSort.field, currentSort.dir);
    });

    /* Чек‑бокс «выбрать всё» */
    const selectAll = document.getElementById("selectAll");
    if (selectAll) {
        selectAll.addEventListener("change", e => {
            document.querySelectorAll(".rowChk").forEach(chk => chk.checked = e.target.checked);
        });
    }

    /* Dropdown с вариантами сортировки */
    const sortBtn = document.getElementById("sortBtn");
    const sortDropdown = document.getElementById("sortDropdown");
    const sortLabel = document.getElementById("sortLabel");

    sortBtn.addEventListener("click", e => {
        e.stopPropagation();
        sortDropdown.classList.toggle("visible");
    });
    window.addEventListener("click", () => sortDropdown.classList.remove("visible"));

    sortDropdown.addEventListener("click", e => {
        if (e.target.matches("button")) {
            const {field, dir} = e.target.dataset;
            currentSort = {field, dir};
            sortLabel.querySelector('span').textContent = e.target.textContent;
            sortDropdown.classList.remove("visible");
            sortTableRows(field, dir);
        }
    });

    /* Клик по шапке таблицы = быстрая сортировка */
    document.querySelectorAll("thead th[data-field]").forEach(th => {
        th.addEventListener("click", () => {
            const field = th.dataset.field;
            if (field === "select") return;
            const dir = currentSort.field === field && currentSort.dir === "asc" ? "desc" : "asc";
            currentSort = {field, dir};
            sortLabel.textContent = `Сортировка: ${th.textContent.trim()} ${dir === "asc" ? "↑" : "↓"}`;
            sortTableRows(field, dir);
        });
    });

    /* Заглушки */
    document.getElementById("addPatientBtn").addEventListener("click", function () {
        if (checkToken()) {
            const modal = document.getElementById('addPatientModal');
            if (modal) {
                modal.style.display = 'block';
                // Инициализируем модальное окно (если нужно)
                initModalControls('addPatientModal');
                // Делаем окно перетаскиваемым
                makeModalDraggable('addPatientModal');

            }
        }
    });

    async function addPatientByCorId() {
        const corId = document.getElementById('corIdInput').value;
        const token = localStorage.getItem('access_token'); // Предполагаю, что токен лежит в localStorage

        if (!corId) {
            alert('Пожалуйста, введите COR-ID');
            return;
        }

        try {
            if(checkToken()){
                const response = await fetch('/api/doctor/patients/add-existing', {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    },
                    body: JSON.stringify({
                        cor_id: corId,
                        status: 'registered'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Пациент успешно добавлен:', result);
                    alert('Пациент успешно добавлен!');
                    // Можно тут закрыть модалку и сбросить поле
                } else {
                    const error = await response.json();
                    console.error('Ошибка при добавлении пациента:', error);
                    alert('Ошибка: ' + (error.detail || 'Неизвестная ошибка'));
                }
            }
        } catch (error) {
            console.error('Ошибка сети:', error);
            alert('Ошибка сети: ' + error.message);
        }
    }

    function registerNewPatient() {
        // Собираем поля по правильным ID
        const surnameField = document.getElementById('surname');
        const firstNameField = document.getElementById('firstName');
        const middleNameField = document.getElementById('middleName');
        const birthDateField = document.getElementById('birthDate');
        const emailField = document.getElementById('patientEmail');
        const phoneNumberField = document.getElementById('patientPhone');
        const addressField = document.getElementById('address');

        const fields = [surnameField, firstNameField, middleNameField, birthDateField, emailField, phoneNumberField, addressField];
        const requiredFields = [surnameField, firstNameField, birthDateField];

        let isValid = true;

        // Сначала убираем старую подсветку
        fields.forEach(field => {
            field.style.borderColor = '#f0f0f0';
        });

        // Проверяем заполненность текстовых полей
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.style.borderColor = 'red';
                isValid = false;
            }
        });

        // Проверяем выбор пола
        const genderSelected = document.querySelector('input[name="gender"]:checked');
        const genderOptions = document.querySelectorAll('input[name="gender"]');
        genderOptions.forEach(option => {
            option.parentElement.style.border = 'none';
        });

        if (!genderSelected) {
            isValid = false;
            genderOptions.forEach(option => {
                option.parentElement.style.border = '1px solid red';
            });
        }

        if (!isValid) {
            alert('Пожалуйста, заполните все обязательные поля и выберите пол пациента.');
            return;
        }

        // Собираем данные
        const patientData = {
            email: emailField.value.trim(),
            surname: surnameField.value.trim(),
            first_name: firstNameField.value.trim(),
            middle_name: middleNameField.value.trim(),
            birth_date: birthDateField.value,
            sex: genderSelected.value,
            phone_number: phoneNumberField.value.trim(),
            address: addressField.value.trim(),
            photo: "",
            clinic_status: "registered"
        };

        if(checkToken()){
            fetch('/api/doctor/patients/register-new', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                },
                body: JSON.stringify(patientData)
            })

                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return response.json().then(err => Promise.reject(err));
                    }
                })
                .then(data => {
                    console.log('Пациент успешно добавлен:', data);
                    alert('Пациент успешно добавлен!');
                    document.getElementById('addPatientModal').style.display = 'none';

                    window.location.reload()
                })
                .catch(error => {
                    console.error('Ошибка при добавлении пациента:', error);
                    alert('Ошибка при добавлении пациента. Проверьте введённые данные.');
                });
        }
    }

    document.getElementById('Add_Patient').addEventListener('click', function () {
        if (checkToken()) {
            const activeTab = document.querySelector('.tab-content.active');

            if (activeTab && activeTab.id === 'byCorIdTab') {
                // Если выбрана вкладка "по COR-ID"
                addPatientByCorId();
            } else {
                // Если выбрана вкладка "регистрация пациента" - там будет другая функция
                registerNewPatient(); // (если хочешь, напишем её тоже)
            }
        }
    });


    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            // Убираем активные классы со всех кнопок и табов
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

            // Активируем выбранную кнопку и таб
            button.classList.add('active');
            document.getElementById(button.dataset.tab).classList.add('active');
        });
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Инициализация модального окна
        const modal = document.getElementById('addPatientModal');
        const addPatientBtn = document.getElementById('addPatientBtn');
        const cancelPatientBtn = document.getElementById('cancelPatientBtn');
        const savePatientBtn = document.getElementById('savePatientBtn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const importFileInput = document.getElementById('importFile');
        const importFileName = document.getElementById('importFileName');


        // Обработчик закрытия модального окна
        cancelPatientBtn?.addEventListener('click', function () {
            modal.style.display = 'none';
        });

        // Переключение между вкладками
        tabs.forEach(tab => {
            tab.addEventListener('click', function () {
                // Удаляем активный класс у всех вкладок
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                // Добавляем активный класс текущей вкладке
                this.classList.add('active');
                const tabId = this.dataset.tab + 'Tab';
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Функция для форматирования и проверки COR-ID
        function formatCorIdInput() {
            const inputField = document.getElementById('corIdInput');
            let value = inputField.value;

            // Удаляем все символы, кроме разрешенных
            value = value.replace(/[^A-Z0-9M-]/g, '').toUpperCase();

            // Вставляем дефис между частями
            if (value.length > 9) {
                value = value.slice(0, 9) + value.slice(9, 15);
            }

            // Обновляем значение в поле ввода
            inputField.value = value;
        }
    });


    document.getElementById("AddDevice")?.addEventListener("click", function () {
        document.getElementById("addDeviceModal").style.display = "block";
        makeModalDraggable('addDeviceModal');
    });

    // Функция закрытия модалки
    document.getElementById("closeAddDeviceModal").addEventListener("click", function () {
        document.getElementById("addDeviceModal").style.display = "none";
    });


    document.addEventListener('DOMContentLoaded', () => {
        startPrinterMonitoring();

        document.getElementById('sendLabelButton')?.addEventListener('click', async () => {
            const ip = document.getElementById('printerIp')?.value.trim() || PRINTER_IP;
            const isAvailable = await checkPrinterAvailability(ip);

            if (!isAvailable) {
                alert('Принтер недоступен. Проверьте соединение.');
                return;
            }

            await sendPrintRequest(ip);
        });
    });
</script>
</body>
</html>
