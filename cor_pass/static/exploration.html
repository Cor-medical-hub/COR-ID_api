<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/general.css">
    <link rel="stylesheet" href="./css/infoPlate.css">
    <link rel="stylesheet" href="./css/comments.css">
    <link rel="stylesheet" href="./css/header.css">
    <link rel="stylesheet" href="./css/glass.css">
    <link rel="stylesheet" href="./css/exploration.css">
    <link rel="stylesheet" href="./css/modal.css">
    <link rel="stylesheet" href="./css/doctorSign.css">
</head>
<body>

<div class="glassPageWrapper df fdc">
    <div class="header-container">
        <div class="header-row top">
            <div class="search-container">
                <input type="text" placeholder="Search">
                <svg class="search-icon" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="7"/><line x1="16.65" y1="16.65" x2="21" y2="21"/>
                </svg>
            </div>
            <div class="role-container">
                <button class="role-icon" aria-label="User roles">
                    <svg class="icon-group" viewBox="0 0 24 24">
                        <circle cx="9" cy="7" r="4"/>
                        <circle cx="17" cy="7" r="4"/>
                        <path d="M5 21v-2a4 4 0 0 1 4-4h0a4 4 0 0 1 4 4v2"/>
                        <path d="M13 21v-2a4 4 0 0 1 4-4h0a4 4 0 0 1 4 4v2"/>
                    </svg>
                </button>
                <div class="role-toggle">
                    <button class="role-btn doc active">–õ—ñ–∫–∞—Ä</button>
                    <button class="role-btn lab">–õ–∞–±–æ—Ä–∞–Ω—Ç</button>
                </div>
            </div>
        </div>
        <div class="header-row bottom">
            <div>
                <div class="tabs">
                    <button class="tab directionPage">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</button>
                    <button class="tab tenderloinPage">–í–∏—Ä—ñ–∑–∫–∞</button>
                    <button class="tab glassPage">–°–∫–µ–ª—å—Ü—è</button>
                    <button class="tab conclusionPage">–ó–∞–∫–ª—é—á–µ–Ω–Ω—è</button>
                    <button class="tab explorationPage active">–î–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è</button>
                </div>
            </div>
            <div class="meta-info">
                <div>
                    <span id="searchCaseId"></span>
                    <button class="edit-btn" aria-label="Edit case">
                        <svg class="icon-edit" viewBox="0 0 24 24">
                            <path d="M4 20h16"/>
                            <path d="M14.7 5.3l4 4L9 19.3l-4-4L14.7 5.3z"/>
                        </svg>
                    </button>
                </div>
                <div id="userName"></div>
                <div id="userGender"></div>
                <div id="userAge"></div>
            </div>
        </div>
    </div>
    <div class="glassPageContent df jcsb">
        <div class="left">
            <div class="top borderRadiusLeft df jcsb">
                <div>
                    –ü–æ—Ç–æ—á–Ω—ñ –∫–µ–π—Å–∏
                </div>
                <div class="glassPageRevert" style="display: none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="800px" height="800px" viewBox="0 0 24 24">
                        <path fill="none" stroke="#000000" stroke-width="2" d="M8,3 L3,8 L8,13 M12,20 L15,20 C18.3137085,20 21,17.3137085 21,14 C21,10.6862915 18.3137085,8 15,8 L4,8"/>
                    </svg>
                </div>
            </div>
            <div class="bottom">
                <div id="caseItems" class="caseItems"></div>
            </div>
        </div>
        <div class="middle df fdc">
            <div class="top df jcsb">
                <div>
                    –î–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è
                </div>
            </div>
            <div class="bottom df ">
                <div class="report-wrapper" id="explorationContent"></div>
            </div>
        </div>
        <div class="right" style="min-width: 180px">
            <div class="top">
                –î—ñ—ó
            </div>
            <div class="bottom ">
                <div class="explorationButton" id="doctorSignModalBtn">
                    –ü—ñ–¥–ø–∏—Å–∞—Ç–∏ —Ä–µ–ø–æ—Ä—Ç
                </div>
                <div class="explorationButton">
                    –í–∏–∫–ª—é—á–∏—Ç–∏ –¥—É–º–∫—É
                </div>
                <div class="explorationButton" id="closeCase">
                    –ó–∞–∫—Ä–∏—Ç–∏ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è
                </div>
                <div class="explorationButton open" id="printReport">
                    –î—Ä—É–∫—É–≤–∞—Ç–∏ —Ä–µ–ø–æ—Ä—Ç
                </div>
            </div>
        </div>
    </div>

    <div id="doctorSign" class="modal">
        <div class="modalWrapper">
            <div class="modalTitle">–ü—ñ–¥–ø–∏—Å</div>
            <div class="modalContent">
                <div>
                    <div class="doctorSignImgList open">
                        <div>
                            <label for="signFile" class="doctorSignUpload">
                                <svg width="800px" height="800px" viewBox="0 0 24 24" fill="none"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15 12L12 12M12 12L9 12M12 12L12 9M12 12L12 15" stroke="#1C274C"
                                          stroke-width="1.5" stroke-linecap="round"/>
                                    <path d="M7 3.33782C8.47087 2.48697 10.1786 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 10.1786 2.48697 8.47087 3.33782 7"
                                          stroke="#1C274C" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                                <input type="file" id="signFile" accept="image/*" style="display: none;">
                            </label>
                            <div class="doctorSignImgWrapper df fdc">

                            </div>
                        </div>
                        <div class="df aic jcc gap4">
                            <div class="doctorSignButton">
                                –ü—ñ–¥–ø–∏—Å–∞—Ç–∏
                            </div>
                            <div id="openCreateDoctorSign" class="doctorSignButton">
                                C—Ç–≤–æ—Ä–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å
                            </div>
                        </div>
                    </div>
                    <div class="doctorSignCreate">
                        <div id="clearDoctorSign">
                            <svg xmlns="http://www.w3.org/2000/svg" width="512px" height="512px" viewBox="0 0 512 512">
                                <path d="M469 472c0,0 0,0 0,0l-462 0c-3,0 -6,-2 -7,-5 -1,-3 1,-6 3,-8l103 -69c1,-1 2,-1 4,-1l7 0c5,10 11,19 19,27 21,20 48,32 77,32 29,0 57,-12 77,-32l27 -27 59 0c1,0 3,0 4,1l92 69c2,1 3,3 3,6 0,4 -3,7 -6,7z"
                                      fill="#6C00FF"/>
                                <path d="M213 439c-27,0 -52,-10 -70,-29 -39,-39 -39,-103 0,-142l12 -12 142 141 -13 13c-19,19 -44,29 -71,29zm77 -95c-2,0 -3,-1 -5,-2l-75 -75c-2,-3 -2,-7 0,-10l102 -102c2,-1 3,-2 5,-2 2,0 4,1 5,2l75 75c1,2 2,3 2,5 0,2 -1,4 -2,5l-102 102c-1,1 -3,2 -5,2zm-65 -82l65 66 93 -93 -66 -65 -92 92zm-60 -16l136 -136 141 141 -136 136 -141 -141zm146 -146l58 -58c1,-1 3,-2 5,-2 1,0 3,1 4,2l132 132c1,1 2,3 2,5 0,2 -1,3 -2,5l-58 58 -141 -142z"
                                      fill="#6C00FF"/>
                            </svg>
                        </div>
                        <div id="closeDoctorSignDraw">
                            <svg xmlns="http://www.w3.org/2000/svg" width="800px" height="800px" viewBox="0 0 24 24"
                                 fill="none">
                                <path d="M10.0303 8.96965C9.73741 8.67676 9.26253 8.67676 8.96964 8.96965C8.67675 9.26255 8.67675 9.73742 8.96964 10.0303L10.9393 12L8.96966 13.9697C8.67677 14.2625 8.67677 14.7374 8.96966 15.0303C9.26255 15.3232 9.73743 15.3232 10.0303 15.0303L12 13.0607L13.9696 15.0303C14.2625 15.3232 14.7374 15.3232 15.0303 15.0303C15.3232 14.7374 15.3232 14.2625 15.0303 13.9696L13.0606 12L15.0303 10.0303C15.3232 9.73744 15.3232 9.26257 15.0303 8.96968C14.7374 8.67678 14.2625 8.67678 13.9696 8.96968L12 10.9393L10.0303 8.96965Z"
                                      fill="#1C274C"/>
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                      d="M12 1.25C6.06294 1.25 1.25 6.06294 1.25 12C1.25 17.9371 6.06294 22.75 12 22.75C17.9371 22.75 22.75 17.9371 22.75 12C22.75 6.06294 17.9371 1.25 12 1.25ZM2.75 12C2.75 6.89137 6.89137 2.75 12 2.75C17.1086 2.75 21.25 6.89137 21.25 12C21.25 17.1086 17.1086 21.25 12 21.25C6.89137 21.25 2.75 17.1086 2.75 12Z"
                                      fill="#1C274C"/>
                            </svg>
                        </div>
                        <canvas id="drawing-board" style="width: 100%"></canvas>
                        <div class="df aic jcc gap4">
                            <div id="createDoctorSign" class="doctorSignButton active">
                                C—Ç–≤–æ—Ä–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div style="position: fixed; top: 0; right: 0; bottom: 0; left: 0;pointer-events: none;">
        <div id="qwerty">

        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="./COR_ID_Js/general_fun.js"></script>
<script src="./js/general.js"></script>
<script src="./js/canvasDraw.js"></script>
<script src="./js/doctorSignModal.js"></script>
<script>
    const PATIENT_COR_ID = new URLSearchParams(window.location.search).get('userCorId')
    const myCorId = decodeToken(localStorage.getItem('access_token'))?.corid

    let currentUserCorId = PATIENT_COR_ID || null;
    let currentCase = null;
    let currentDiagnosis = null

    const caseContentNODE = document.querySelector("#caseItems");
    const explorationContentNODE = document.querySelector("#explorationContent");
    const caseLabelNode = document.querySelector('#searchCaseId');
    const doctorSignModalBtnNODE = document.querySelector('#doctorSignModalBtn');
    const closeCaseBtnNODE = document.querySelector('#closeCase');

    const getMyCurrentDiagnosis = (currentReport) => {
        const myReportData = currentReport.doctor_diagnoses.find(({doctor}) => doctor.doctor_id === myCorId)
        const hasSign = myReportData?.signature;

        if(myReportData && !hasSign){
            currentDiagnosis = myReportData;
            doctorSignModalBtnNODE.classList.add('open')
            return;
        }

        currentDiagnosis = null;
        doctorSignModalBtnNODE.classList.remove('open')
    }
    const showCloseCaseBtn = (currentReport, currentCaseOwner) => {
        const hasAllSigns = currentReport?.doctor_diagnoses.every(({signature}) => !!signature);

        if(currentCaseOwner.is_case_owner && hasAllSigns){
            closeCaseBtnNODE.classList.add('open')
            return;
        }
        closeCaseBtnNODE.classList.remove('open')
    }

    const getImages = async (fileUrl) => {
        if(!fileUrl){
            return null
        }

        return fetch(`${API_BASE_URL}/api${fileUrl}`, {
            method: "GET",
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
            },
        })
            .then(response => response.blob())
            .then(blob => {
                return blob
            })
    }
    const caseTemplate = (workCase, isActive) => {
        const caseNewNODE = document.createElement('div');
        caseNewNODE.classList.add('caseItem', 'df', 'aic', 'jcsb', ...(isActive ? ['active'] : []));
        caseNewNODE.innerHTML = `
            <div>
                <div class="caseItemDate">${new Date(workCase.creation_date).toLocaleDateString()}</div>
                <div class="caseItemLabel">${workCase.case_code}</div>
            </div>
            <div class="caseItemSample df aic jcc">
                ${workCase.bank_count}
            </div>
            <div>
                <div class="infoPlate cassette">
                    ${workCase.cassette_count}
                </div>
            </div>
            <div>
                <div class="infoPlate glass">
                    ${workCase.glass_count}
                </div>
            </div>
        `;

        caseNewNODE.addEventListener("click", () => {
            fetch(`${API_BASE_URL}/api/doctor/cases/${workCase.id}/final-report`, {
                method: "GET",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                },
            })
                .then(res => res.json())
                .then(caseData => {
                    const {case_details, case_owner, report_details} = caseData;
                    document.querySelector('.caseItem.active').classList.remove('active')
                    caseNewNODE.classList.add('active')


                    currentCase = case_details;
                    currentReport = report_details;
                    currentCaseOwner = case_owner;
                    currentUserCorId = currentCase.patient_id

                    setReport(currentReport, currentCaseOwner)
                    getMyCurrentDiagnosis(currentReport)
                    showCloseCaseBtn(currentReport, currentCaseOwner)


                    caseLabelNode.innerHTML = currentCase.case_code
                    fetch(`${API_BASE_URL}/api/doctor/patients/${currentCase.patient_id}`, {
                        method: "GET",
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        },
                    })
                        .then(res => res.json())
                        .then(userData => {
                            document.querySelector('#userName').innerHTML = `${userData.surname || ""} ${userData.first_name || ""} ${userData.middle_name || ""}`;
                            document.querySelector('#userGender').innerHTML = userData.sex === "M" ? "–ß–æ–ª" : "–ñ—ñ–Ω";
                            document.querySelector('#userAge').innerHTML =`${userData.age ? `${userData.age}—Ä` : ''}`;
                        })
                })
        });
        return caseNewNODE
    }

    const setReport = (currentCase, caseOwner) => {
        explorationContentNODE.innerHTML = ``;
        const doctorDiagnoses = currentCase.doctor_diagnoses;
        currentCase.attached_glasses = currentCase.attached_glasses.map(data => ({
            ...data,
            file_url: "/cases/attachments/85ee8e3c-a912-4d2c-aaa1-875eeda0bd34"
        }))

        const caseOwnerDiagnosis = doctorDiagnoses.find(({doctor}) => doctor.doctor_id === caseOwner?.doctor_id)
        const {immunohistochemicalProfile, molecularGeneticProfile, pathomorphologicalDiagnosis} = doctorDiagnoses
            .reduce((doctorDiagnosesData, reportData) => {
                const {doctor} = reportData;
                const string = doctorDiagnoses.length > 1 ? `${getShortName(doctor.last_name, doctor.first_name, doctor.middle_name)}: ` : ""

                if(reportData.immunohistochemical_profile){
                    doctorDiagnosesData.immunohistochemicalProfile += `
                    <p>
                        ${string}${reportData.immunohistochemical_profile}
                    </p>
                    `
                }
                if(reportData.molecular_genetic_profile){
                    doctorDiagnosesData.molecularGeneticProfile += `
                    <p>
                        ${string}${reportData.molecular_genetic_profile}
                    </p>
                    `
                }
                if(reportData.pathomorphological_diagnosis){
                    doctorDiagnosesData.pathomorphologicalDiagnosis += `
                    <p>
                        ${string}${reportData.pathomorphological_diagnosis}
                    </p>
                    `
                }


                return doctorDiagnosesData;
            }, {
                immunohistochemicalProfile: "",
                molecularGeneticProfile: "",
                pathomorphologicalDiagnosis: "",
            })


        explorationContentNODE.innerHTML = `
            <div class="report-container">
                <header class="report-header">
                    <div class="hdr-left">
                        Kyiv, Ukraine 02000,<br>
                        Akademika Dobrokhotova St. 13
                    </div>
                    <div class="hdr-center">
                        <img src="./assets/logo.png" alt="Logo" class="logo">
                    </div>
                    <div class="hdr-right">
                        info@limbachgruppe.net,<br>
                        +38 (044) 333 75 01
                    </div>
                </header>

                <div class="report-content">

                    <h1 class="main-title">–ü–∞—Ç–æ–º–æ—Ä—Ñ–æ–ª–æ–≥—ñ—á–Ω–µ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è</h1>
                    <div class="doc-subtitle">
                        <strong>–ú–ï–î–ò–ß–ù–ê –î–û–ö–£–ú–ï–ù–¢–ê–¶–Ü–Ø 014/–æ</strong> –ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞ –Ω–∞–∫–∞–∑–æ–º –ú–û–ó –£–∫—Ä–∞—ó–Ω–∏ 29.05.2013 —Ä. ‚Ññ 435
                    </div>
                    <div class="report-number">‚Ññ ${currentCase.case_code}</div>
                    <div class="report-type">–ü–∞—Ç–æ–≥—ñ—Å—Ç–æ–ª–æ–≥—ñ—è</div>
                    <hr>

                    <section class="report-dates">
                        <div><strong>–î–∞—Ç–∞ –±—ñ–æ–ø—Å—ñ—ó:</strong> ${currentCase.biopsy_date || ""}</div>
                        <div><strong>–î–∞—Ç–∞ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è:</strong> ${currentCase.arrival_date || ""}</div>
                        <div><strong>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è:</strong> ${currentCase.report_date || ""}</div>
                    </section>
                    <hr>

                    <section class="patient-section">
                        <div class="patient-name">
                            <strong>–ü–∞—Ü—ñ—î–Ω—Ç:</strong> ${`${currentCase.patient_surname} ${currentCase.patient_first_name} ${currentCase.patient_middle_name}`}
                        </div>
                        <hr class="patient-hr">
                        <div class="patient-details">
                            <span><strong>–°—Ç–∞—Ç—å:</strong> ${currentCase.patient_sex === "F"? "–ñ—ñ–Ω": "–ß–æ–ª" }</span>
                            <span><strong>–î/–Ω:</strong> ${new Date(currentCase.patient_birth_date).toLocaleDateString()}</span>
                            <span><strong>–í—ñ–∫:</strong> ${getAge(currentCase.patient_birth_date)} —Ä–æ–∫—ñ–≤</span>
                            <span><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> ${currentCase.patient_phone_number}, ${currentCase.patient_email}</span>
                        </div>
                    </section>
                    <hr>

                    <section class="case-info">
                        <div class="info-item">
                            <div class="info-label"><strong>–ú–µ–¥–∏—á–Ω–∞ –∫–∞—Ä—Ç–∞:</strong></div>
                            <div class="info-value">‚Ññ ${currentCase.medical_card_number || ""}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><strong>–ú–µ–¥–∏—á–Ω–∏–π –∑–∞–∫–ª–∞–¥:</strong></div>
                            <div class="info-value">${currentCase.medical_institution || ""}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><strong>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è:</strong></div>
                            <div class="info-value">${currentCase.medical_department || ""}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><strong>–õ—ñ–∫—É—é—á–∏–π –ª—ñ–∫–∞—Ä:</strong></div>
                            <div class="info-value">${currentCase.attending_doctor || ""}</div>
                        </div>
                    </section>
                    <hr>

                    <section class="clinical-section">
                        <p><strong>–ö–ª—ñ–Ω—ñ—á–Ω—ñ –¥–∞–Ω—ñ:</strong> ${currentCase.clinical_data || ""}</p>
                        <hr class="mini-hr">
                        <p><strong>–ö–ª—ñ–Ω—ñ—á–Ω–∏–π –¥—ñ–∞–≥–Ω–æ–∑:</strong> ${currentCase.clinical_diagnosis || ""}</p>
                    </section>
                    <hr>

                    <section class="stats-section">
                        <div class="stats-item">
                            <strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤:</strong>
                            <div class="stats-line">
                                <strong>–û—Ç—Ä–∏–º–∞–Ω–æ</strong> <span class="stats-value">${currentCase.containers_recieved || ""}</span>
                                <strong>–ó–∞—è–≤–ª–µ–Ω–æ</strong> <span class="stats-value">${currentCase.containers_actual || ""}</span>
                            </div>
                        </div>
                        <div class="stats-item">
                            <strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –±–ª–æ–∫—ñ–≤:</strong>
                            <div class="stats-line">
                                <span class="stats-value">${currentCase.num_blocks || ""}</span>
                            </div>
                        </div>
                        <div class="stats-item">
                            <strong>–§—ñ–∫—Å–∞—Ü—ñ—è:</strong>
                            <div class="stats-line">
                                <span class="stats-value">${currentCase.fixation || ""}</span>
                            </div>
                        </div>
                        <div class="stats-item">
                            <strong>–î–µ–∫–∞–ª—å—Ü–∏–Ω–∞—Ü—ñ—è:</strong>
                            <div class="stats-line">
                                <span class="stats-value">${currentCase.decalcification || ""}</span>
                            </div>
                        </div>
                        <div class="stats-item">
                            <strong>–ú–∞–∫—Ä–æ–∞—Ä—Ö—ñ–≤:</strong>
                            <div class="stats-line">
                                <span class="stats-value">${currentCase.macroarchive || ""}</span>
                            </div>
                        </div>
                        <div class="stats-item">
                            <strong>–§–∞—Ä–±—É–≤–∞–Ω–Ω—è:</strong>
                            <div class="stats-line">
                                ${currentCase.painting.map( paint => `<span class="stats-value">${paint}</span>`)}
                            </div>
                        </div>
                    </section>
                    <hr>

                    <section class="text-section">
                        <p><strong>–ú–∞–∫—Ä–æ—Å–∫–æ–ø—ñ—á–Ω–∏–π –æ–ø–∏—Å:</strong> ${caseOwnerDiagnosis?.report_macrodescription || currentCase.macrodescription || ""}</p>
                    </section>
                    <hr>
                    <section class="text-section">
                        <p><strong>–ú—ñ–∫—Ä–æ—Å–∫–æ–ø—ñ—á–Ω–∏–π –æ–ø–∏—Å:</strong> ${caseOwnerDiagnosis?.report_microdescription || currentCase.microdescription || ""}</p>
                    </section>
                    <hr>
                    <section class="text-section">
                        <p><strong>–Ü–º—É–Ω–æ–≥—ñ—Å—Ç–æ—Ö—ñ–º—ñ—á–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å:</strong> ${immunohistochemicalProfile || ""}</p>
                    </section>
                    <section class="text-section">
                        <p><strong>–ú–æ–ª–µ–∫—É–ª—è—Ä–Ω–æ-–≥–µ–Ω–µ—Ç–∏—á–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å:</strong> ${molecularGeneticProfile || ""}</p>
                    </section>
                    <section class="text-section">
                        <p><strong>–ü–∞—Ç–æ–º–æ—Ä—Ñ–æ–ª–æ–≥—ñ—á–Ω–∏–π –¥—ñ–∞–≥–Ω–æ–∑:</strong> ${pathomorphologicalDiagnosis || ""}</p>
                    </section>
                    <hr>
                    <section class="text-section">
                        <p><strong>–ö–æ–º–µ–Ω—Ç–∞—Ä:</strong> ${caseOwnerDiagnosis?.comment || ""}</p>
                    </section>
                    <hr>

                    <section class="images-section" id="attachedGlassesReport">
                    </section>

                    <section id="signaturesDoctorReport">

                    </section>
                </div>
                <div class="doc-footer">
                    <div class="footer-left">
                        <strong>–ú–ï–î–ò–ß–ù–ê –î–û–ö–£–ú–ï–ù–¢–ê–¶–Ü–Ø 014/–æ</strong> –ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞ –Ω–∞–∫–∞–∑–æ–º –ú–û–ó –£–∫—Ä–∞—ó–Ω–∏ 29.05.2013 —Ä. ‚Ññ 435
                    </div>
                    <div class="footer-right">–î–æ–∫—É–º–µ–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ –ü–ó COR-Lab</div>
                </div>
            </div>
        `

        const allFiles = [
            ...currentCase.attached_glasses.map(({file_url}) => file_url),
            ...doctorDiagnoses.map(({signature}) => signature?.doctor_signature?.signature_scan_data)
        ]

        Promise.all(allFiles.map(getImages))
            .then(filesBlob => {
                const glassFiles = filesBlob.slice(0, currentCase.attached_glasses.length)
                const doctorFiles = filesBlob.slice(currentCase.attached_glasses.length)

                glassFiles.forEach((blob) => {
                    const attachedGlassesReportNODE = document.querySelector('#attachedGlassesReport');
                    const imgNODE = document.createElement('img');

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imgNODE.src = e.target.result; // ‚úÖ base64 —Å—Ç—Ä–æ–∫–∞
                        attachedGlassesReportNODE.appendChild(imgNODE);
                    };
                    reader.readAsDataURL(blob); // üëà –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º blob –≤ base64
                })

                doctorFiles.forEach((blob, index) => {
                    const currentDoctor = doctorDiagnoses[index]
                    const signaturesDoctorReportNODE = document.querySelector('#signaturesDoctorReport')

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        signaturesDoctorReportNODE.innerHTML += `
                        <div class="signoff-section">
                            <div class="signoff-left">
                                <strong>–õ—ñ–∫–∞—Ä: </strong>${currentDoctor.doctor.last_name} ${currentDoctor.doctor.first_name} ${currentDoctor.doctor.middle_name}
                                ${blob ? `<img src="${e.target.result}" alt="signature">` : ""}
                            </div>
                            ${currentDoctor.signature ? `<div className="signoff-right"><strong>–î–∞—Ç–∞:</strong> ${new Date(currentDoctor.signature.signed_at).toLocaleDateString()}</div>` : ""}
                        </div>
                        `
                    };
                    reader.readAsDataURL(blob); // üëà –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º blob –≤ base64
                })
            })
    }
    const setAllCases = () => {
        const currentRoutePart = PATIENT_COR_ID ? `patients/${PATIENT_COR_ID}` : `current_cases`
        fetch(`${API_BASE_URL}/api/doctor/${currentRoutePart}/final-report-page-data?skip=0&limit=100000`, {
            method: "GET",
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
            },
        })
            .then(res => res.json())
            .then(cases => {
                const {all_cases, report_details, case_owner, last_case_details} = cases;
                all_cases.forEach((currentCase, index) => {
                    caseContentNODE.append(caseTemplate(currentCase, !index))
                })

                if(!report_details){
                    return;
                }

                currentCase = last_case_details;
                currentReport = report_details;
                currentCaseOwner = case_owner;
                currentUserCorId = currentCase.patient_id
                setReport(currentReport, currentCaseOwner)
                getMyCurrentDiagnosis(currentReport)
                showCloseCaseBtn(currentReport, currentCaseOwner)

                caseLabelNode.innerHTML = currentCase.case_code

                fetch(`${API_BASE_URL}/api/doctor/patients/${currentCase.patient_id}`, {
                    method: "GET",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    },
                })
                    .then(res => res.json())
                    .then(userData => {
                        document.querySelector('#userName').innerHTML = `${userData.surname || ""} ${userData.first_name || ""} ${userData.middle_name || ""}`;
                        document.querySelector('#userGender').innerHTML = userData.sex === "M" ? "–ß–æ–ª" : "–ñ—ñ–Ω";
                        document.querySelector('#userAge').innerHTML = `${userData.age ? `${userData.age}—Ä` : ''}`;
                    })
            })
    }

    const switchRole = () => {
        document.querySelector('.role-toggle .role-btn:not(.active)').addEventListener('click', (e) => {
            window.location.href = `/static/lab.html?userCorId=${currentUserCorId}`
        })
    }
    const goToTab = () => {
        document.querySelectorAll(".tabs .tab:not(.active)").forEach(elem => {
            elem.addEventListener('click', e => {
                console.log(currentCase, "currentCase")
                const element = e.currentTarget;
                let queryString = []

                if(PATIENT_COR_ID){
                    queryString.push(`userCorId=${PATIENT_COR_ID}`)
                }

                if(currentCase?.id){
                    queryString.push(`caseId=${currentCase?.id}`)
                }


                if(element.classList.contains('directionPage')){
                    window.location.href = `/static/direction.html?${queryString.join('&')}`
                }
                if(element.classList.contains('tenderloinPage')){
                    window.location.href = `/static/tenderloin.html?${queryString.join('&')}`
                }
                if(element.classList.contains('glassPage')){
                    window.location.href = `/static/glass.html?${queryString.join('&')}`
                }
                if(element.classList.contains('conclusionPage')){
                    window.location.href = `/static/conclusion.html?${queryString.join('&')}`
                }
                if(element.classList.contains('explorationPage')){
                    window.location.href = `/static/exploration.html?${queryString.join('&')}`
                }
            })
        })
    }
    const revertButtonHandler = () => {
        const revertButtonNODE = document.querySelector('.glassPageRevert');
        if(PATIENT_COR_ID){
            revertButtonNODE.style.display = "block"
        }

        revertButtonNODE.addEventListener('click', () => {
            window.location.href = `/static/exploration.html`
        })
    }

    const signReportHandler = () => {
        const doctorSignButtonNODE = document.querySelector('.doctorSignButton');

        doctorSignButtonNODE.addEventListener('click', () => {
            signReport(currentDiagnosis?.id)
                .then(report => {
                    if(report?.doctor_diagnoses){
                        currentReport.doctor_diagnoses = report?.doctor_diagnoses

                        setReport(currentReport, currentCaseOwner)
                        getMyCurrentDiagnosis(currentReport)
                        showCloseCaseBtn(currentReport, currentCaseOwner)
                    }
                })
        })
    }

    const closeCaseHandler = () => {
        closeCaseBtnNODE.addEventListener('click', e => {
            return fetch(`${API_BASE_URL}/api/doctor/cases/${currentCase?.id}/close`, {
                method: "PUT",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
            })
                .then(res => res.json())
                .then(() => {
                    alert('–î–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –∑–∞–∫—Ä–∏—Ç–µ —É—Å–ø—ñ—à–Ω–æ!')
                    closeCaseBtnNODE.classList.remove('open')
                })
        })
    }

    const printReportHandler = () => {
        document.querySelector('#printReport').addEventListener('click', () => {
            const element = document.getElementById("explorationContent");
            if (!element) {
                console.error('Element not found:');
                return;
            }


            const opt = {
                margin: 0,
                padding: 0,
                filename: "file.pdf",
                image:{ type: 'jpeg', quality: 1 },
                html2canvas: { scale: 3, scrollY: 0, scrollX: 0 },
                jsPDF: { format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).outputPdf("bloburl").then((blobUrl) => {
                // Open in new tab instead of saving
                window.open(blobUrl, "_blank");
            });
            // html2pdf().set(opt).from(document.querySelector('#qwerty')).save()
        })
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", (event) => {
        goToTab()
        signReportHandler()
        switchRole()
        printReportHandler()
        setAllCases()
        revertButtonHandler()
        closeCaseHandler()
        showTextareaButton('caseMicroDescription')
        showTextareaButton('casePathohistologicalConclusion')
    });
</script>

</body>
</html>
