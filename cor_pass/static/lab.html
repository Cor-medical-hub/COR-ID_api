<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/infoPlate.css">
    <link rel="stylesheet" href="./css/general.css">
    <link rel="stylesheet" href="./css/comments.css">
    <link rel="stylesheet" href="./css/lab.css">
    <link rel="stylesheet" href="./css/modal.css">
    <link rel="stylesheet" href="./css/caseSettings.css">
    <link rel="stylesheet" href="./css/header.css">
    <link rel="stylesheet" href="./css/directionModal.css">
    <title>Document</title>
</head>
<body>
<div class="wrapper">
    <div class="pathomorphology df">
        <div class="caseWrapper">
            <div class="casePlaceholder placeholder">
                <div class="df aic jcsb">
                    <div class="df aic counter">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                        </svg>
                        <input id="countOfCase" type="number" value="1" class="counterInput"
                               style="color: #ED1064">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                            <path d="M13 16.9831C13 17.5447 12.5523 18 12 18C11.4477 18 11 17.5447 11 16.9831L11 7.01695C11 6.4553 11.4477 6 12 6C12.5523 6 13 6.4553 13 7.01695V16.9831Z"
                                  fill="#7527B2"/>
                        </svg>

                    </div>
                    <div id="createCase" class="actionButton create df aic jcc" style="background: #05B96D">
                        <img src="./assets/plusCircle.svg" alt="plusCircle">
                    </div>
                </div>
                <div id="parentMark" class="parentMark df aic gap4">
                    <div data-value="Standard" class="casePlate active">S</div>
                    <div data-value="Urgent" class="casePlate">U</div>
                    <div data-value="Frozen" class="casePlate">F</div>
                </div>
                <div class="divider"></div>
                <div id="childMark" class="childMark">
                    <div class="df aic gap4">
                        <div data-value="Resectio" class="casePlate active">R</div>
                        <div data-value="Biopsy" class="casePlate">B</div>
                        <div data-value="Excisio" class="casePlate">E</div>
                        <div data-value="Cytology" class="casePlate">C</div>
                    </div>
                    <div class="df aic gap4">
                        <div data-value="Cellblock" class="casePlate">X</div>
                        <div data-value="Second Opinion" class="casePlate">S</div>
                        <div data-value="Autopsy" class="casePlate">A</div>
                        <div data-value="Electron Microscopy" class="casePlate">Y</div>
                    </div>
                </div>
            </div>
            <div id="caseItems" class="caseItems df fdc aic"></div>
            <div class="arrows" id="caseItemsScroll">
                <div class="prev">
                    <img src="./assets/arrowDown.svg" alt="arrow">
                </div>
                <div class="next">
                    <img src="./assets/arrowDown.svg" alt="arrow">
                </div>
            </div>
        </div>
        <div class="specimenWrapper">
            <div class="specimenPlaceholder placeholder">
                <div class="df aic gap4 fdc">
                    <div class="df aic counter">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                        </svg>

                        <input id="countOfSpecimen" type="number" value="1" class="counterInput"
                               style="color: #ED1064">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                            <path d="M13 16.9831C13 17.5447 12.5523 18 12 18C11.4477 18 11 17.5447 11 16.9831L11 7.01695C11 6.4553 11.4477 6 12 6C12.5523 6 13 6.4553 13 7.01695V16.9831Z"
                                  fill="#7527B2"/>
                        </svg>

                    </div>
                    <div id="createSpecimen" class="actionButton create df aic jcc"
                         style="margin-top: 8px; background: #ED1064">
                        <img src="./assets/plusCircle.svg" alt="plusCircle">
                    </div>
                </div>
            </div>

            <div id="specimenItems" class="specimenItems df fdc aic">

            </div>

            <div class="arrows" id="specimenItemsScroll">
                <div class="prev">
                    <img src="./assets/arrowDown.svg" alt="arrow">
                </div>
                <div class="next">
                    <img src="./assets/arrowDown.svg" alt="arrow">
                </div>
            </div>
        </div>
        <div class="content df fdc">
            <div class="header-container">
                <div class="header-row top">
                    <div class="search-container">
                        <input type="text" placeholder="Search">
                        <svg class="search-icon" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="7"/><line x1="16.65" y1="16.65" x2="21" y2="21"/>
                        </svg>
                    </div>
                    <div class="role-container">
                        <button class="role-icon" aria-label="User roles">
                            <svg class="icon-group" viewBox="0 0 24 24">
                                <circle cx="9" cy="7" r="4"/>
                                <circle cx="17" cy="7" r="4"/>
                                <path d="M5 21v-2a4 4 0 0 1 4-4h0a4 4 0 0 1 4 4v2"/>
                                <path d="M13 21v-2a4 4 0 0 1 4-4h0a4 4 0 0 1 4 4v2"/>
                            </svg>
                        </button>
                        <div class="role-toggle">
                            <button class="role-btn active">Добавить пациента</button>
                        </div>
                    </div>
                </div>
                <div class="header-row bottom">
                    <div>
                        <div class="meta-info">
                            <div>
                                <span id="searchCaseId"></span>
                                <button class="edit-btn" aria-label="Edit case">
                                    <svg class="icon-edit" viewBox="0 0 24 24">
                                        <path d="M4 20h16"/>
                                        <path d="M14.7 5.3l4 4L9 19.3l-4-4L14.7 5.3z"/>
                                    </svg>
                                </button>
                            </div>
                            <div id="userName"></div>
                            <div id="userGender"></div>
                            <div id="userAge"></div>
                        </div>
                        <div class="tabs">
                            <button class="tab" id="directionModalBtn">Направлення</button>
                            <button class="tab" id="caseSettingsModalBtn">Параметри кейсу</button>
                        </div>
                    </div>

                </div>
            </div>
            <div class="df jcsb contentCassette">
                <div class="cassettePlaceholder placeholder">
                    <div class="df aic jcc counter">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                        </svg>

                        <input id="countOfCassette" type="number" value="1" class="counterInput"
                               style="color: #B2AFBA">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                            <path d="M13 16.9831C13 17.5447 12.5523 18 12 18C11.4477 18 11 17.5447 11 16.9831L11 7.01695C11 6.4553 11.4477 6 12 6C12.5523 6 13 6.4553 13 7.01695V16.9831Z"
                                  fill="#7527B2"/>
                        </svg>

                    </div>
                    <div class="df aic jcsb">
                        <div class="actionButton borderRightNone create" id="createCassette"
                             style="background: #B2AFBA">
                            <img src="./assets/plusCircle.svg" alt="plusCircle">
                        </div>
                        <div class="actionButton borderLeftNone print" style="background: #B2AFBA">
                            <img src="./assets/print.svg" alt="print">
                        </div>
                    </div>
                </div>
                <div class="df cassetteWrapper">
                    <div id="cassetteItems" class="df">

                    </div>
                    <div class="arrows" id="glassItemsScroll">
                        <div class="prev">
                            <img src="./assets/arrowDown.svg" alt="arrow">
                        </div>
                        <div class="next">
                            <img src="./assets/arrowDown.svg" alt="arrow">
                        </div>
                    </div>
                    <div class="arrows right" id="cassetteItemsScroll">
                        <div class="prev">
                            <img src="./assets/arrowDown.svg" alt="arrow">
                        </div>
                        <div class="next">
                            <img src="./assets/arrowDown.svg" alt="arrow">
                        </div>
                    </div>
                </div>
                <div class="commentsWrapper df fdc">
                    <div class="commentsWrapperTop">
                        Макроописание
                    </div>
                    <textarea id="sampleMacroDescription"></textarea>
                    <button class="commentsWrapperButton">Зберегти</button>
                </div>
            </div>
        </div>
    </div>
    <div id="caseSettingsModal" class="modal">
        <div class="modalWrapper">
            <div class="modalTitle">Параметри кейсу</div>
            <div class="caseSettings">
                <div class="df">
                    <div class="caseSettingsContent df">

                    </div>
                    <div class="commentsWrapper df fdc">
                        <div class="commentsWrapperTop">
                            Макроопис зразка
                        </div>
                        <textarea id="caseSettingsComments"></textarea>
                    </div>
                </div>
                <button class="modalButton">
                    Зберегти
                </button>
            </div>
        </div>
    </div>
    <div id="cassetteComments" class="modal">
        <div class="modalWrapper">
            <div class="modalTitle">Комментарий</div>
            <div>
                <textarea class="cassetteCommentsArea" placeholder="Текст комментария..."></textarea>
                <div class="modalSubmit">
                    Сохранить
                </div>
            </div>
        </div>
    </div>
    <div id="caseDirection" class="modal">
        <div class="modalWrapper">
        <div class="modalTitle">Направлення</div>
        <div class="directorModalTop">
            <!-- cor-id -->
            <b>S25B01251</b>
            <span class="mid"><span id="todayMeta"></span> | Фото/скан документу</span>
        </div>
        <div class="df gap4">
            <div class="directorModalLeft">
                <form id="directionForm" novalidate>
                    <div class="directorModalFormGroup">
                        <label for="research_type">Вид дослідження <span class="req">*</span></label>
                        <div class="directorModalFormGroup-select">
                            <div class="directorModalFormGroup-input"><span class="label">Оберіть вид</span></div>
                            <ul class="directorModalFormGroup-list">
                                <li class="disabled">Оберіть вид</li>
                                <li data-v="патогистология">Патгістологія</li>
                                <li data-v="иммуногистохимия">Імуногістохімія</li>
                                <li data-v="цитология">Цитологія</li>
                                <li data-v="FISH/CISH">NGS</li>
                            </ul>
                            <input type="hidden" id="research_type" name="research_type" required>
                        </div>
                    </div>

                    <div class="directorModalFormGroup">
                        <label for="container_count">Кількість контейнерів <span class="req">*</span></label>
                        <input id="container_count" type="number" name="container_count" class="input required" placeholder="0" min="1">
                    </div>

                    <div class="directorModalFormGroup">
                        <label for="medical_card_number">Медкарта №</label>
                        <input id="medical_card_number" name="medical_card_number" type="text" class="input">
                    </div>
                    <div class="directorModalFormGroup">
                        <label for="clinical_data">Клінічні дані</label>
                        <textarea id="clinical_data" name="clinical_data" class="input"></textarea>
                    </div>
                    <div class="directorModalFormGroup">
                        <label for="clinical_diagnosis">Клінічний діагноз</label>
                        <input id="clinical_diagnosis" name="clinical_diagnosis" type="text" class="input">
                    </div>

                    <div class="directorModalFormGroup">
                        <label for="medical_institution">Медичний заклад</label>
                        <div class="directorModalFormGroup-select">
                            <div class="directorModalFormGroup-input"><span class="label">Оберіть медичний заклад</span></div>
                            <ul class="directorModalFormGroup-list">
                                <li class="disabled">Оберіть медичний заклад</li>
                                <li data-v="Феофанія">Феофанія</li>
                                <li data-v="Інститут раку">Інститут раку</li>
                            </ul>
                            <input type="hidden" id="medical_institution" name="medical_institution">
                        </div>
                    </div>

                    <div class="directorModalFormGroup">
                        <label for="department">Відділення</label>
                        <div class="directorModalFormGroup-select">
                            <div class="directorModalFormGroup-input"><span class="label">Оберіть відділення</span></div>
                            <ul class="directorModalFormGroup-list">
                                <li class="disabled">Оберіть відділення</li>
                                <li data-v="Хірургія">Хірургія</li>
                                <li data-v="Терапія">Терапія</li>
                            </ul>
                            <input type="hidden" id="department" name="department">
                        </div>
                    </div>
                    <div class="directorModalFormGroup">
                        <label for="doctor_contacts">Контакти лікаря</label>
                        <input id="doctor_contacts" name="doctor_contacts" type="text" class="input" value="+380" autocomplete="off">
                    </div>

                    <div class="directorModalFormGroup">
                        <label for="medical_procedure">Медична процедура/операція</label>
                        <input id="medical_procedure" name="medical_procedure" type="text" class="input">
                    </div>
                    <div class="directorModalFormGroup">
                        <label for="final_report_delivery">Фінальний репорт відправити</label>
                        <input id="final_report_delivery" name="final_report_delivery" type="email" class="input" placeholder="email@example.com">
                    </div>
                    <div class="directorModalFormGroup">
                        <label for="issued_at">Виданий</label>
                        <input id="issued_at" name="issued_at" type="date" class="input">
                    </div>
                </form>
            </div>

            <div class="directorModalRight" id="uploadArea">
                <div class="upload-box" id="uploadBox" tabindex="0">
                    <div class="upload-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 4v10M7 9l5-5 5 5"/><rect x="4" y="18" width="16" height="2" rx="1"/></svg>
                    </div>
                    <span>Перетягніть сюди свої файли<br><b>або скануйте</b></span>
                    <small class="note">до 5 файлів</small>
                    <input type="file" id="fileInput" multiple accept="image/*,.pdf" hidden>
                </div>
            </div>
        </div>

        <div class="directorModalFooter">
            <button class="btn btn-primary" id="caseDirectionSubmit">Зберегти</button>
            <button class="btn btn-outline" id="caseDirectionScan">Сканувати</button>
        </div>
        </div>

    </div>
</div>

<script src="./js/general.js"></script>

<script>
    const PATIENT_COR_ID = new URLSearchParams(window.location.search).get('userCorId')
    let cases = []

    //Draw HTML Template
    let lastActiveCaseIndex = null;
    let lastActiveSpecimenIndex = null;

    let casePageIndex = 0;
    let specimenPageIndex = 0;
    let cassettePageIndex = 0;
    let glassPageIndex = 0;

    const caseContentNODE = document.querySelector("#caseItems");
    const specimenContentNODE = document.querySelector("#specimenItems");
    const cassetteContentNODE = document.querySelector("#cassetteItems");

    const cassetteCommentModalNODE = document.querySelector("#cassetteComments");

    const countCaseInputNODE = document.querySelector('#countOfCase')
    const countOfSpecimenInputNODE = document.querySelector('#countOfSpecimen')
    const countOfCassetteInputNODE = document.querySelector('#countOfCassette')

    const macroDescriptionTextareaNODE = document.querySelector('#sampleMacroDescription')

    const scrollContent = (e, contentNODESelector, arrowsNODESelector, paginationUpDown = true, currentPaginationPage) => {
        const elem = e?.currentTarget;
        const animationDirection = paginationUpDown ? "top" : "left";
        let newPaginationPage = currentPaginationPage;

        const caseContentNODE = document.querySelectorAll(contentNODESelector);


        let caseContentHeight = 0;
        let caseContentScrollHeight = 0;

        caseContentNODE.forEach(elem => {
            if (elem.clientHeight > caseContentHeight) {
                caseContentHeight = elem[paginationUpDown ? "clientHeight" : "clientWidth"];
            }

            if (elem.scrollHeight > caseContentScrollHeight) {
                caseContentScrollHeight = elem[paginationUpDown ? "scrollHeight" : "scrollWidth"];
            }
        })

        if (!elem) {
            caseContentNODE.forEach(elem => {
                elem.scrollTo({[animationDirection]: caseContentHeight * newPaginationPage, behavior: 'smooth'});
            })
        }

        if (elem?.classList.contains('prev')) {
            newPaginationPage -= 1;
            caseContentNODE.forEach(elem => {
                elem.scrollTo({[animationDirection]: caseContentHeight * newPaginationPage, behavior: 'smooth'});
            })
        }

        if (elem?.classList.contains('next')) {
            newPaginationPage += 1;
            caseContentNODE.forEach(elem => {
                elem.scrollTo({[animationDirection]: caseContentHeight * newPaginationPage, behavior: 'smooth'});
            })
        }

        if ((caseContentScrollHeight - caseContentHeight * (newPaginationPage + 1)) < 0) {
            document.querySelector(`${arrowsNODESelector} .next`).classList.add('disable')
        } else {
            document.querySelector(`${arrowsNODESelector} .next`).classList.remove('disable')
        }

        if (newPaginationPage === 0) {
            document.querySelector(`${arrowsNODESelector} .prev`).classList.add('disable')
        } else {
            document.querySelector(`${arrowsNODESelector} .prev`).classList.remove('disable')
        }

        return newPaginationPage;
    };

    const setPathomorphologyTemplate = (activeCaseIndex, activeSpecimenIndex) => {
        if ((activeCaseIndex === lastActiveCaseIndex) && (activeSpecimenIndex === lastActiveSpecimenIndex)) {
            return;
        }

        addActiveClass(".caseItem", activeCaseIndex)

        const currentCase = cases[activeCaseIndex];
        const currentSpecimen = currentCase.samples[activeSpecimenIndex];
        macroDescriptionTextareaNODE.value = currentSpecimen.macro_description || "";

        document.querySelector('#searchCaseId').innerHTML = currentCase.case_code

        cassetteContentNODE.innerHTML = ""

        if (activeCaseIndex !== lastActiveCaseIndex) {
            specimenContentNODE.innerHTML = ""

            currentCase.samples.map((specimen, specimenIndex) => {
                specimenContentNODE.append(specimenTemplate(specimen))

                if (specimenIndex === activeSpecimenIndex) {
                    currentSpecimen.cassettes.map((cassette, index) => {
                        cassetteContentNODE.append(cassetteTemplate(cassette, currentSpecimen.label, index))
                    })
                }
            })

            createOrDeleteGlassHandler()
            changeEntityCountHandler("#cassetteItems .counter input")
            addActiveClass(".specimenItem", activeSpecimenIndex)

            lastActiveCaseIndex = activeCaseIndex;
            lastActiveSpecimenIndex = activeSpecimenIndex;
            countOfSpecimenInputNODE.setAttribute('data-delete-count', currentCase.samples.length - 1)
            countOfCassetteInputNODE.setAttribute('data-delete-count', currentSpecimen.cassettes.length - 1)

            return;
        }

        currentSpecimen.cassettes.map((cassette, index) => {
            cassetteContentNODE.append(cassetteTemplate(cassette, currentSpecimen.label, index))
        })

        createOrDeleteGlassHandler()
        changeEntityCountHandler("#cassetteItems .counter input")
        addActiveClass(".specimenItem", activeSpecimenIndex)

        countOfCassetteInputNODE.setAttribute('data-delete-count', currentSpecimen.cassettes.length - 1)
        lastActiveCaseIndex = activeCaseIndex;
        lastActiveSpecimenIndex = activeSpecimenIndex;
    }
    const setAllCases = () => {
        fetch(`${API_BASE_URL}/api/doctor/patients/${PATIENT_COR_ID}`, {
            method: "GET",
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
            },
        })
            .then(res => res.json())
            .then(userData => {
                document.querySelector('#userName').innerHTML = `${userData.surname || ""} ${userData.first_name || ""} ${userData.middle_name || ""}`;
                document.querySelector('#userGender').innerHTML = userData.sex === "M" ? "Чол" : "Жін";
                document.querySelector('#userAge').innerHTML = `${userData.age}р`;

                    fetch(`${API_BASE_URL}/api/cases/patients/${PATIENT_COR_ID}/overview`, {
                    method: "GET",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    },
                })
                        .then(res => res.json())
                        .then(casesList => {
                            cases = casesList.all_cases
                            cases[0].samples = casesList.first_case_details.samples.map(({cassettes, ...sampleData}, index) => {
                                return {
                                    ...sampleData,
                                    ...(!index ? {cassettes} : {})
                                }
                            })

                            macroDescriptionTextareaNODE.value = cases[0].samples.macro_description || "";

                            cases.forEach((currentCase, index) => {
                                caseContentNODE.append(caseTemplate(currentCase, !index))
                            })

                            setPathomorphologyTemplate(0, 0)
                            countCaseInputNODE.setAttribute('data-delete-count', cases.length - 1)
                        })
            })

    }

    //ENTITY HTML TEMPLATES
    const caseTemplate = (currentCase, isActive) => {
        const caseNewNODE = document.createElement('div');
        caseNewNODE.classList.add('caseItem', ...(isActive ? ['active'] : []));
        caseNewNODE.innerHTML = `
            <div class="caseItemTop df jcsb aic">
                        <div class="caseItemImg">
                            <img src="./assets/caseItem.svg" alt="caseItem">
                            <div class="caseItemImgCount">
                                ${currentCase.bank_count}
                            </div>
                        </div>
                        <div>
                            <div class="caseItemDate">
                                ${new Date(currentCase.creation_date).toLocaleDateString()}
                            </div>
                            <div class="caseItemMark">
                                ${currentCase.case_code}
                            </div>
                        </div>
                    </div>
            <div class="caseItemBottom df gap8 aic">
                        <div class="df aic fdc">
                            <div class="infoPlate qr">
                                QR
                            </div>
                            <div>
                                <img src="./assets/print.svg" alt="print">
                            </div>
                        </div>
                        <div class="df aic fdc">
                            <div class="infoPlate cassette">
                                ${currentCase.cassette_count}
                            </div>
                            <div>
                                <img src="./assets/print.svg" alt="print">
                            </div>
                        </div>
                        <div class="df aic fdc">
                            <div class="infoPlate glass">
                                ${currentCase.glass_count}
                            </div>
                            <div>
                                <img src="./assets/print.svg" alt="print">
                            </div>
                        </div>
                    </div>
        `

        caseNewNODE.addEventListener("click", () => {
            fetch(`${API_BASE_URL}/api/cases/${currentCase.id}`, {
                method: "GET",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                },
            })
                .then(res => res.json())
                .then(currentCase => {
                    const currentCaseIndex = cases.findIndex(({id}) => id === currentCase.id)
                    cases[currentCaseIndex].samples = currentCase.samples;

                    setPathomorphologyTemplate(currentCaseIndex, 0)
                })
        });
        return caseNewNODE
    }
    const specimenTemplate = (currentSpecimen, isActive) => {
        const specimenNewNODE = document.createElement('div');
        specimenNewNODE.classList.add('specimenItem', ...(isActive ? ['active'] : []));
        specimenNewNODE.innerHTML = `
           <div class="df jcsb aic">
                        <div class="caseItemImg">
                            <img src="./assets/specimenItem.svg" alt="specimenItem">
                            <div class="caseItemImgCount">
                                ${currentSpecimen.sample_number}
                            </div>
                        </div>
                        <div class="specimenItemArchive" style="cursor: pointer">
                            <img src="./assets/${currentSpecimen.archive ? "archiveActive" : "archive"}.svg" alt="archive">
                        </div>
                    </div>
           <div class="specimenItemBottom df gap8 aic">
                        <div class="df aic fdc">
                            <div class="infoPlate cassette">
                                ${currentSpecimen.cassette_count}
                            </div>
                            <div>
                                <img src="./assets/print.svg" alt="print">
                            </div>
                        </div>
                        <div class="df aic fdc">
                            <div class="infoPlate glass">
                                ${currentSpecimen.glass_count}
                            </div>
                            <div>
                                <img src="./assets/print.svg" alt="print">
                            </div>
                        </div>
                    </div>
        `

        specimenNewNODE.addEventListener("click", () => {
            fetch(`${API_BASE_URL}/api/samples/${currentSpecimen.id}`, {
                method: "GET",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                },
            })
                .then(res => res.json())
                .then(currentSpecimen => {
                    const currentCase = cases[lastActiveCaseIndex]
                    const currentSpecimenIndex = currentCase.samples.findIndex(({id}) => id === currentSpecimen.id)
                    currentCase.samples[currentSpecimenIndex] = currentSpecimen;


                    setPathomorphologyTemplate(lastActiveCaseIndex, currentSpecimenIndex)
                })
        });
        specimenNewNODE.querySelector('.specimenItemArchive').addEventListener('click', (e) => {
            e.stopPropagation()
            const samplesIndex = cases[lastActiveCaseIndex].samples.findIndex(({id}) => id === currentSpecimen.id)
            const samplesArchiveValue = !cases[lastActiveCaseIndex].samples[samplesIndex].archive;

            fetch(`${API_BASE_URL}/api/samples/archive/${currentSpecimen.id}?archive=${samplesArchiveValue}`, {
                method: "PUT",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
            })
                .then(res => res.json())
                .then(() => {
                    cases[lastActiveCaseIndex].samples[samplesIndex].archive = samplesArchiveValue;

                    const archiveIcon = samplesArchiveValue ? "archiveActive" : "archive";

                    specimenNewNODE.querySelector('.specimenItemArchive img')
                        .setAttribute('src', `./assets/${archiveIcon}.svg`)
                })

        })

        return specimenNewNODE
    }
    const cassetteTemplate = (currentCassette, label, index) => {
        const glassesTemplate = currentCassette.glasses.map((glass) => glassTemplate(glass)).join('')

        const cassetteColumnNODE = document.createElement('div');
        cassetteColumnNODE.classList.add("cassetteColumn")
        cassetteColumnNODE.innerHTML = `
            <div class="cassetteItem df aic jcc">
                    <div class="cassetteItemImg">
                            <img src="./assets/cassetteItem.svg" alt="caseItem">
                            <div class="cassetteAction df jcsb aic">
                                <div>${currentCassette.cassette_number}</div>
                                <div class="cassetteComment"><img src="./assets/${currentCassette.comment?.length ? "commentActive" : "comment"}.svg" alt="comment"></div>
                                <div class="cassettePrint"><img src="./assets/print.svg" alt="print"></div>
                            </div>
                        </div>
            </div>
            <div class="glassPlaceholder placeholder" data-glass-index='${index}'>
                        <div class="df aic jcc counter">
                            <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z" fill="#7527B2"/>
                            </svg>
                            <input  data-delete-count="${currentCassette.glasses.length - 1}" type="number" value="1" class="counterInput" style="color: #88C6FF">
                            <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z" fill="#7527B2"/>
                                <path d="M13 16.9831C13 17.5447 12.5523 18 12 18C11.4477 18 11 17.5447 11 16.9831L11 7.01695C11 6.4553 11.4477 6 12 6C12.5523 6 13 6.4553 13 7.01695V16.9831Z" fill="#7527B2"/>
                            </svg>
                        </div>
                        <div class="df aic jcsb glassMark">
                            <div>
                                H&E
                            </div>
                            <div>
                                <img src="./assets/arrowDown.svg" alt="arrowDown">
                            </div>
                        </div>
                        <div class="df aic jcsb">
                            <div class="actionButton borderRightNone create" id="createGlass">
                                <img src="./assets/plusCircle.svg" alt="plusCircle">
                            </div>
                            <div class="actionButton borderLeftNone print">
                                <img src="./assets/print.svg" alt="print">
                            </div>
                        </div>
                    </div>
            <div class="glassItems df fdc">
                ${glassesTemplate}
            </div>
        `;

        cassetteColumnNODE.querySelector('.cassetteComment').addEventListener('click', () => {
            cassetteCommentModalNODE.dataset.id = currentCassette.id;
            cassetteCommentModalNODE.dataset.index = index;
            cassetteCommentModalNODE.classList.add('open');

            const currentUpdatedCassette = cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index];

            cassetteCommentModalNODE.querySelector('textarea').value = currentUpdatedCassette.comment
        })

        return cassetteColumnNODE
    }
    const glassTemplate = (currentGlass) => {
        return (
            `<div class="glassItem df aic jcsb">
                        <div>
                            ${currentGlass.glass_number} ${currentGlass.staining}
                        </div>
                        <div>
                            <img src="./assets/print.svg" alt="print">
                        </div>
                    </div>`
        )
    }

    //ENTITY CREATE
    const createOrDeleteCaseHandler = () => {
        const createCaseBtn = document.querySelector('#createCase')

        createCaseBtn.addEventListener('click', () => {
            lastActiveCaseIndex = null;
            lastActiveSpecimenIndex = null;

            const placeholderNODE = createCaseBtn.closest('.placeholder')
            const isDelete = placeholderNODE.classList.contains('negative')

            if (isDelete) {
                const deletedCasesIds = [...cases]
                    .reverse()
                    .slice(0, +countCaseInputNODE.value)
                    .map(({id}) => id);

                fetch(`${API_BASE_URL}/api/cases/delete`, {
                    method: "DELETE",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        case_ids: deletedCasesIds,
                    })
                })
                    .then(res => res.json())
                    .then(() => {
                        cases = cases.filter(currentCase => !deletedCasesIds.includes(currentCase.id));
                        [...caseContentNODE.querySelectorAll('.caseItem')]
                            .reverse()
                            .slice(0, +countCaseInputNODE.value).forEach(elem => {
                            elem.remove()
                        });
                        setPathomorphologyTemplate(0, 0);


                        casePageIndex = scrollContent(null, '#caseItems', "#caseItemsScroll", true, 0)
                        specimenPageIndex = scrollContent(null, "#specimenItems", "#specimenItemsScroll", true, 0)
                        cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                        glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)

                        alert(`Кейс${+countCaseInputNODE.value>1 ? "и" : ""} успішно видаленно`)

                        countCaseInputNODE.value = 1;
                        countCaseInputNODE.setAttribute('data-delete-count', cases.length - 1)

                    })
            }
            if (!isDelete) {
                fetch(`${API_BASE_URL}/api/cases/create`, {
                    method: "POST",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        patient_cor_id: PATIENT_COR_ID,
                        num_cases: +countCaseInputNODE.value,
                        urgency: parentMark,
                        material_type: childMark
                    })
                })
                    .then(res => res.json())
                    .then((newCase) => {
                        const newCaseWithInfo = newCase.all_cases.reverse();
                        newCaseWithInfo[0].samples = newCase.first_case_details.samples;
                        cases = [...newCaseWithInfo, ...cases];

                        newCaseWithInfo.reverse().map(currentCase => {
                            caseContentNODE.prepend(caseTemplate(currentCase, 0))
                        })

                        setPathomorphologyTemplate(0, 0)
                        casePageIndex = scrollContent(null, '#caseItems', "#caseItemsScroll", true, 0)
                        specimenPageIndex = scrollContent(null, "#specimenItems", "#specimenItemsScroll", true, 0)
                        cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                        glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)

                        alert(`Кейс${+countCaseInputNODE.value>1 ? "и" : ""} успішно створенно`)

                        countCaseInputNODE.value = 1;
                        countCaseInputNODE.setAttribute('data-delete-count', cases.length - 1)
                    })
            }

            counterReset()
        })
    }
    const createOrDeleteSpecimenHandler = () => {
        const createSpecimenBtn = document.querySelector('#createSpecimen')

        createSpecimenBtn.addEventListener('click', () => {
            lastActiveSpecimenIndex = null;

            const placeholderNODE = createSpecimenBtn.closest('.placeholder')
            const isDelete = placeholderNODE.classList.contains('negative')

            if (isDelete) {
                const deletedSamplesList = [...cases[lastActiveCaseIndex].samples]
                    .reverse()
                    .slice(0, +countOfSpecimenInputNODE.value);

                fetch(`${API_BASE_URL}/api/samples/delete`, {
                    method: "DELETE",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        sample_ids: deletedSamplesList.map(({id}) => id),
                    }),
                })
                    .then(res => res.json())
                    .then(() => {
                        cases[lastActiveCaseIndex].samples = cases[lastActiveCaseIndex].samples
                            .filter(sample => !deletedSamplesList.map(({id}) => id).includes(sample.id))

                        setPathomorphologyTemplate(lastActiveCaseIndex, 0);

                        [...specimenContentNODE.querySelectorAll('.specimenItem')]
                            .reverse()
                            .slice(0, +countOfSpecimenInputNODE.value)
                            .forEach(elem => {
                                elem.remove()
                            })


                        const deletedGlassCount = deletedSamplesList.reduce((deletedGlassCount, sample) => {
                            return deletedGlassCount + sample.glass_count
                        }, 0);
                        const deletedCassettesCount = deletedSamplesList.reduce((deletedGlassCount, sample) => {
                            return deletedGlassCount + sample.cassette_count
                        }, 0);
                        cases[lastActiveCaseIndex].cassette_count -= deletedCassettesCount;
                        cases[lastActiveCaseIndex].glass_count -= deletedGlassCount;
                        cases[lastActiveCaseIndex].bank_count -= +countOfSpecimenInputNODE.value;

                        specimenPageIndex = scrollContent(null, "#specimenItems", "#specimenItemsScroll", true, 0)
                        cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                        glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)

                        changeItemCountOnEntity()
                        alert(`Сампл${+countOfSpecimenInputNODE.value> 1 ? "и" : ""} успішно видаленно`)

                        countOfSpecimenInputNODE.setAttribute('data-delete-count', cases[lastActiveCaseIndex].samples.length - 1)
                        countOfSpecimenInputNODE.value = 1;
                    })
            }

            if (!isDelete) {
                fetch(`${API_BASE_URL}/api/samples/create`, {
                    method: "POST",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        case_id: cases[lastActiveCaseIndex].id,
                        num_samples: +countOfSpecimenInputNODE.value,
                    })
                })
                    .then(res => res.json())
                    .then(newSamples => {
                        const newSamplesInfo = newSamples.created_samples;
                        newSamplesInfo[0].cassettes = newSamples.first_sample_details.cassettes;

                        cases[lastActiveCaseIndex].samples = [
                            ...cases[lastActiveCaseIndex].samples,
                            ...newSamplesInfo,
                        ];
                        cases[lastActiveCaseIndex].cassette_count += +countOfSpecimenInputNODE.value
                        cases[lastActiveCaseIndex].bank_count += +countOfSpecimenInputNODE.value
                        cases[lastActiveCaseIndex].glass_count += +countOfSpecimenInputNODE.value

                        newSamples.created_samples.forEach(specimen => {
                            specimenContentNODE.append(specimenTemplate(specimen))
                        })


                        setPathomorphologyTemplate(lastActiveCaseIndex, 0)
                        changeItemCountOnEntity();

                        specimenPageIndex = scrollContent(null, "#specimenItems", "#specimenItemsScroll", true, 0)
                        cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                        glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)

                        alert(`Сампл${+countOfSpecimenInputNODE.value>1 ? "и" : ""} успішно створенно`)

                        countOfSpecimenInputNODE.setAttribute('data-delete-count', cases[lastActiveCaseIndex].samples.length - 1)
                        countOfSpecimenInputNODE.value = 1;
                    })
            }

            counterReset()
        })
    }
    const createOrDeleteCassetteHandler = () => {
        const createCassetteBtn = document.querySelector('#createCassette')
        createCassetteBtn.addEventListener('click', () => {
            const currentSamples = cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex];

            const placeholderNODE = createCassetteBtn.closest('.placeholder')
            const isDelete = placeholderNODE.classList.contains('negative')

            if (isDelete) {
                const deletedCassettesList = [...currentSamples.cassettes]
                    .reverse()
                    .slice(0, +countOfCassetteInputNODE.value)

                fetch(`${API_BASE_URL}/api/cassettes/delete`, {
                    method: "DELETE",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        cassette_ids: deletedCassettesList.map(({id}) => id),
                    })
                })
                    .then(res => res.json())
                    .then(() => {
                        cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes = (
                            cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes
                                .filter(cassette => !deletedCassettesList.map(({id}) => id).includes(cassette.id))
                        );

                        const deletedGlassCount = deletedCassettesList.reduce((deletedGlassCount, cassette) => {
                            return deletedGlassCount + cassette.glasses.length
                        }, 0);
                        cases[lastActiveCaseIndex].cassette_count -= +countOfCassetteInputNODE.value;
                        cases[lastActiveCaseIndex].glass_count -= deletedGlassCount;
                        cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassette_count -= +countOfCassetteInputNODE.value;
                        cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].glass_count -= deletedGlassCount;


                        [...cassetteContentNODE.querySelectorAll('.cassetteColumn')]
                            .reverse()
                            .slice(0, +countOfCassetteInputNODE.value).forEach(elem => {
                            elem.remove()
                        })

                        changeItemCountOnEntity()

                        cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                        glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)

                        alert(`Касет${+countOfCassetteInputNODE.value>1 ? "и" : "а"} успішно видаленн${+countOfCassetteInputNODE.value>1 ? "и" : "а"}`)

                        countOfCassetteInputNODE.setAttribute('data-delete-count', cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes.length - 1)
                        countOfCassetteInputNODE.value = 1;
                    })
            }

            if (!isDelete) {
                fetch(`${API_BASE_URL}/api/cassettes/create`, {
                    method: "POST",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        sample_id: currentSamples.id,
                        num_cassettes: +countOfCassetteInputNODE.value,
                        num_glasses_per_cassette: 1,
                    })
                })
                    .then(res => res.json())
                    .then(newCassettes => {
                        cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes = [
                            ...cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes,
                            ...newCassettes,
                        ];
                        cases[lastActiveCaseIndex].cassette_count += +countOfCassetteInputNODE.value;
                        cases[lastActiveCaseIndex].glass_count += +countOfCassetteInputNODE.value;
                        cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassette_count += +countOfCassetteInputNODE.value;
                        cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].glass_count += +countOfCassetteInputNODE.value;

                        let currentCassettesList = currentSamples.cassettes;

                        cassetteContentNODE.innerHTML = "";

                        currentCassettesList.forEach((cassette, index) => {
                            cassetteContentNODE.append(cassetteTemplate(cassette, currentSamples.label, index))
                        })


                        setPathomorphologyTemplate(lastActiveCaseIndex, lastActiveSpecimenIndex)

                        countOfCassetteInputNODE.setAttribute('data-delete-count', currentCassettesList.length - 1)


                        cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                        glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)
                        createOrDeleteGlassHandler()
                        changeEntityCountHandler("#cassetteItems .counter input")
                        changeItemCountOnEntity()
                        alert(`Касет${+countOfCassetteInputNODE.value>1 ? "и" : "а"} успішно ствернн${+countOfCassetteInputNODE.value>1 ? "і" : "а"}`)

                        countOfCassetteInputNODE.value = 1;
                    })
            }

            counterReset()
        })
    }
    const createOrDeleteGlassHandler = () => {
        const createGlassBtns = document.querySelectorAll('*[data-glass-index]')

        createGlassBtns.forEach((elem, index) => {
            const createGlassBtnNODE = elem.querySelector('#createGlass');

            createGlassBtnNODE.addEventListener('click', () => {
                const placeholderNODE = createGlassBtnNODE.closest('.placeholder')
                const isDelete = placeholderNODE.classList.contains('negative')
                const countOfGlassInput = elem.querySelector('.counterInput')
                const currentCassette = cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index];

                if (isDelete) {
                    const deletedGlassesIds = [...currentCassette.glasses]
                        .reverse()
                        .slice(0, +countOfGlassInput.value)
                        .map(({id}) => id);

                    fetch(`${API_BASE_URL}/api/glasses/delete`, {
                        method: "DELETE",
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            glass_ids: deletedGlassesIds,
                        })
                    })
                        .then(res => res.json())
                        .then(() => {
                            cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index].glasses = (
                                cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index].glasses
                                    .filter(glass => !deletedGlassesIds.includes(glass.id))
                            )
                            cases[lastActiveCaseIndex].glass_count -= +countOfGlassInput.value;
                            cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].glass_count -= +countOfGlassInput.value;

                            const glassContentNODE = elem.nextElementSibling;

                            [...glassContentNODE.querySelectorAll('.glassItem')].reverse().slice(0, +countOfGlassInput.value).forEach(elem => {
                                elem.remove()
                            })

                            changeItemCountOnEntity()
                            glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)
                            alert(`Скельц${+countOfGlassInput.value>1 ? "я" : "е"} успішно видаленн${+countOfGlassInput.value>1 ? "і" : "е"}`)
                            countOfGlassInput.value = 1;
                        })
                }

                if (!isDelete) {
                    fetch(`${API_BASE_URL}/api/glasses/create`, {
                        method: "POST",
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            cassette_id: currentCassette.id,
                            staining_type: "H&E",
                            num_glasses: +countOfGlassInput.value,
                        })
                    })
                        .then(res => res.json())
                        .then(newGlasses => {
                            cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index].glasses = [
                                ...cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index].glasses,
                                ...newGlasses,
                            ];
                            cases[lastActiveCaseIndex].glass_count += +countOfGlassInput.value;
                            cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].glass_count += +countOfGlassInput.value;

                            const glassContentNODE = elem.nextElementSibling;

                            newGlasses.forEach((glass) => {
                                glassContentNODE.innerHTML += glassTemplate(glass)
                            })

                            changeItemCountOnEntity()
                            glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)
                            alert(`Скельц${+countOfGlassInput.value > 1 ? "я" : "е"} успішно ствернн${+countOfGlassInput.value>1 ? "і" : "е"}`)
                            countOfGlassInput.value = 1;
                        })
                }

                counterReset()
            })
        })
    }

    //GENERAL EVENTS
    const changeEntityCountHandler = (queryNODE) => {
        const inputsCounterNODE = document.querySelectorAll(queryNODE);
        const increaseNumber = (currentInputNODE, currentCounterNODE) => {
            if (currentInputNODE.value === "99") {
                return;
            }
            const newValue = +currentInputNODE.value + 1;

            currentInputNODE.value = +currentInputNODE.value + 1
            currentInputNODE.dispatchEvent(new Event('input'))


            const isNegative = currentCounterNODE.classList.contains('negative');
            if (isNegative) {
                const maxDeleteCount = +currentInputNODE.dataset.deleteCount;
                if (newValue > maxDeleteCount) {
                    currentInputNODE.value = +currentInputNODE.value - 1
                }
            }
        }
        const decreaseNumber = (currentInputNODE, currentCounterNODE) => {
            if (currentInputNODE.value === "1") {
                if (!+currentInputNODE.dataset.deleteCount) {
                    return;
                }

                const isNegative = currentCounterNODE.classList.contains('negative');
                const classListMethod = isNegative ? "remove" : "add";
                const placeholderNODE = currentCounterNODE.closest('.placeholder');
                const createActionBtn = placeholderNODE.querySelector('.actionButton.create')
                const createActionBtnIcon = createActionBtn.querySelector('img')
                const createActionBtnIconSrc = isNegative ? "plusCircle" : "minusCircle";

                currentCounterNODE.classList[classListMethod]('negative')
                placeholderNODE.classList[classListMethod]('negative')
                createActionBtn.classList[classListMethod]('delete')
                createActionBtnIcon.setAttribute('src', `./assets/${createActionBtnIconSrc}.svg`);

                return;
            }

            currentInputNODE.value = +currentInputNODE.value - 1
            currentInputNODE.dispatchEvent(new Event('input'))
        }

        inputsCounterNODE.forEach(currentInput => {
            const currentCounterNODE = currentInput.closest('.counter');
            currentInput.previousElementSibling.addEventListener("click", (e) => {
                if (currentCounterNODE.classList.contains('negative')) {
                    increaseNumber(currentInput, currentCounterNODE)
                    return;
                }

                decreaseNumber(currentInput, currentCounterNODE)
            })
            currentInput.nextElementSibling.addEventListener("click", (e) => {
                if (currentCounterNODE.classList.contains('negative')) {
                    decreaseNumber(currentInput, currentCounterNODE)
                    return;
                }

                increaseNumber(currentInput, currentCounterNODE)
            })

            currentInput.addEventListener('paste', (e) => {
                let paste = (e.clipboardData || window.clipboardData).getData("text");

                if (isNaN(paste)) {
                    e.preventDefault()
                }

                if (paste > 99) {
                    e.preventDefault()
                    currentInput.value = 99
                }

                if (paste < 1) {
                    e.preventDefault()
                    currentInput.value = 1
                }
            })
        })
    }
    const changeItemCountOnEntity = () => {
        const activeCaseNODE = document.querySelector('.caseItem.active')
        const activeSpecimenNODE = document.querySelector('.specimenItem.active')

        const currentCase = cases[lastActiveCaseIndex]
        const currentSpecimen = cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex]

        activeCaseNODE.querySelector(".caseItemImgCount").textContent = currentCase.bank_count
        activeCaseNODE.querySelector(".infoPlate.cassette").textContent = currentCase.cassette_count
        activeCaseNODE.querySelector(".infoPlate.glass").textContent = currentCase.glass_count
        activeSpecimenNODE.querySelector(".infoPlate.cassette").textContent = currentSpecimen.cassette_count
        activeSpecimenNODE.querySelector(".infoPlate.glass").textContent = currentSpecimen.glass_count
    }
    const addActiveClass = (className, isActiveIndex) => {
        document.querySelectorAll(className).forEach(elem => {
            elem.classList.remove('active')
        })

        document.querySelector(`${className}:nth-child(${isActiveIndex + 1 || 1})`).classList.add("active");
    }
    const counterReset = () => {
        const allPlaceholder = document.querySelectorAll('.placeholder');
        allPlaceholder.forEach(elem => {

            elem.classList.remove('negative')
            elem.querySelector('.counter').classList.remove('negative')
            elem.querySelector('.actionButton.create').classList.remove('delete')
            elem.querySelector('.actionButton.create img').setAttribute('src',  `./assets/plusCircle.svg`)
        })}
    const changeMacroDescription = () => {
        macroDescriptionTextareaNODE.nextElementSibling.addEventListener('click', () => {
            const currentSample = cases[lastActiveCaseIndex]?.samples[lastActiveSpecimenIndex];

            fetch(`${API_BASE_URL}/api/samples/macrodescription/${currentSample.id}`, {
                method: "PUT",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    macro_description: macroDescriptionTextareaNODE.value.trim(),
                })
            })
                .then(res => res.json())
                .then(() => {
                    alert('Макро опис успішно оновлений')

                    macroDescriptionTextareaNODE.nextElementSibling.style.display = "none";
                })
        })
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", (event) => {
        createOrDeleteCaseHandler()
        createOrDeleteSpecimenHandler()
        createOrDeleteCassetteHandler()
        changeEntityCountHandler(".counter input")

        changeMacroDescription()
        setAllCases()

        showTextareaButton('sampleMacroDescription')
    });
</script>
<script>
    //PICK MARK
    let parentMark = "Standard";
    let childMark = "Resectio";

    document.addEventListener("DOMContentLoaded", (event) => {
        const parentMarkNODE = document.querySelectorAll('#parentMark .casePlate');
        const childMarkNODE = document.querySelectorAll('#childMark .casePlate');

        parentMarkNODE.forEach(elem => {
            elem.addEventListener("click", (e) => {
                parentMarkNODE.forEach(elem => elem.classList.remove('active'))
                const currentElem = e.target;

                currentElem.classList.add('active')

                parentMark = currentElem.dataset.value;
            })
        })

        childMarkNODE.forEach(elem => {
            elem.addEventListener("click", (e) => {
                childMarkNODE.forEach(elem => elem.classList.remove('active'))
                const currentElem = e.target;

                currentElem.classList.add('active')

                childMark = currentElem.dataset.value;
            })
        })
    });
</script>
<script>
    //ARROWS
    document.addEventListener("DOMContentLoaded", (event) => {
        const arrowsCase = document.querySelectorAll("#caseItemsScroll div");

        arrowsCase.forEach(elem => {
            elem.addEventListener("click", e => {
                casePageIndex = scrollContent(e, '#caseItems', "#caseItemsScroll", true, casePageIndex)
            })
        })
    });

    document.addEventListener("DOMContentLoaded", (event) => {
        const arrowsCase = document.querySelectorAll("#specimenItemsScroll div");

        arrowsCase.forEach(elem => {
            elem.addEventListener("click", e => {
                specimenPageIndex = scrollContent(e, "#specimenItems", "#specimenItemsScroll", true, specimenPageIndex)
            })
        })
    });

    document.addEventListener("DOMContentLoaded", (event) => {
        const arrowsCase = document.querySelectorAll("#cassetteItemsScroll div");

        arrowsCase.forEach(elem => {
            elem.addEventListener("click", e => {
                cassettePageIndex = scrollContent(e, "#cassetteItems", "#cassetteItemsScroll", false, cassettePageIndex)
            })
        })
    });

    document.addEventListener("DOMContentLoaded", (event) => {
        const arrowsGlass = document.querySelectorAll("#glassItemsScroll div");

        arrowsGlass.forEach(elem => {
            elem.addEventListener("click", e => {
                glassPageIndex = scrollContent(e, ".glassItems", "#glassItemsScroll", true, glassPageIndex)
            })
        })
    });
</script>
<script>
    //CASSETTE COMMENT
    document.addEventListener("DOMContentLoaded", (event) => {
        cassetteCommentModalNODE.querySelector('.modalSubmit').addEventListener('click', () => {
            const textareaNODE = cassetteCommentModalNODE.querySelector('textarea')

            const cassetteId = cassetteCommentModalNODE.dataset.id;
            const cassetteIndex = +cassetteCommentModalNODE.dataset.index;
            const commentValue = textareaNODE.value.trim();

            fetch(`${API_BASE_URL}/api/cassettes/${cassetteId}`, {
                method: "PATCH",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    comment: commentValue,
                })
            })
                .then(res => res.json())
                .then(() => {
                    cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[cassetteIndex].comment = commentValue;
                    const commentIconSrc = commentValue.length ? "commentActive" : "comment";

                    cassetteContentNODE
                        .querySelector(`.cassetteColumn:nth-child(${cassetteIndex + 1}) .cassetteComment img`)
                        .setAttribute('src', `./assets/${commentIconSrc}.svg`);

                    cassetteCommentModalNODE.classList.remove('open')
                })
        })
    });
</script>

<script src="./js/modal.js"></script>
<script src="./js/caseSettings.js"></script>
<script src="./js/directionModal.js"></script>

</body>
</html>
