<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/static/favicon.png">
       
        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
        <meta name="theme-color" content="#ffffff">
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <style>
        /* Основные стили для контейнера и таблицы */
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            width: 90%;
            max-width: 850px;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
        }
        
        /* Стили для таблицы */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px; /* Уменьшенный шрифт */
            margin-top: 8px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .delete-icon, .toggle-status-icon  {
            cursor: pointer;
            color: #ff4d4d;
            font-size: 16px; 
        }
        .delete-icon:hover {
            color: #cc0000;
        }

         /* Стили для пагинации */
         .pagination {
            margin-top: 20px;
            text-align: center;
        }
        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
        }
                /* Стили для ячеек с COR-ID */
        .cor-id-cell {
            cursor: pointer; /* Указатель мыши при наведении */
            text-decoration: none; /* Убираем подчеркивание по умолчанию */
        }

        /* Подчеркивание при наведении */
        .cor-id-cell:hover {
            text-decoration: underline; /* Подчеркивание при наведении */
            color: blue; /* Можно изменить цвет текста на синий, если нужно */
        }


    </style>
</head>
<body>
    <div class="container">
        <button class="link-button" onclick="goBack()" data-translate="back-link-text"><<<назад<<<</button>
        <h1>Пользователи</h1>
         <!-- Поля для поиска -->
         <div>
            <label for="searchId">Поиск по ID:</label>
            <input type="text" id="searchId" placeholder="Введите ID" oninput="filterTable()">
            
            <label for="searchEmail">Поиск по Email:</label>
            <input type="text" id="searchEmail" placeholder="Введите Email" oninput="filterTable()">
        </div>
        <!-- Модальное окно -->
            
<div id="columnSelectModal" style="display: none; position: fixed; font-size: 12px;top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgb(249, 249, 249); border: 1px solid #979292; border-radius: 5px; padding: 20px; z-index: 1000;">
      <div class="modal-header"> 
        <h3>Выберите поля для отображения:</h3>
   
    <label><input type="checkbox" onchange="toggleColumn('user_index')" id="checkbox-user_index" checked >Индекс</label><br>
    <label><input type="checkbox" onchange="toggleColumn('id')" id="checkbox-id" checked >ID</label><br>
    <label><input type="checkbox" onchange="toggleColumn('cor_id')" id="checkbox-cor_id" checked >COR-ID</label><br>
    <label><input type="checkbox" onchange="toggleColumn('user_sex')" id="checkbox-user_sex" checked >Пол</label><br>
    <label><input type="checkbox" onchange="toggleColumn('birth')" id="checkbox-birth" checked >Год рождения</label><br>
    <label><input type="checkbox" onchange="toggleColumn('email')" id="checkbox-email" checked >Email</label><br>
    <label><input type="checkbox" onchange="toggleColumn('created_at')" id="checkbox-created_at" checked >Дата регистрации</label><br>
    <label><input type="checkbox" onchange="toggleColumn('last_password_change')" id="checkbox-last_password_change" checked >Последнее изменение пароля</label><br>

                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal()">Закрыть</button>
                </div> 
      </div>         
</div>
        <!-- Модальное окно для отображения информации о COR-ID -->
        <div id="corIdModal" class="modal"style="display: none; position: fixed;font-size: 12px; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgb(249, 249, 249); border: 1px solid #ccc; border-radius: 5px; padding: 20px; z-index: 1000;">
            <div class="modal-content">
             <div class="modal-header">
                <div style="text-align: center; margin-top: 20px;">
                <h3>Информация о COR-ID:<br> <span id="corIdValue"></span></h3> <!-- Место для вывода COR-ID --></div>
                    <div id="corIdInfo">
                        <!-- Здесь информация о COR-ID -->
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="closeCorIdModal()">Закрыть</button>
                    </div>
             </div>
            </div>
        </div>
     

<button id="openModalBtn">Выбрать вывод</button>
        <!-- Таблица для отображения пользователей -->
        <table id="userTable">
            <thead>
                <tr>
                    <th id="header-user_index">Индекс</th>
                    <th id="header-id">ID</th>
                    <th id="header-cor_id">COR-ID</th>
                    <th id="header-user_sex">Пол</th>
                    <th id="header-birth">Год рождения</th>
                    <th id="header-email">Email</th>                
                    <th id="header-created_at">Дата регистрации</th>
                    <th id="header-last_password_change">Последнее изменение пароля</th>
                    <th id="header-account_status">Статус аккаунта</th> 
                    <th>Действия</th>
                </tr>
          <!--     <tr>
                    <th><input type="text" id="searchUserIndex" oninput="filterTable()"></th>
                    <th><input type="text" id="searchId" placeholder="Поиск по ID" oninput="filterTable()"></th>
                    <th><input type="text" id="searchCorId" placeholder="Поиск по COR-ID" oninput="filterTable()"></th>
                    <th><input type="text" id="searchUserSex" placeholder="Поиск по полу" oninput="filterTable()"></th>
                    <th><input type="text" id="searchBirth" placeholder="Поиск по году" oninput="filterTable()"></th>
                    <th><input type="text" id="searchEmail" placeholder="Поиск по Email" oninput="filterTable()"></th>
                    <th><input type="text" id="searchCreatedAt" placeholder="Поиск по дате" oninput="filterTable()"></th>
                    <th><input type="text" id="searchLastPasswordChange" placeholder="Поиск по дате" oninput="filterTable()"></th>
                    <th><input type="text" id="searchAccountStatus" placeholder="Поиск по статусу" oninput="filterTable()"></th>
                    <th></th> 
                </tr>--> 
            </thead>
            <tbody>
                <!-- Здесь будут добавлены пользователи -->
            </tbody>
        </table>

        <!-- Пагинация -->
        <div class="pagination" id="pagination">
            <button onclick="goToFirstPage()">« Первый</button>
            <button onclick="prevPage()">« Назад</button>
            <span id="page-info">Страница 1</span> <!-- Отображение текущей страницы -->
            <button onclick="nextPage()">Вперед »</button>
            <button onclick="goToLastPage()">Последний »»</button>
        </div>
    </div>

    <script> function goBack() { window.history.back();  } </script>

    
    <script> 

        let currentPage = 1;
        let rowsPerPage = 5;
        let totalRows = 0;

        
        let allFilteredUsers = []; // Хранение всех отфильтрованных данных
        let isFiltering = false; // Флаг для отслеживания процесса фильтрации
        // Функция для заполнения таблицы пользователей
        function populateTable(users) {
            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = ''; // Очистить таблицу перед заполнением

            users.forEach(user => {
                const row = document.createElement('tr');

                row.innerHTML = `
                ${document.getElementById('header-user_index').style.display !== 'none' ? `<td>${user.user_index}</td>` : ''}
                ${document.getElementById('header-id').style.display !== 'none' ? `<td>${user.id}</td>` : ''}
                ${document.getElementById('header-cor_id').style.display !== 'none' ? `<td class="cor-id-cell">${user.cor_id}</td>` : ''}
                ${document.getElementById('header-user_sex').style.display !== 'none' ? `<td>${user.user_sex}</td>` : ''}
                ${document.getElementById('header-birth').style.display !== 'none' ? `<td>${user.birth}</td>` : ''}
                ${document.getElementById('header-email').style.display !== 'none' ? `<td>${user.email}</td>` : ''}
                ${document.getElementById('header-created_at').style.display !== 'none' ? `<td>${new Date(user.created_at).toLocaleString()}</td>` : ''}
                ${document.getElementById('header-last_password_change').style.display !== 'none' ? `<td>${new Date(user.last_password_change).toLocaleString()}</td>` : ''}      
               
                    <td> <select onchange="confirmStatusChange('${user.email}', this.value)">
                            <option value="basic" ${user.account_status === 'basic' ? 'selected' : ''}>basic</option>
                            <option value="premium" ${user.account_status === 'premium' ? 'selected' : ''}>premium</option>
                        </select>
                    </td>
                    <td> <span class="delete-icon" onclick="deleteUser('${user.email}')">🗑️</span>
                        <span class="toggle-status-icon" onclick="toggleUserStatus('${user.email}', ${user.is_active ?? true})">
                         ${user.is_active !== false ? '🔓' : '🔒'}
                             </span>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        

async function getAllUsers(skip = 0, limit = rowsPerPage) {
    const token = localStorage.getItem('access_token');
    const accessToken = new URLSearchParams(window.location.search).get('access_token');
    const url = `/api/admin/get_all?skip=${skip}&limit=${limit}`;

    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + accessToken
            }
        });

        if (!response.ok) {
            throw new Error(`Ошибка: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        console.log(data); // Выводим полученные данные в консоль
       
             // Проверяем, вернулась ли пустая страница
             const users = data.users || data; // Если пользователей нет в data.users, используем data как массив
        if (Array.isArray(users) && users.length > 0) {
            populateTable(data); // Заполняем таблицу данными о пользователях
            return users; // Данные получены успешно
        } else {
            return false; // Пустая страница, данных больше нет
        }
    } catch (error) {
        console.error('Ошибка при загрузке пользователей:', error);
        return false;
    }
}

          // Функция для удаления пользователя
          async function deleteUser(email) {
            const accessToken = new URLSearchParams(window.location.search).get('access_token');
            const url = `/api/admin/${email}`;

            if (confirm(`Вы уверены, что хотите удалить пользователя с email: ${email}?`)) {
                try {
                    const response = await fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + accessToken
                        }
                    });

                    if (response.ok) {
                        alert(`Пользователь ${email} успешно удален.`);
                        getAllUsers(); // Обновить таблицу после удаления
                    } else {
                        const errorData = await response.json();
                        alert(`Ошибка удаления: ${errorData.message || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Ошибка при удалении пользователя:', error);
                    alert('Произошла ошибка при удалении пользователя.');
                }
            }
        }


        // Функция для изменения статуса пользователя
        async function confirmStatusChange(email, newStatus) {
            const confirmChange = confirm(`Вы уверены, что хотите изменить статус пользователя с email: ${email} на ${newStatus}?`);

            if (!confirmChange) return;

            const accessToken = new URLSearchParams(window.location.search).get('access_token');
            const url = `/api/admin/asign_status/${newStatus}?email=${encodeURIComponent(email)}`;

            try {
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (response.ok) {
                    alert(`Статус пользователя ${email} успешно изменен на ${newStatus}.`);
                    getAllUsers(); // Обновить таблицу после изменения статуса
                } else {
                    const errorData = await response.json();
                    alert(`Ошибка изменения статуса: ${errorData.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Ошибка при изменении статуса пользователя:', error);
                alert('Произошла ошибка при изменении статуса пользователя.');
            }
        }


 // Функция для отправки запроса на активацию/деактивацию пользователя
 async function toggleUserStatus(email, isActive) {
    // Получение accessToken из параметров URL
    const accessToken = new URLSearchParams(window.location.search).get('access_token');
    
    // Проверка на наличие accessToken
    if (!accessToken) {
        alert("Токен доступа не найден в URL.");
        return;
    }

    // Установка URL в зависимости от статуса isActive
    const url = isActive 
        ? `/api/admin/deactivate/${encodeURIComponent(email)}` 
        : `/api/admin/activate/${encodeURIComponent(email)}`;

    try {
        const response = await fetch(url, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + accessToken
            }
        });
        
        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            getAllUsers(); // Обновить таблицу после изменения статуса
        } else {
            alert(`Ошибка: ${result.message}`);
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при попытке изменить статус пользователя.');
    }
}

        async function filterTable() {
        if (isFiltering) {
            console.log("Фильтрация уже выполняется, отмена повторного запуска");
            return;
        }
        isFiltering = true;

        const idFilter = document.getElementById("searchId").value.toLowerCase();
        const emailFilter = document.getElementById("searchEmail").value.toLowerCase();
        console.log(`Фильтр по ID: ${idFilter}, Фильтр по Email: ${emailFilter}`);

        allFilteredUsers = [];
        let skip = 0;
        let hasMoreData = true;

        while (hasMoreData) {
                console.log(`Запрос данных с пропуском: ${skip}, лимит: ${rowsPerPage}`);
              //  const data = await getAllUsers(skip, rowsPerPage);
                const users = await getAllUsers(skip, rowsPerPage);            
                  

                    console.log("Полученные данные:",users);

                    if (Array.isArray(users) && users.length > 0) {
                    console.log(`Получено пользователей: ${users.length}`); // Измените data на users
                    const filteredUsers = users.filter(user => {
                        const idMatch = user.id.toLowerCase().includes(idFilter);
                        const emailMatch = user.email.toLowerCase().includes(emailFilter);
                        return idMatch && emailMatch;
                    });
                    console.log(`Отфильтровано пользователей: ${filteredUsers.length}`);
                    allFilteredUsers = allFilteredUsers.concat(filteredUsers);
                    skip += rowsPerPage;
                } else {
                    hasMoreData = false;
                    console.log("Нет больше данных");
                }
            }

        populateTable(allFilteredUsers.slice(0, rowsPerPage)); // Отображаем первую страницу отфильтрованных данных
        isFiltering = false;
    }

            // Обновляем информацию о текущей странице
        function updatePageInfo() {
            document.getElementById('page-info').innerText = `Страница ${currentPage}`;
        }


        // Функция перехода на следующую страницу
            async function nextPage() {
                const skip = currentPage * rowsPerPage;
                const dataAvailable = await getAllUsers(skip, rowsPerPage);

                // Увеличиваем currentPage, только если данные доступны
                if (dataAvailable) {
                    currentPage++;
                    updatePageInfo();
                }
            }

            // Перемотка на предыдущую страницу
            function prevPage() {
                if (currentPage > 1) {
                    currentPage--;
                    updatePageInfo();
                    const skip = (currentPage - 1) * rowsPerPage;
                    getAllUsers(skip, rowsPerPage); // Обновляем данные для предыдущей страницы
                }
            }


        function goToFirstPage() {
            currentPage = 1;
            updatePageInfo();
            loadPage();
        }

        async function goToLastPage() {
            let totalUsers = 0; // Общее количество пользователей

            // Запрашиваем пользователей до тех пор, пока есть данные
            let skip = 0;
            let hasMoreData = true;

            while (hasMoreData) {
                console.log(`Запрос данных с пропуском: ${skip}, лимит: ${rowsPerPage}`);
                const users = await getAllUsers(skip, rowsPerPage); // Получаем пользователей

                if (Array.isArray(users) && users.length > 0) {
                    totalUsers += users.length; // Увеличиваем общее количество пользователей
                    skip += rowsPerPage; // Увеличиваем пропуск для следующего запроса
                } else {
                    hasMoreData = false; // Прекращаем цикл, если нет больше данных
                    console.log("Нет больше данных");
                }
            }

            // Вычисляем общее количество страниц
            const totalPages = Math.ceil(totalUsers / rowsPerPage);
            currentPage = totalPages; // Устанавливаем текущую страницу на последнюю

            updatePageInfo(); // Обновляем информацию о текущей странице
            loadPage(); // Загружаем данные для последней страницы
        }

        function loadPage() {
            const skip = (currentPage - 1) * rowsPerPage;
            getAllUsers(skip, rowsPerPage);
        }

                // Функции для открытия и закрытия модального окна
            function openModal() {
                document.getElementById("corIdModal").style.display = "block";
            }

            function closeCorIdModal() {
                document.getElementById("corIdModal").style.display = "none";
            }

            // Функция для закрытия модального окна
            function closeModal() {
                document.getElementById('columnSelectModal').style.display = 'none';
            }

            document.addEventListener('DOMContentLoaded', function () {
           const tableBody = document.querySelector("#userTable tbody");

                // Пример добавления обработчика события на ячейки с COR-ID
                tableBody.addEventListener('click', function (event) {
                    if (event.target && event.target.classList.contains('cor-id-cell')) {
                        const corId = event.target.textContent;
                        showCorIdInfo(corId);
                    }
                });
            });

            function showCorIdInfo(corId) {
            const accessToken = new URLSearchParams(window.location.search).get('access_token');
            if (!accessToken) {
                console.error('Токен не найден!');
                return;
            }

                fetch("/api/medical/cor_id/show_corid_info", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ cor_id: corId })
                })
                .then(response => {
                    if (!response.ok) {
                        console.error('Ошибка на сервере:', response.statusText);
                        throw new Error("COR-Id не найден");
                    }
                    return response.json();
                })
                .then(data => {
                    // Отображение данных в модальном окне
                    document.getElementById("corIdValue").textContent = corId;
                    const corIdInfo = `
                        <p>Дней с 1 января 2024: ${data.n_days_since_first_jan_2024}</p>
                        <p>Номер учреждения: ${data.n_facility}</p>
                        <p>Номер пациента: ${data.n_patient}</p>
                        <p>Год рождения: ${data.birth_year}</p>
                        <p>Пол: ${data.sex}</p>
                    `;
                    document.getElementById("corIdInfo").innerHTML = corIdInfo;
                    openModal();
                })
                .catch(error => {
                    console.error("Ошибка:", error);
                    alert("Ошибка при загрузке информации о COR-ID");
                });}

            // Функция для переключения отображения колонок
            function toggleColumn(column) {
                const header = document.getElementById(`header-${column}`);
                const isVisible = header.style.display !== 'none';
                
                // Переключение видимости колонки
                header.style.display = isVisible ? 'none' : '';
                
                // Сохранение состояния в localStorage
                const columnState = JSON.parse(localStorage.getItem('columnsState') || '{}');
                columnState[column] = !isVisible; // Сохраняем новое состояние видимости колонки
                localStorage.setItem('columnsState', JSON.stringify(columnState));
                console.log('Записываем состояние в localStorage:', columnState);
                initializeCheckboxes();
                // Обновление видимости ячеек на основе нового состояния
                const cells = document.querySelectorAll(`tbody td:nth-child(${Array.from(header.parentNode.children).indexOf(header) + 1})`);
                cells.forEach(cell => {
                    cell.style.display = header.style.display;
                });

                loadPage(); // Загружаем страницу, если нужно
            }
                    
           // Функция для инициализации видимости колонок из localStorage
            function initializeColumns() {
                const columnState = JSON.parse(localStorage.getItem('columnsState') || '{}');

                // Применяем состояние для каждой колонки
                Object.keys(columnState).forEach(column => {
                    const header = document.getElementById(`header-${column}`);
                    if (header) {
                        const isVisible = columnState[column];
                        header.style.display = isVisible ? '' : 'none'; // Устанавливаем видимость

                        // Обновляем видимость ячеек в таблице
                        const cells = document.querySelectorAll(`tbody td:nth-child(${Array.from(header.parentNode.children).indexOf(header) + 1})`);
                        cells.forEach(cell => {
                            cell.style.display = header.style.display;
                        });
                    }
                });
            }

  
function initializeCheckboxes() {
    const columnState = JSON.parse(localStorage.getItem('columnsState') || '{}');
    console.log('Состояние колонок из localStorage:', columnState);

    // Пробегаемся по всем чекбоксам и обновляем их состояние
    const checkboxes = document.querySelectorAll('#columnSelectModal input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        const columnId = checkbox.id.replace('checkbox-', ''); // Извлекаем ID колонки без префикса
        console.log('ID колонки:', columnId);

        // Проверяем и устанавливаем состояние чекбокса
        if (columnState[columnId] !== undefined) {
            checkbox.checked = columnState[columnId];
            console.log(`Состояние для ${columnId}: ${columnState[columnId]}`);
        } else {
            console.log(`Нет состояния для ${columnId}, устанавливаем по умолчанию`);
        }
    });
}


        function makeModalDraggable(modalId) {
            const modal = document.getElementById(modalId);
            const header = modal.querySelector('.modal-header');
            let isDragging = false;
            let offsetX = 0, offsetY = 0;

            header.onmousedown = function(e) {
                isDragging = true;
                // Вычисляем начальное смещение курсора относительно модального окна
                offsetX = e.clientX - modal.offsetLeft;
                offsetY = e.clientY - modal.offsetTop;

                // Добавляем события перемещения и отпускания мыши
                document.onmousemove = function(e) {
                    if (isDragging) {
                        modal.style.left = `${e.clientX - offsetX}px`;
                        modal.style.top = `${e.clientY - offsetY}px`;
                    }
                };

                document.onmouseup = function() {
                    isDragging = false;
                    document.onmousemove = null;
                    document.onmouseup = null;
                };
            };
        }
        // Запуск функции после загрузки страницы
             document.addEventListener('DOMContentLoaded', function() {
             console.log('Страница загружена. Запуск процесса загрузки пользователей...');
             initializeColumns();
             initializeCheckboxes();
             makeModalDraggable('columnSelectModal');
             makeModalDraggable('corIdModal');
             // Функция для отображения модального окна
             document.getElementById('openModalBtn').onclick = function() {
             initializeCheckboxes();
             document.getElementById('columnSelectModal').style.display = 'block';
             //document.getElementById('columnSelectModal').addEventListener('show', initializeCheckboxes);
             };
              getAllUsers(); // По умолчанию загружаем 5 пользователей, начиная с 0
             });
    </script>
</body>
</html>

