<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/static/favicon.png">
       
        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
        <meta name="theme-color" content="#ffffff">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ —Ç–∞–±–ª–∏—Ü—ã */
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            width: 90%;
            max-width: 800px;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç */
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .delete-icon {
            cursor: pointer;
            color: #ff4d4d;
            font-size: 16px; 
        }
        .delete-icon:hover {
            color: #cc0000;
        }

         /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */
         .pagination {
            margin-top: 20px;
            text-align: center;
        }
        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="link-button" onclick="goBack()" data-translate="back-link-text"><<<–Ω–∞–∑–∞–¥<<<</button>
        <h1>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
         <!-- –ü–æ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞ -->
         <div>
            <label for="searchId">–ü–æ–∏—Å–∫ –ø–æ ID:</label>
            <input type="text" id="searchId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID" oninput="filterTable()">
            
            <label for="searchEmail">–ü–æ–∏—Å–∫ –ø–æ Email:</label>
            <input type="text" id="searchEmail" placeholder="–í–≤–µ–¥–∏—Ç–µ Email" oninput="filterTable()">
        </div>
        <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <table id="userTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
            </tbody>
        </table>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <div class="pagination" id="pagination">
            <button onclick="goToFirstPage()">¬´ –ü–µ—Ä–≤—ã–π</button>
            <button onclick="prevPage()">¬´ –ù–∞–∑–∞–¥</button>
            <span id="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span> <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
            <button onclick="nextPage()">–í–ø–µ—Ä–µ–¥ ¬ª</button>
            <button onclick="goToLastPage()">–ü–æ—Å–ª–µ–¥–Ω–∏–π ¬ª¬ª</button>
        </div>
    </div>

    <script> function goBack() { window.history.back();  } </script>
    <script>

        let currentPage = 1;
        let rowsPerPage = 5;
        let totalRows = 0;

        
        let allFilteredUsers = []; // –•—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        let isFiltering = false; // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function populateTable(users) {
            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º

            users.forEach(user => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.email}</td>
                    <td> <select onchange="confirmStatusChange('${user.email}', this.value)">
                            <option value="basic" ${user.account_status === 'basic' ? 'selected' : ''}>basic</option>
                            <option value="premium" ${user.account_status === 'premium' ? 'selected' : ''}>premium</option>
                        </select>
                    </td>
                    <td> <span class="delete-icon" onclick="deleteUser('${user.email}')">üóëÔ∏è</span></td>
                `;

                tbody.appendChild(row);
            });
        }

        

async function getAllUsers(skip = 0, limit = rowsPerPage) {
    const token = localStorage.getItem('access_token');
    const accessToken = new URLSearchParams(window.location.search).get('access_token');
    const url = `/api/admin/get_all?skip=${skip}&limit=${limit}`;

    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + accessToken
            }
        });

        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        console.log(data); // –í—ã–≤–æ–¥–∏–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Å–æ–ª—å
       
             // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–µ—Ä–Ω—É–ª–∞—Å—å –ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
             const users = data.users || data; // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç –≤ data.users, –∏—Å–ø–æ–ª—å–∑—É–µ–º data –∫–∞–∫ –º–∞—Å—Å–∏–≤
        if (Array.isArray(users) && users.length > 0) {
            populateTable(data); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
            return users; // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
        } else {
            return false; // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –¥–∞–Ω–Ω—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        return false;
    }
}

          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          async function deleteUser(email) {
            const accessToken = new URLSearchParams(window.location.search).get('access_token');
            const url = `/api/admin/${email}`;

            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å email: ${email}?`)) {
                try {
                    const response = await fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + accessToken
                        }
                    });

                    if (response.ok) {
                        alert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${email} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`);
                        getAllUsers(); // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                    } else {
                        const errorData = await response.json();
                        alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${errorData.message || response.statusText}`);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                }
            }
        }


        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function confirmStatusChange(email, newStatus) {
            const confirmChange = confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å email: ${email} –Ω–∞ ${newStatus}?`);

            if (!confirmChange) return;

            const accessToken = new URLSearchParams(window.location.search).get('access_token');
            const url = `/api/admin/asign_status/${newStatus}?email=${encodeURIComponent(email)}`;

            try {
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (response.ok) {
                    alert(`–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${email} —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${newStatus}.`);
                    getAllUsers(); // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                } else {
                    const errorData = await response.json();
                    alert(`–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${errorData.message || response.statusText}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
            }
        }


        async function filterTable() {
        if (isFiltering) {
            console.log("–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –æ—Ç–º–µ–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞");
            return;
        }
        isFiltering = true;

        const idFilter = document.getElementById("searchId").value.toLowerCase();
        const emailFilter = document.getElementById("searchEmail").value.toLowerCase();
        console.log(`–§–∏–ª—å—Ç—Ä –ø–æ ID: ${idFilter}, –§–∏–ª—å—Ç—Ä –ø–æ Email: ${emailFilter}`);

        allFilteredUsers = [];
        let skip = 0;
        let hasMoreData = true;

        while (hasMoreData) {
                console.log(`–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ–ø—É—Å–∫–æ–º: ${skip}, –ª–∏–º–∏—Ç: ${rowsPerPage}`);
              //  const data = await getAllUsers(skip, rowsPerPage);
                const users = await getAllUsers(skip, rowsPerPage);            
                  

                    console.log("–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:",users);

                    if (Array.isArray(users) && users.length > 0) {
                    console.log(`–ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`); // –ò–∑–º–µ–Ω–∏—Ç–µ data –Ω–∞ users
                    const filteredUsers = users.filter(user => {
                        const idMatch = user.id.toLowerCase().includes(idFilter);
                        const emailMatch = user.email.toLowerCase().includes(emailFilter);
                        return idMatch && emailMatch;
                    });
                    console.log(`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${filteredUsers.length}`);
                    allFilteredUsers = allFilteredUsers.concat(filteredUsers);
                    skip += rowsPerPage;
                } else {
                    hasMoreData = false;
                    console.log("–ù–µ—Ç –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö");
                }
            }

        populateTable(allFilteredUsers.slice(0, rowsPerPage)); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        isFiltering = false;
    }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function updatePageInfo() {
            document.getElementById('page-info').innerText = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}`;
        }


        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            async function nextPage() {
                const skip = currentPage * rowsPerPage;
                const dataAvailable = await getAllUsers(skip, rowsPerPage);

                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º currentPage, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã
                if (dataAvailable) {
                    currentPage++;
                    updatePageInfo();
                }
            }

            // –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            function prevPage() {
                if (currentPage > 1) {
                    currentPage--;
                    updatePageInfo();
                    const skip = (currentPage - 1) * rowsPerPage;
                    getAllUsers(skip, rowsPerPage); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                }
            }


        function goToFirstPage() {
            currentPage = 1;
            updatePageInfo();
            loadPage();
        }

        async function goToLastPage() {
            let totalUsers = 0; // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
            let skip = 0;
            let hasMoreData = true;

            while (hasMoreData) {
                console.log(`–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ–ø—É—Å–∫–æ–º: ${skip}, –ª–∏–º–∏—Ç: ${rowsPerPage}`);
                const users = await getAllUsers(skip, rowsPerPage); // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

                if (Array.isArray(users) && users.length > 0) {
                    totalUsers += users.length; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    skip += rowsPerPage; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–æ–ø—É—Å–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                } else {
                    hasMoreData = false; // –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º —Ü–∏–∫–ª, –µ—Å–ª–∏ –Ω–µ—Ç –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö
                    console.log("–ù–µ—Ç –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö");
                }
            }

            // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü
            const totalPages = Math.ceil(totalUsers / rowsPerPage);
            currentPage = totalPages; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é

            updatePageInfo(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            loadPage(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        }

        function loadPage() {
            const skip = (currentPage - 1) * rowsPerPage;
            getAllUsers(skip, rowsPerPage);
        }

     

        // –ó–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
            getAllUsers(); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–≥—Ä—É–∂–∞–µ–º 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–∞—á–∏–Ω–∞—è —Å 0
        });
    </script>
</body>
</html>

