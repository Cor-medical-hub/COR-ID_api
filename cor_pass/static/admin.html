<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/static/favicon.png">
       
        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
        <meta name="theme-color" content="#ffffff">
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/static/styles.css">
    <link rel="stylesheet" type="text/css" href="/static/modal.css">
    <link rel="stylesheet" type="text/css" href="/static/admin.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Подключаем стили flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Подключаем скрипт flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>      
    <title>Admin Page</title>
  
</head>
<body>
  <div class="admin-container">
        <button class="link-button" onclick="goBack('/static/mainscreen.html')" data-translate="back-link-text"><<<назад<<<</button>
        <h1>Пользователи</h1>

     <button id="openModalBtn">Выбрать вывод</button>
        <!-- Таблица для отображения пользователей -->
        <table id="userTable">
            <thead>
                <tr>
                    <th id="header-user_index">Индекс<br><input type="text" oninput="filterTable()" data-column="user_index"></th>
                    <th id="header-id">ID<br><input type="text" oninput="filterTable()" data-column="id"></th>
                    <th id="header-cor_id">COR-ID<br><input type="text" oninput="filterTable()" data-column="cor_id"></th>
                    <th id="header-user_sex">Пол<br><input type="text" oninput="filterTable()" data-column="user_sex"></th>
                    <th id="header-birth">Год рожд.<br><input type="text" oninput="filterTable()" data-column="birth"></th>
                    <th id="header-email">Email<br><input type="text" oninput="filterTable()" data-column="email"></th>
                    <th id="header-created_at">Дата регистрации<br><input type="text" oninput="filterTable()" data-column="created_at"></th>
                    <th id="header-last_password_change">Последнее изм. пароля<br><input type="text" oninput="filterTable()" data-column="last_password_change"></th>
                 <!--   <th id="header-last_active">Последняя активность<br><input type="text" oninput="filterTable()" data-column="last_active"></th> -->
                    <th id="header-last_active">Последняя активность<br>
                      <div class="date-range">
                        <input type="text" id="dateRangeActive" onchange="filterByDateRange()" placeholder="Выберите диапазон дат">
                      </div>
                    </th> 
                    <th id="header-account_status">Статус аккаунта<br><input type="text" oninput="filterTable()" data-column="account_status"></th>
                    <th>Действия</th>
                   
                </tr>
        
            </thead>
            <tbody>
                <!-- Здесь будут добавлены пользователи -->
            </tbody>
        </table>

        <!-- Пагинация -->
        <div class="pagination" id="pagination">
            <button onclick="goToFirstPage()" class="pagination button">« Первый</button>
            <button onclick="prevPage()"  class="pagination button">« Назад</button>
            <span id="page-info">Страница 1</span> <!-- Отображение текущей страницы -->
            <button onclick="nextPage()" class="pagination button">Вперед »</button>
            <button onclick="goToLastPage()" class="pagination button">Последний »»</button>
        </div>
  </div>

            <!-- Модальное окно выбора отображения колонок --> 
            <div id="columnSelectModal" class="modal" style="display: none;">
                <div class="modal-header">
                    <h1>Поля для отображения</h1>
                    <div class="modal-buttons">
                        <button class="modal-button close" data-action="close" id="closeColumnSelectModal">✖</button>
                    </div>
                </div>
                <div class="checkbox-container">
                    <label><input type="checkbox" onchange="toggleColumn('user_index')" id="checkbox-user_index" checked>Индекс</label>
                    <label><input type="checkbox" onchange="toggleColumn('id')" id="checkbox-id" checked>ID</label>
                    <label><input type="checkbox" onchange="toggleColumn('cor_id')" id="checkbox-cor_id" checked>COR-ID</label>
                    <label><input type="checkbox" onchange="toggleColumn('user_sex')" id="checkbox-user_sex" checked>Пол</label>
                    <label><input type="checkbox" onchange="toggleColumn('birth')" id="checkbox-birth" checked>Год рож.</label>
                    <label><input type="checkbox" onchange="toggleColumn('email')" id="checkbox-email" checked>Email</label>
                    <label><input type="checkbox" onchange="toggleColumn('created_at')" id="checkbox-created_at" checked>Дата регистрации</label>
                    <label><input type="checkbox" onchange="toggleColumn('last_password_change')" id="checkbox-last_password_change" checked>Последнее изменение пароля</label>
                    <label><input type="checkbox" onchange="toggleColumn('last_active')" id="checkbox-last_active" checked>Последняя активность</label>
                </div>
                <div class="modal-footer" style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('columnSelectModal')" class="button">ОК</button>
                </div>
            </div>

                
            <!-- Модальное окно для отображения информации о COR-ID -->
            <div id="corIdModal" class="modal" style="display: none;">
                <div class="modal-header">
                    <h1>Информация о COR-ID:</h1>
                    <div class="modal-buttons">
                        <button class="modal-button close" data-action="close" id="closeCorIDModal">✖</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <span id="corIdValue" style="color: #291161; font-size: 17px;"></span>
                </div>       
                    <div id="corIdInfo" class="cor-card"> </div>
                        <!-- Здесь информация о COR-ID -->                              
                    <div id="qrcode"></div>
            </div>



            <div id="rolesModal" class="modal" style="display: none;">
                <div class="modal-header">
                    <h3 style="margin-top:30; color:#291161;font-size: 17px;">Управление ролями пользователя:</h3>
                    <div class="modal-buttons">
                        <button class="modal-button close" data-action="close" id="closeRolesModal">✖</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <span id="rolesEmail" style="color: #291161; font-size: 15px;"></span>
                </div> 
                <div style="text-align: center; margin-top: 10px;">
                    <span id="rolesСorId" style="color: #291161; font-size: 17px;"></span>
                </div>       
                <div id="rolesList" class="checkbox-container">
                    <!-- Список ролей будет загружен динамически -->
                </div>
                <div class="modal-footer" style="text-align: center; margin-top: 20px;">
                    <button onclick="saveUserRoles()" class="button">Сохранить</button>
                </div>
            </div>
            
            <!-- Модальное окно с характеристиками роли -->
            <div id="roleInfoModal" class="modal" style="display: none;">
                <div class="modal-header">
                    <h3 style="margin-top:30; color:#291161;font-size: 17px;">Характеристики роли:</h3>
                    <div class="modal-buttons">
                        <button class="modal-button close" data-action="close" id="closeRoleInfoModal">✖</button>
                    </div>
                </div>
                <div id="roleInfoContent" style="padding: 20px;">
                    <!-- Здесь будет информация о роли -->
                </div>
            </div> 


    <script src="/static/translation.js"></script>
    <script src="/static/general_fun.js"></script>
    <script src="/static/admin.js"></script>
    <script> 

document.addEventListener('DOMContentLoaded', () => {
        initAdminPanel();
        initDateRangePickers();
        document.getElementById('closeRolesModal')?.addEventListener('click', () => closeModal('rolesModal'));
        document.getElementById('closeRoleInfoModal')?.addEventListener('click', () => closeModal('roleInfoModal'));
        document.getElementById('closeColumnSelectModal')?.addEventListener('click', () => closeModal('columnSelectModal'));
        document.getElementById('closeCorIDModal')?.addEventListener('click', () => closeModal('corIdModal'));

                });



                document.addEventListener('DOMContentLoaded', function () {
    const tableBody = document.querySelector("#userTable tbody");
    if (!tableBody) return;

    tableBody.addEventListener('click', function (event) {
        // Обработка клика на COR-ID
        if (event.target.tagName === 'TD' && event.target.classList.contains('cor-id-cell')) {
            const corId = event.target.textContent.trim();
            if (corId) showCorIdInfo(corId);
        }
        
        // Обработка клика на иконку ролей
        if (event.target.classList.contains('roles-icon')) {
            const row = event.target.closest('tr');
            if (row) {
                const corIdCell = row.querySelector('.cor-id-cell');
                if (corIdCell) {
                    const corId = corIdCell.textContent.trim();
                    if (corId) showUserRoles(corId);
                }
            }
        }
    });
});                

        let widthsArray= [20, 70, 70, 10, 30,70,50,50,50,50,30];
        let currentPage = 1;
        let rowsPerPage = 10;
        let totalRows = 0;

        
        let allFilteredUsers = []; // Хранение всех отфильтрованных данных
        let isFiltering = false; // Флаг для отслеживания процесса фильтрации
          

async function getAllUsers(skip = 0, limit = rowsPerPage) {
    const url = `/api/admin/get_all?skip=${skip}&limit=${limit}`;
    console.log('Запрос URL:', url);
    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            }
        });

        console.log('HTTP код ответа:', response.status); // Логируем HTTP статус ответа
        if (response.status==='401') {
        showTokenExpiredModal();
        } 

        if (!response.ok) {
            throw new Error(`Ошибка: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Полученные данные:', JSON.stringify(data, null, 2));
       
        const users = Array.isArray(data) ? data : []; 

        console.log('Проверка свойства users:', users);
       

        if (users.length > 0) {
            console.log('Полученные пользователи:', users);
            populateTable(users); 
            adjustTableLayout();
            return users;
        } else {
            console.log('Пользователи отсутствуют.');
            return false; 
        }
    } catch (error) {
        console.error('Ошибка при загрузке пользователей:', error);      
        return false;
    }
}
    

        // Функция для изменения статуса пользователя
        async function confirmStatusChange(email, newStatus) {
            const confirmChange = confirm(`Вы уверены, что хотите изменить статус пользователя с email: ${email} на ${newStatus}?`);

            if (!confirmChange) return;
            const url = `/api/admin/asign_status/${newStatus}?email=${encodeURIComponent(email)}`;

            try {
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    }
                });

                if (response.ok) {
                    alert(`Статус пользователя ${email} успешно изменен на ${newStatus}.`);
                    getAllUsers(); // Обновить таблицу после изменения статуса
                } else {
                    const errorData = await response.json();
                    alert(`Ошибка изменения статуса: ${errorData.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Ошибка при изменении статуса пользователя:', error);
                alert('Произошла ошибка при изменении статуса пользователя.');
            }
        }


 // Функция для отправки запроса на активацию/деактивацию пользователя
 async function toggleUserStatus(email, isActive) {
 

    // Установка URL в зависимости от статуса isActive
    const url = isActive 
        ? `/api/admin/deactivate/${encodeURIComponent(email)}` 
        : `/api/admin/activate/${encodeURIComponent(email)}`;

    try {
        const response = await fetch(url, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            }
        });
        
        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            getAllUsers(); // Обновить таблицу после изменения статуса
        } else {
            alert(`Ошибка: ${result.message}`);
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при попытке изменить статус пользователя.');
    }
}

async function filterTable() {
    if (isFiltering) {
        console.log("Фильтрация уже выполняется, отмена повторного запуска");
        return;
    }
    isFiltering = true;

    // Собираем значения фильтров из полей ввода
    const filters = {};
    document.querySelectorAll('thead input[type="text"]').forEach(input => {
        const column = input.getAttribute('data-column');
        const value = input.value.trim().toLowerCase();
        if (value) {
            filters[column] = value; // Добавляем в фильтры только непустые значения
        }
    });

    console.log("Активные фильтры:", filters);

    allFilteredUsers = [];
    let skip = 0;
    let hasMoreData = true;

    while (hasMoreData) {
        console.log(`Запрос данных с пропуском: ${skip}, лимит: ${rowsPerPage}`);
        const users = await getAllUsers(skip, rowsPerPage);

        if (Array.isArray(users) && users.length > 0) {
            console.log(`Получено пользователей: ${users.length}`);
            const filteredUsers = users.filter(user => {
                // Проверяем соответствие всех активных фильтров
                return Object.keys(filters).every(column => {
                    return user[column]?.toString().toLowerCase().includes(filters[column]);
                });
            });

            console.log(`Отфильтровано пользователей: ${filteredUsers.length}`);
            allFilteredUsers = allFilteredUsers.concat(filteredUsers);
            skip += rowsPerPage;
        } else {
            hasMoreData = false;
            console.log("Нет больше данных");
        }
    }

    // Отображаем первую страницу отфильтрованных данных
    populateTable(allFilteredUsers.slice(0, rowsPerPage));
    isFiltering = false;
}
  
            // Обновляем информацию о текущей странице
        function updatePageInfo() {
            document.getElementById('page-info').innerText = `Страница ${currentPage}`;
        }


        // Функция перехода на следующую страницу
            async function nextPage() {
                const skip = currentPage * rowsPerPage;
                const dataAvailable = await getAllUsers(skip, rowsPerPage);

                // Увеличиваем currentPage, только если данные доступны
                if (dataAvailable) {
                    currentPage++;
                    updatePageInfo();
                }
            }

            // Перемотка на предыдущую страницу
            function prevPage() {
                if (currentPage > 1) {
                    currentPage--;
                    updatePageInfo();
                    const skip = (currentPage - 1) * rowsPerPage;
                    getAllUsers(skip, rowsPerPage); // Обновляем данные для предыдущей страницы
                }
            }


        function goToFirstPage() {
            currentPage = 1;
            updatePageInfo();
            loadPage();
        }

        async function goToLastPage() {
            let totalUsers = 0; // Общее количество пользователей

            // Запрашиваем пользователей до тех пор, пока есть данные
            let skip = 0;
            let hasMoreData = true;

            while (hasMoreData) {
                console.log(`Запрос данных с пропуском: ${skip}, лимит: ${rowsPerPage}`);
                const users = await getAllUsers(skip, rowsPerPage); // Получаем пользователей

                if (Array.isArray(users) && users.length > 0) {
                    totalUsers += users.length; // Увеличиваем общее количество пользователей
                    skip += rowsPerPage; // Увеличиваем пропуск для следующего запроса
                } else {
                    hasMoreData = false; // Прекращаем цикл, если нет больше данных
                    console.log("Нет больше данных");
                }
            }

            // Вычисляем общее количество страниц
            const totalPages = Math.ceil(totalUsers / rowsPerPage);
            currentPage = totalPages; // Устанавливаем текущую страницу на последнюю

            updatePageInfo(); // Обновляем информацию о текущей странице
            loadPage(); // Загружаем данные для последней страницы
        }

        function loadPage() {
            const skip = (currentPage - 1) * rowsPerPage;
            getAllUsers(skip, rowsPerPage);
        }

                // Функции для открытия и закрытия модального окна
            function openModal() {
                document.getElementById("corIdModal").style.display = "block";
                
            }

            document.addEventListener('DOMContentLoaded', function () {
                const tableBody = document.querySelector("#userTable tbody");
                if (!tableBody) return;

                tableBody.addEventListener('click', function (event) {
                    // Более строгая проверка: клик именно на TD с классом cor-id-cell
                    if (event.target.tagName === 'TD' && event.target.classList.contains('cor-id-cell')) {
                        const corId = event.target.textContent.trim();
                        if (corId) showCorIdInfo(corId);
                    }
                });
            });

        
 
           
                    
           // Функция для инициализации видимости колонок из localStorage
            function initializeColumns() {
                const columnState = JSON.parse(localStorage.getItem('columnsState') || '{}');

                // Применяем состояние для каждой колонки
                Object.keys(columnState).forEach(column => {
                    const header = document.getElementById(`header-${column}`);
                    if (header) {
                        const isVisible = columnState[column];
                        header.style.display = isVisible ? '' : 'none'; // Устанавливаем видимость

                        // Обновляем видимость ячеек в таблице
                        const cells = document.querySelectorAll(`tbody td:nth-child(${Array.from(header.parentNode.children).indexOf(header) + 1})`);
                        cells.forEach(cell => {
                            cell.style.display = header.style.display;
                        });
                    }
                });
            }

  
            function adjustContainerWidth() {
    const table = document.querySelector('#userTable');
    const container = document.querySelector('.admin-container');
    if (!table || !container) return;

    // Временно переключаем layout
    table.style.tableLayout = 'auto';
    table.style.width = 'auto';

    // Принудительно пересчитываем ширину таблицы
    const actualWidth = table.scrollWidth;

    // Применяем ширину контейнеру
    container.style.width = `${actualWidth}px`;
    container.style.minWidth = '400px';
    container.style.maxWidth = '95vw';

    // Возвращаем фиксированный layout
    table.style.tableLayout = 'fixed';
    table.style.width = '100%';

    console.log('container width adjusted to:', container.style.width);
}

function setAllColumnWidths(widthsArray) {
    const table = document.querySelector('#userTable');
    if (!table || !widthsArray || !widthsArray.length) return;

    // Временно переключаем на auto layout для корректного расчета
    table.style.tableLayout = 'auto';
    
    // Получаем все заголовки
    const allHeaders = table.querySelectorAll('thead th');
    
    // Применяем ширины
    widthsArray.forEach((width, index) => {
        if (index >= allHeaders.length) return;
        
        const header = allHeaders[index];
        const cells = table.querySelectorAll(`tbody td:nth-child(${index + 1})`);
        
        // Устанавливаем ширину только если колонка видима
        if (header.style.display !== 'none') {
            header.style.width = `${width}px`;
            header.style.minWidth = `${width}px`;
            cells.forEach(cell => {
                cell.style.width = `${width}px`;
                cell.style.minWidth = `${width}px`;
            });
        } else {
            // Для скрытых колонок сбрасываем ширину
            header.style.width = '';
            header.style.minWidth = '';
            cells.forEach(cell => {
                cell.style.width = '';
                cell.style.minWidth = '';
            });
        }
    });

    // Возвращаем фиксированный layout после применения ширин
    table.style.tableLayout = 'fixed';
    console.log("Ширины колонок установлены");
}


           
function initAdminPanel() {
  // Проверка токена и безопасность
  checkToken();
  console.log('Страница загружена. Запуск процесса загрузки пользователей...');
  initializeColumns();
  initializeCheckboxes();
  adjustTableLayout();
  makeModalDraggable('columnSelectModal');
  makeModalDraggable('corIdModal');
  makeModalDraggable('rolesModal');
  makeModalDraggable('roleInfoModal');
  setupEventListeners();
  getAllUsers();
}

function initDateRangePickers() {
  const dateInputs = document.querySelectorAll('input[id*="Range"]');
  
  dateInputs.forEach(input => {
    input.addEventListener('focus', () => initFlatpickr(input));
  });
}


function initFlatpickr(inputElement) {
  new flatpickr(inputElement, {
    mode: "range", 
    dateFormat: "Y-m-d",
    onClose: function(selectedDates) {
      if (selectedDates.length === 2) {
        inputElement.value = formatDateRange(selectedDates[0], selectedDates[1]);
      }
    }
  });
}

function formatDateRange(startDate, endDate) {
  return `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
}

function setupEventListeners() {
  // Обработчик изменения размера окна
  window.addEventListener('resize', adjustTableLayout());
  
  // Обработчик открытия модального окна
  document.getElementById('openModalBtn').addEventListener('click', () => {
    initializeCheckboxes();
    document.getElementById('columnSelectModal').style.display = 'block';
  });
}

function adjustTableLayout() {
    
    setAllColumnWidths(widthsArray);
   // adjustContainerWidth();
}



async function showUserRoles(corId) {
    if (!checkToken()) return;
    try {
        const response = await fetch(`/api/admin/get_user_info/${corId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            }
        });

        if (!response.ok) {
            throw new Error(`Ошибка: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const userInfo = data.user_info;
        const userRoles = data.user_roles || [];
        console.log("Полученные данные от сервера:", data);

        // Заполняем модальное окно
        document.getElementById("rolesEmail").textContent = userInfo.email;
        document.getElementById("rolesСorId").textContent = userInfo.cor_id;

        const rolesList = document.getElementById("rolesList");
        rolesList.innerHTML = '';

        // Создаем элементы только для отображения ролей
        const allRoles = ['admin', 'lawyer', 'cor-int', 'active_user', 'doctor'];
        allRoles.forEach(role => {
            const isChecked = userRoles.includes(role);
            
            // Создаем контейнер для роли
            const roleContainer = document.createElement('div');
            roleContainer.className = 'role-container';
            
            // Создаем "чекбокс" (на самом деле просто картинка)
            const checkboxIcon = document.createElement('span');
            checkboxIcon.className = 'role-checkbox-icon';
            checkboxIcon.innerHTML = isChecked ? '✓' : '✗';
            checkboxIcon.style.color = isChecked ? 'green' : 'red';
            
            // Создаем название роли
            const roleName = document.createElement('span');
            roleName.className = 'role-name';
            roleName.textContent = role;
            
            // Добавляем обработчик клика по названию роли
            roleName.addEventListener('click', (e) => {
                e.preventDefault();
                showRoleInfo(role, data); // Передаем все данные пользователя
            });
            
            // Собираем все вместе
            roleContainer.appendChild(checkboxIcon);
            roleContainer.appendChild(roleName);
            rolesList.appendChild(roleContainer);
        });

        const saveButton = document.querySelector('#rolesModal .modal-footer button');
        if (saveButton) {
            saveButton.style.display = 'none';
        }

        // Открываем модальное окно
        document.getElementById("rolesModal").style.display = "block";

    } catch (error) {
        console.error('Ошибка при загрузке информации о пользователе:', error);
        alert('Произошла ошибка при загрузке информации о пользователе');
    }
}


function showRoleInfo(role, userData) {
    const roleInfoContent = document.getElementById("roleInfoContent");
    roleInfoContent.innerHTML = '';
    
    let roleDescription = '';
    
    switch(role) {
        case 'admin':
            roleDescription = `
                <h3>Администратор</h3>
                <div class="role-form">
                   
                </div>
            `;
            break;
            
        case 'lawyer':
            roleDescription = `
                <h3>Юрист</h3>
                <div class="role-form">
                 
                </div>
            `;
            break;
            
        case 'cor-int':
            roleDescription = `
                <h3>Корпоративный пользователь</h3>
                <div class="role-form">
                   
                </div>
            `;
            break;
            
        case 'active_user':
            roleDescription = `
                <h3>Активный пользователь</h3>
                <div class="role-form">
                    ${userData.profile ? `
                        <div class="form-group">
                            <label>Имя:</label>
                            <input type="text" id="firstName" value="${userData.profile.first_name || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Город:</label>
                            <input type="text" id="city" value="${userData.profile.city || ''}" class="form-control">
                        </div>
                    ` : ''}
                </div>
            `;
            break;
            
        case 'doctor':
           // Формируем данные врача или пустые значения, если их нет
        const doctorInfo = userData.doctor_info || {};
        const diplomas = doctorInfo.diplomas || [{}];
        const certificates = doctorInfo.certificates || [{}];
        const clinicAffiliations = doctorInfo.clinic_affiliations || [{}];
        
        roleDescription = `
            <h3>Врач</h3>
            
            <!-- Навигация по вкладкам -->
            <ul class="nav nav-tabs" id="doctorTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="personal-tab" data-toggle="tab" href="#personal" role="tab">Личные данные</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="diplomas-tab" data-toggle="tab" href="#diplomas" role="tab">Дипломы</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="certificates-tab" data-toggle="tab" href="#certificates" role="tab">Сертификаты</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="clinics-tab" data-toggle="tab" href="#clinics" role="tab">Клиники</a>
                </li>
            </ul>
            
            <!-- Содержимое вкладок -->
            <div class="tab-content" id="doctorTabsContent">
                <!-- Вкладка личных данных -->
                <div class="tab-pane fade show active" id="personal" role="tabpanel">
                    <div class="role-form mt-3">
                        <div class="form-group">
                            <label>Фамилия:</label>
                            <input type="text" id="surname" value="${doctorInfo.surname || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Имя:</label>
                            <input type="text" id="firstName" value="${doctorInfo.first_name || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Отчество:</label>
                            <input type="text" id="lastName" value="${doctorInfo.last_name || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Рабочий email:</label>
                            <input type="email" id="workEmail" value="${doctorInfo.work_email || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Телефон:</label>
                            <input type="tel" id="phoneNumber" value="${doctorInfo.phone_number || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Научная степень:</label>
                            <input type="text" id="scientificDegree" value="${doctorInfo.scientific_degree || ''}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Дата последней аттестации:</label>
                            <input type="date" id="lastAttestationDate" value="${doctorInfo.date_of_last_attestation || ''}" class="form-control">
                        </div>
                    </div>
                </div>
                
                <!-- Вкладка дипломов -->
                <div class="tab-pane fade" id="diplomas" role="tabpanel">
                    <div class="role-form mt-3">
                        <button id="addDiplomaBtn" class="btn btn-sm btn-secondary mb-3">+ Добавить диплом</button>
                        <div id="diplomasContainer">
                            ${diplomas.map((diploma, index) => `
                                <div class="document-form card mb-3" data-index="${index}">
                                    <div class="card-body">
                                        <h5 class="card-title">Диплом ${index + 1}</h5>
                                        <button class="btn btn-sm btn-danger float-right remove-diploma">×</button>
                                        <div class="form-group">
                                            <label>Университет:</label>
                                            <input type="text" id="diplomaUniversity${index}" value="${diploma.university || ''}" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Серия:</label>
                                            <input type="text" id="diplomaSeries${index}" value="${diploma.series || ''}" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Номер:</label>
                                            <input type="text" id="diplomaNumber${index}" value="${diploma.number || ''}" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Дата:</label>
                                            <input type="date" id="diplomaDate${index}" value="${diploma.date || ''}" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Вкладка сертификатов -->
                <div class="tab-pane fade" id="certificates" role="tabpanel">
                    <div class="role-form mt-3">
                        <button id="addCertificateBtn" class="btn btn-sm btn-secondary mb-3">+ Добавить сертификат</button>
                        <div id="certificatesContainer">
                            ${certificates.map((cert, index) => `
                                <div class="document-form card mb-3" data-index="${index}">
                                    <div class="card-body">
                                        <h5 class="card-title">Сертификат ${index + 1}</h5>
                                        <button class="btn btn-sm btn-danger float-right remove-certificate">×</button>
                                        <div class="form-group">
                                            <label>Университет:</label>
                                            <input type="text" id="certUniversity${index}" value="${cert.university || ''}" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Серия:</label>
                                            <input type="text" id="certSeries${index}" value="${cert.series || ''}" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Номер:</label>
                                            <input type="text" id="certNumber${index}" value="${cert.number || ''}" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Дата:</label>
                                            <input type="date" id="certDate${index}" value="${cert.date || ''}" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Вкладка клиник -->
                <div class="tab-pane fade" id="clinics" role="tabpanel">
                    <div class="role-form mt-3">
                        <button id="addClinicBtn" class="btn btn-sm btn-secondary mb-3">+ Добавить клинику</button>
                        <div id="clinicsContainer">
                            ${clinicAffiliations.map((clinic, index) => `
                                <div class="clinic-form card mb-3" data-index="${index}">
                                    <div class="card-body">
                                        <h5 class="card-title">Клиника ${index + 1}</h5>
                                        <button class="btn btn-sm btn-danger float-right remove-clinic">×</button>
                                        <div class="form-group">
                                            <label>Название клиники:</label>
                                            <input type="text" id="clinicName${index}" value="${clinic.clinic_name || ''}" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Отделение:</label>
                                            <input type="text" id="clinicDepartment${index}" value="${clinic.department || ''}" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Должность:</label>
                                            <input type="text" id="clinicPosition${index}" value="${clinic.position || ''}" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Специальность:</label>
                                            <input type="text" id="clinicSpecialty${index}" value="${clinic.specialty || ''}" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer mt-3">
                <button id="saveRoleBtn" class="btn btn-primary">Сохранить все данные</button>
            </div>
            
            <!-- Шаблоны для динамического добавления элементов -->
            <template id="diplomaTemplate">
                <div class="document-form card mb-3" data-index="0">
                    <div class="card-body">
                        <h5 class="card-title">Новый диплом</h5>
                        <button class="btn btn-sm btn-danger float-right remove-diploma">×</button>
                        <div class="form-group">
                            <label>Университет:</label>
                            <input type="text" class="form-control diploma-university">
                        </div>
                        <div class="form-group">
                            <label>Серия:</label>
                            <input type="text" class="form-control diploma-series">
                        </div>
                        <div class="form-group">
                            <label>Номер:</label>
                            <input type="text" class="form-control diploma-number">
                        </div>
                        <div class="form-group">
                            <label>Дата:</label>
                            <input type="date" class="form-control diploma-date">
                        </div>
                    </div>
                </div>
            </template>
            
            <template id="certificateTemplate">
                <div class="document-form card mb-3" data-index="0">
                    <div class="card-body">
                        <h5 class="card-title">Новый сертификат</h5>
                        <button class="btn btn-sm btn-danger float-right remove-certificate">×</button>
                        <div class="form-group">
                            <label>Университет:</label>
                            <input type="text" class="form-control certificate-university">
                        </div>
                        <div class="form-group">
                            <label>Серия:</label>
                            <input type="text" class="form-control certificate-series">
                        </div>
                        <div class="form-group">
                            <label>Номер:</label>
                            <input type="text" class="form-control certificate-number">
                        </div>
                        <div class="form-group">
                            <label>Дата:</label>
                            <input type="date" class="form-control certificate-date">
                        </div>
                    </div>
                </div>
            </template>
            
            <template id="clinicTemplate">
                <div class="clinic-form card mb-3" data-index="0">
                    <div class="card-body">
                        <h5 class="card-title">Новая клиника</h5>
                        <button class="btn btn-sm btn-danger float-right remove-clinic">×</button>
                        <div class="form-group">
                            <label>Название клиники:</label>
                            <input type="text" class="form-control clinic-name">
                        </div>
                        <div class="form-group">
                            <label>Отделение:</label>
                            <input type="text" class="form-control clinic-department">
                        </div>
                        <div class="form-group">
                            <label>Должность:</label>
                            <input type="text" class="form-control clinic-position">
                        </div>
                        <div class="form-group">
                            <label>Специальность:</label>
                            <input type="text" class="form-control clinic-specialty">
                        </div>
                    </div>
                </div>
            </template>
        `;
        
        roleInfoContent.innerHTML = roleDescription;
        
        // Инициализация функционала вкладок
        initDoctorTabs();
        
        // Добавляем обработчики для кнопок добавления/удаления
        document.getElementById('addDiplomaBtn')?.addEventListener('click', addNewDiploma);
        document.getElementById('addCertificateBtn')?.addEventListener('click', addNewCertificate);
        document.getElementById('addClinicBtn')?.addEventListener('click', addNewClinic);
        
        // Добавляем обработчик сохранения
        document.getElementById('saveRoleBtn').addEventListener('click', () => {
            saveDoctorData(userData.user_info.cor_id);
        });
            break;
            
        default:
            roleDescription = `<p>Информация о роли "${role}" отсутствует.</p>`;
    }
    
    roleInfoContent.innerHTML = roleDescription;
    
    // Добавляем обработчик сохранения для роли врача
    if (role === 'doctor') {
        document.getElementById('saveRoleBtn').addEventListener('click', () => {
            saveDoctorData(userData.user_info.cor_id);
        });
    }
    
    document.getElementById("roleInfoModal").style.display = "block";
}


function initDoctorTabs() {
    // Простая реализация переключения вкладок без jQuery
    const tabs = document.querySelectorAll('#doctorTabs .nav-link');
    tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Скрыть все вкладки
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });
            
            // Убрать активность у всех табов
            tabs.forEach(t => {
                t.classList.remove('active');
            });
            
            // Показать выбранную вкладку
            const target = document.querySelector(tab.getAttribute('href'));
            target.classList.add('show', 'active');
            tab.classList.add('active');
        });
    });
}

function addNewDiploma() {
    const container = document.getElementById('diplomasContainer');
    const template = document.getElementById('diplomaTemplate');
    const clone = template.content.cloneNode(true);
    const newIndex = container.children.length;
    
    clone.querySelector('.document-form').dataset.index = newIndex;
    container.appendChild(clone);
    
    // Добавляем обработчик удаления
    const removeBtn = container.lastElementChild.querySelector('.remove-diploma');
    removeBtn.addEventListener('click', () => {
        container.removeChild(container.lastElementChild);
    });
}

function addNewCertificate() {
    const container = document.getElementById('certificatesContainer');
    const template = document.getElementById('certificateTemplate');
    const clone = template.content.cloneNode(true);
    const newIndex = container.children.length;
    
    clone.querySelector('.document-form').dataset.index = newIndex;
    container.appendChild(clone);
    
    // Добавляем обработчик удаления
    const removeBtn = container.lastElementChild.querySelector('.remove-certificate');
    removeBtn.addEventListener('click', () => {
        container.removeChild(container.lastElementChild);
    });
}

function addNewClinic() {
    const container = document.getElementById('clinicsContainer');
    const template = document.getElementById('clinicTemplate');
    const clone = template.content.cloneNode(true);
    const newIndex = container.children.length;
    
    clone.querySelector('.clinic-form').dataset.index = newIndex;
    container.appendChild(clone);
    
    // Добавляем обработчик удаления
    const removeBtn = container.lastElementChild.querySelector('.remove-clinic');
    removeBtn.addEventListener('click', () => {
        container.removeChild(container.lastElementChild);
    });
}


    </script>
</body>
</html>

